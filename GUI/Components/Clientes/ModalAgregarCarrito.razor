@using ENTITY.Articulos
@using ENTITY.Pedidos
@using DAL.Interfaces
@using GUI.Services
@inject IArticuloDAO ArticuloDAO
@inject CarritoService Carrito

@if (mostrarModal)
{
    <div class="modal-overlay" @onclick="Cerrar">
        <div class="modal-content-large" @onclick:stopPropagation>
            <div class="modal-header">
                <h3>Agregar al Carrito</h3>
                <button class="btn-close" @onclick="Cerrar">✕</button>
            </div>

            <div class="modal-body-horizontal">
                @if (cargando)
                {
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Cargando variantes...</p>
                    </div>
                }
                else if (errorMessage != null)
                {
                    <div class="error-message">
                        <p>❌ @errorMessage</p>
                    </div>
                }
                else if (articuloDetalle != null)
                {
                    <div class="imagen-section">
                        <div class="imagen-principal">
                            <img src="@imagenActual" alt="@articuloDetalle.Nombre" />
                        </div>

                        @if (imagenesDisponibles.Count > 1)
                        {
                            <div class="imagenes-thumbnails">
                                @foreach (var img in imagenesDisponibles)
                                {
                                    <div class="thumbnail @(imagenActual == img ? "active" : "")"
                                         @onclick="() => CambiarImagen(img)">
                                        <img src="@img" alt="Variante" />
                                    </div>
                                }
                            </div>
                        }
                    </div>

                    <div class="info-section">
                        <div class="producto-info">
                            <h4>@articuloDetalle.Nombre</h4>
                            <p class="marca">@articuloDetalle.Marca</p>
                            <p class="precio">@articuloDetalle.PrecioBase.ToString("C")</p>

                            @if (!string.IsNullOrEmpty(articuloDetalle.Descripcion))
                            {
                                <p class="descripcion">@articuloDetalle.Descripcion</p>
                            }
                        </div>

                        <div class="form-group">
                            <label><strong>Color</strong></label>
                            <div class="colores-visuales">
                                @foreach (var color in coloresDisponibles)
                                {
                                    var imgColor = ObtenerImagenPorColor(color);
                                    <div class="color-opcion @(colorSeleccionado == color ? "active" : "")"
                                         @onclick="() => SeleccionarColor(color)"
                                         title="@color">
                                        @if (!string.IsNullOrEmpty(imgColor))
                                        {
                                            <img src="@imgColor" alt="@color" />
                                        }
                                        else
                                        {
                                            <div class="color-texto">@color.Substring(0, Math.Min(2, color.Length))</div>
                                        }
                                        <span class="color-nombre">@color</span>
                                    </div>
                                }
                            </div>
                        </div>

                        @if (!string.IsNullOrEmpty(colorSeleccionado))
                        {
                            <div class="form-group">
                                <label><strong>Talla</strong></label>
                                <div class="opciones-grid">
                                    @foreach (var talla in tallasDisponiblesPorColor)
                                    {
                                        <button class="opcion-btn @(tallaSeleccionada == talla ? "active" : "")"
                                                @onclick="() => SeleccionarTalla(talla)">
                                            @talla
                                        </button>
                                    }
                                </div>
                            </div>
                        }

                        @if (varianteSeleccionada != null)
                        {
                            <div class="stock-info">
                                <p>
                                    <strong>Stock disponible:</strong>
                                    <span class="stock-number">@varianteSeleccionada.Stock unidades</span>
                                </p>
                                <p class="sku">SKU: @varianteSeleccionada.CodigoSKU</p>
                            </div>

                            <div class="form-group">
                                <label><strong>Cantidad</strong></label>
                                <div class="cantidad-controls">
                                    <button class="btn-cantidad" @onclick="DisminuirCantidad" disabled="@(cantidad <= 1)">−</button>
                                    <input type="number"
                                           class="cantidad-input"
                                           @bind="cantidad"
                                           min="1"
                                           max="@varianteSeleccionada.Stock" />
                                    <button class="btn-cantidad" @onclick="AumentarCantidad" disabled="@(cantidad >= varianteSeleccionada.Stock)">+</button>
                                </div>
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(mensajeError))
                        {
                            <div class="error-message">
                                <p> @mensajeError</p>
                            </div>
                        }

                        @if (mostrarExito)
                        {
                            <div class="success-message">
                                <p>✓ Producto agregado al carrito</p>
                            </div>
                        }

                        <div class="modal-footer-inline">
                            <button class="btn-secondary" @onclick="Cerrar">
                                Cancelar
                            </button>
                            <button class="btn-primary"
                                    @onclick="AgregarAlCarrito"
                                    disabled="@(varianteSeleccionada == null || agregando)">
                                @if (agregando)
                                {
                                    <span>Agregando...</span>
                                }
                                else
                                {
                                    <span>Agregar al Carrito</span>
                                }
                            </button>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int IdArticulo { get; set; }
    [Parameter] public bool mostrarModal { get; set; }
    [Parameter] public EventCallback OnCerrar { get; set; }

    private ArticuloDetalleDTO? articuloDetalle;
    private bool cargando = false;
    private string? errorMessage;
    private string? mensajeError;
    private bool mostrarExito = false;
    private bool agregando = false;

    private List<string> coloresDisponibles = new();
    private List<string> tallasDisponiblesPorColor = new();
    private string? tallaSeleccionada;
    private string? colorSeleccionado;
    private VarianteDetalleDTO? varianteSeleccionada;
    private int cantidad = 1;

    private List<string> imagenesDisponibles = new();
    private string imagenActual = "";

    protected override async Task OnParametersSetAsync()
    {
        if (mostrarModal && IdArticulo > 0 && articuloDetalle == null)
        {
            await CargarArticulo();
        }
    }

    private async Task CargarArticulo()
    {
        try
        {
            cargando = true;
            errorMessage = null;

            var response = await ArticuloDAO.ObtenerArticuloPorId(IdArticulo);

            if (response.IsSuccess && response.Object != null)
            {
                articuloDetalle = response.Object;

                coloresDisponibles = articuloDetalle.Variantes
                    .Where(v => v.Estado == "A" && v.Stock > 0)
                    .Select(v => v.Color)
                    .Distinct()
                    .OrderBy(c => c)
                    .ToList();

                imagenesDisponibles = articuloDetalle.Imagenes
                    .Select(i => i.Url)
                    .ToList();

                if (imagenesDisponibles.Any())
                {
                    imagenActual = imagenesDisponibles.First();
                }
            }
            else
            {
                errorMessage = response.Message ?? "Error al cargar el artículo";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            cargando = false;
        }
    }

    private void SeleccionarColor(string color)
    {
        colorSeleccionado = color;
        tallaSeleccionada = null;
        varianteSeleccionada = null;
        mensajeError = null;

        if (articuloDetalle != null)
        {
            tallasDisponiblesPorColor = articuloDetalle.Variantes
                .Where(v => v.Color == color && v.Estado == "A" && v.Stock > 0)
                .Select(v => v.Talla)
                .Distinct()
                .OrderBy(t => t)
                .ToList();

            var imagenColor = ObtenerImagenPorColor(color);
            if (!string.IsNullOrEmpty(imagenColor))
            {
                imagenActual = imagenColor;
            }
        }
    }

    private void SeleccionarTalla(string talla)
    {
        tallaSeleccionada = talla;
        mensajeError = null;

        if (articuloDetalle != null && !string.IsNullOrEmpty(colorSeleccionado))
        {
            varianteSeleccionada = articuloDetalle.Variantes
                .FirstOrDefault(v => v.Talla == talla
                                  && v.Color == colorSeleccionado
                                  && v.Estado == "A"
                                  && v.Stock > 0);

            if (varianteSeleccionada != null)
            {
                if (cantidad > varianteSeleccionada.Stock)
                {
                    cantidad = varianteSeleccionada.Stock;
                }
            }
        }
    }

    private string? ObtenerImagenPorColor(string color)
    {
        // Intentar encontrar una imagen que contenga el color en su nombre o tags
        // Si tienes una relación directa en tu BD entre variante e imagen, úsala aquí
        if (articuloDetalle == null) return null;

        var colorIndex = coloresDisponibles.IndexOf(color);
        if (colorIndex >= 0 && colorIndex < imagenesDisponibles.Count)
        {
            return imagenesDisponibles[colorIndex];
        }

        return imagenesDisponibles.FirstOrDefault();
    }

    private void CambiarImagen(string url)
    {
        imagenActual = url;
    }

    private void AumentarCantidad()
    {
        if (varianteSeleccionada != null && cantidad < varianteSeleccionada.Stock)
        {
            cantidad++;
        }
    }

    private void DisminuirCantidad()
    {
        if (cantidad > 1)
        {
            cantidad--;
        }
    }

    private void AgregarAlCarrito()
    {
        if (articuloDetalle == null || varianteSeleccionada == null)
        {
            mensajeError = "Selecciona un color y una talla";
            return;
        }

        if (cantidad <= 0 || cantidad > varianteSeleccionada.Stock)
        {
            mensajeError = "Cantidad inválida";
            return;
        }

        try
        {
            agregando = true;
            mensajeError = null;

            var item = new CarritoItemDTO
            {
                IdVariante = varianteSeleccionada.IdVariante,
                IdArticulo = articuloDetalle.IdArticulo,
                NombreArticulo = articuloDetalle.Nombre,
                Marca = articuloDetalle.Marca,
                Talla = varianteSeleccionada.Talla,
                Color = varianteSeleccionada.Color,
                CodigoSKU = varianteSeleccionada.CodigoSKU,
                PrecioUnitario = articuloDetalle.PrecioBase,
                Cantidad = cantidad,
                StockDisponible = varianteSeleccionada.Stock,
                ImagenUrl = imagenActual
            };

            Carrito.AgregarItem(item);
            mostrarExito = true;

            Task.Delay(1000).ContinueWith(_ =>
            {
                InvokeAsync(async () =>
                {
                    await Cerrar();
                });
            });
        }
        catch (Exception ex)
        {
            mensajeError = $"Error al agregar: {ex.Message}";
        }
        finally
        {
            agregando = false;
        }
    }

    private async Task Cerrar()
    {
        mostrarModal = false;
        articuloDetalle = null;
        tallaSeleccionada = null;
        colorSeleccionado = null;
        varianteSeleccionada = null;
        cantidad = 1;
        mensajeError = null;
        mostrarExito = false;
        imagenesDisponibles.Clear();
        imagenActual = "";
        await OnCerrar.InvokeAsync();
    }
}
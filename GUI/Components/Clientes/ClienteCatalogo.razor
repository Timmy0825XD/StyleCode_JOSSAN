@page "/ClienteCatalogo"
@using GUI.Components.Layout
@using DAL.Interfaces
@using ENTITY.Articulos
@using ENTITY.Utilidades
@using ENTITY.Pedidos
@using GUI.Services
@using GUI.Components.Clientes
@inject CarritoService Carrito
@inject IArticuloDAO ArticuloDAO
@inject NavigationManager Navigation
@layout ClienteLayout
@implements IDisposable

<section class="catalogo">
    @if (isLoading)
    {
        <div class="loading-container">
            <div class="spinner"></div>
            <p>Cargando productos...</p>
        </div>
    }
    else if (errorMessage != null)
    {
        <div class="error-container">
            <p> @errorMessage</p>
            <button class="btn" @onclick="LoadProducts">Reintentar</button>
        </div>
    }
    else
    {

        <div class="toolbar">
            <div class="search">
                <input class="input" type="text" placeholder="Buscar productos..."
                       @bind="searchText" @bind:event="oninput" />
            </div>

            <div class="filters">
                <select class="select" @bind="selectedCategoriaTipo">
                    <option value="">Todos los tipos</option>
                    @foreach (var tipo in categoriasTipo)
                    {
                        <option value="@tipo">@tipo</option>
                    }
                </select>

                <select class="select" @bind="selectedCategoriaOcasion">
                    <option value="">Todas las ocasiones</option>
                    @foreach (var ocasion in categoriasOcasion)
                    {
                        <option value="@ocasion">@ocasion</option>
                    }
                </select>

                <select class="select" @bind="selectedGenero">
                    <option value="">Todos los géneros</option>
                    @foreach (var genero in generos)
                    {
                        <option value="@genero">@genero</option>
                    }
                </select>

                <select class="select" @bind="selectedMarca">
                    <option value="">Todas las marcas</option>
                    @foreach (var marca in marcas)
                    {
                        <option value="@marca">@marca</option>
                    }
                </select>

                <div class="price">
                    <label>Precio máx: <strong>@maxPriceFilter.ToString("C0")</strong></label>
                    <input type="range" min="@minPrice" max="@maxPrice" step="1000"
                           @bind="maxPriceFilter" @bind:event="oninput" />
                </div>

                <select class="select" @bind="sortBy">
                    <option value="relevancia">Ordenar: Relevancia</option>
                    <option value="precio_asc">Precio ↑</option>
                    <option value="precio_desc">Precio ↓</option>
                    <option value="nombre_asc">Nombre A–Z</option>
                    <option value="nombre_desc">Nombre Z–A</option>
                    <option value="nuevos">Más recientes</option>
                </select>
            </div>
        </div>

        <div class="chips">
            <button class="chip @(string.IsNullOrEmpty(selectedCategoriaTipo) ? "active" : "")"
                    @onclick="() => SetCategoriaTipo(string.Empty)">
                Todos
            </button>
            @foreach (var tipo in categoriasTipo.Take(5))
            {
                <button class="chip @(selectedCategoriaTipo == tipo ? "active" : "")"
                        @onclick="() => SetCategoriaTipo(tipo)">
                    @tipo
                </button>
            }
        </div>

        <div class="results-info">
            <p>Mostrando @PagedProducts.Count() de @FilteredProducts.Count() productos</p>
        </div>

        @if (PagedProducts.Any())
        {
            <div class="grid">
                @foreach (var articulo in PagedProducts)
                {
                    <div class="card" @onclick="() => ViewDetails(articulo)">
                        <div class="img-wrap">
                            <img src="@GetImageUrl(articulo)" alt="@articulo.Nombre" loading="lazy" />

                            <button class="fav @(favorites.Contains(articulo.IdArticulo) ? "on" : "")"
                                    title="Favorito"
                                    @onclick="(e) => ToggleFavorite(articulo.IdArticulo, e)"
                                    @onclick:stopPropagation="true">
                                ♥
                            </button>

                            @if (IsNewProduct(articulo))
                            {
                                <span class="badge new">Nuevo</span>
                            }

                            @if (articulo.TotalVariantes > 0)
                            {
                                <span class="badge variants">@articulo.TotalVariantes variantes</span>
                            }
                        </div>

                        <div class="info">
                            <h3>@articulo.Nombre</h3>
                            <p class="brand">@articulo.Marca</p>
                            <div class="tags">
                                <span class="tag">@articulo.CategoriaTipo</span>
                                <span class="tag">@articulo.Genero</span>
                            </div>
                            <p class="price">Desde @articulo.PrecioBase.ToString("C")</p>
                            @if (!string.IsNullOrEmpty(articulo.Material))
                            {
                                <p class="material">Material: @articulo.Material</p>
                            }
                        </div>

                        <div class="actions">
                            <button class="btn"
                                    @onclick="(e) => AbrirModalAgregar(articulo.IdArticulo, e)"
                                    @onclick:stopPropagation="true">
                                🛒 Agregar al Carrito
                            </button>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="no-results">
                <p>😔 No se encontraron productos con los filtros seleccionados.</p>
                <button class="btn" @onclick="ClearFilters">Limpiar filtros</button>
            </div>
        }

        @if (TotalPages > 1)
        {
            <div class="pagination">
                <button class="pg-btn" disabled="@(currentPage == 1)" @onclick="PrevPage">«</button>
                <span>Página @currentPage de @TotalPages</span>
                <button class="pg-btn" disabled="@(currentPage == TotalPages)" @onclick="NextPage">»</button>
            </div>
        }
    }
</section>


<ModalAgregarCarrito IdArticulo="idArticuloSeleccionado" mostrarModal="mostrarModalAgregar" OnCerrar="CerrarModalAgregar" />

@code {

    private List<ArticuloListaDTO> allProducts = new();
    private HashSet<int> favorites = new();
    private bool isLoading = true;
    private string? errorMessage = null;

    private string searchText = "";
    private string selectedCategoriaTipo = "";
    private string selectedCategoriaOcasion = "";
    private string selectedGenero = "";
    private string selectedMarca = "";
    private string sortBy = "relevancia";
    private decimal minPrice = 0;
    private decimal maxPrice = 5000000;
    private decimal maxPriceFilter = 5000000;
    private int pageSize = 12;
    private int currentPage = 1;
    private List<string> categoriasTipo = new();
    private List<string> categoriasOcasion = new();
    private List<string> generos = new();
    private List<string> marcas = new();

    private int cantidadCarrito = 0;
    private bool mostrarModalAgregar = false;
    private int idArticuloSeleccionado = 0;

    protected override async Task OnInitializedAsync()
    {
        Carrito.OnChange += ActualizarContadorCarrito;
        ActualizarContadorCarrito();

        await LoadProducts();
    }

    private async Task LoadProducts()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            var response = await ArticuloDAO.ObtenerArticulosActivos();

            if (response.IsSuccess && response.ListObject != null)
            {
                allProducts = response.ListObject.ToList();

                if (allProducts.Any())
                {
                    categoriasTipo = allProducts.Select(p => p.CategoriaTipo).Distinct().OrderBy(c => c).ToList();
                    categoriasOcasion = allProducts.Select(p => p.CategoriaOcasion).Distinct().OrderBy(c => c).ToList();
                    generos = allProducts.Select(p => p.Genero).Distinct().OrderBy(g => g).ToList();
                    marcas = allProducts.Select(p => p.Marca).Distinct().OrderBy(m => m).ToList();

                    minPrice = allProducts.Min(p => p.PrecioBase);
                    maxPrice = allProducts.Max(p => p.PrecioBase);
                    maxPriceFilter = maxPrice;
                }
                else
                {
                    errorMessage = "No hay productos disponibles en este momento.";
                }
            }
            else
            {
                errorMessage = response.Message ?? "Error al cargar los productos.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error inesperado: {ex.Message}";
            Console.WriteLine($"Error en LoadProducts: {ex}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private IEnumerable<ArticuloListaDTO> FilteredProducts => ApplySort(
        allProducts
            .Where(p => string.IsNullOrWhiteSpace(searchText)
                        || p.Nombre.Contains(searchText, StringComparison.OrdinalIgnoreCase)
                        || p.Descripcion?.Contains(searchText, StringComparison.OrdinalIgnoreCase) == true
                        || p.Marca.Contains(searchText, StringComparison.OrdinalIgnoreCase))
            .Where(p => string.IsNullOrWhiteSpace(selectedCategoriaTipo)
                        || p.CategoriaTipo.Equals(selectedCategoriaTipo, StringComparison.OrdinalIgnoreCase))
            .Where(p => string.IsNullOrWhiteSpace(selectedCategoriaOcasion)
                        || p.CategoriaOcasion.Equals(selectedCategoriaOcasion, StringComparison.OrdinalIgnoreCase))
            .Where(p => string.IsNullOrWhiteSpace(selectedGenero)
                        || p.Genero.Equals(selectedGenero, StringComparison.OrdinalIgnoreCase))
            .Where(p => string.IsNullOrWhiteSpace(selectedMarca)
                        || p.Marca.Equals(selectedMarca, StringComparison.OrdinalIgnoreCase))
            .Where(p => p.PrecioBase <= maxPriceFilter)
    );

    private IEnumerable<ArticuloListaDTO> ApplySort(IEnumerable<ArticuloListaDTO> seq) =>
        sortBy switch
        {
            "precio_asc" => seq.OrderBy(p => p.PrecioBase),
            "precio_desc" => seq.OrderByDescending(p => p.PrecioBase),
            "nombre_asc" => seq.OrderBy(p => p.Nombre),
            "nombre_desc" => seq.OrderByDescending(p => p.Nombre),
            "nuevos" => seq.OrderByDescending(p => p.FechaCreacion),
            _ => seq
        };

    private int TotalPages => Math.Max(1, (int)Math.Ceiling(FilteredProducts.Count() / (double)pageSize));

    private IEnumerable<ArticuloListaDTO> PagedProducts
    {
        get
        {
            if (currentPage > TotalPages) currentPage = 1;
            return FilteredProducts
                .Skip((currentPage - 1) * pageSize)
                .Take(pageSize);
        }
    }

    private string GetImageUrl(ArticuloListaDTO articulo)
    {
        if (!string.IsNullOrEmpty(articulo.ImagenPrincipal))
        {
            return articulo.ImagenPrincipal;
        }
        return $"https://images.unsplash.com/photo-1523381210434-271e8be1f52b?w=600&h=800&fit=crop&q=80";
    }

    private bool IsNewProduct(ArticuloListaDTO articulo)
    {
        return articulo.FechaCreacion >= DateTime.Now.AddDays(-1);
    }

    private void SetCategoriaTipo(string tipo)
    {
        selectedCategoriaTipo = tipo;
        currentPage = 1;
    }

    private void ClearFilters()
    {
        searchText = "";
        selectedCategoriaTipo = "";
        selectedCategoriaOcasion = "";
        selectedGenero = "";
        selectedMarca = "";
        maxPriceFilter = maxPrice;
        sortBy = "relevancia";
        currentPage = 1;
    }

    private void PrevPage()
    {
        if (currentPage > 1) currentPage--;
    }

    private void NextPage()
    {
        if (currentPage < TotalPages) currentPage++;
    }

    private void ToggleFavorite(int productId, MouseEventArgs e)
    {
        if (!favorites.Add(productId))
            favorites.Remove(productId);
    }

    private void ViewDetails(ArticuloListaDTO articulo, MouseEventArgs? e = null)
    {
        Navigation.NavigateTo($"/cliente/producto/{articulo.IdArticulo}");
    }

    private void ActualizarContadorCarrito()
    {
        cantidadCarrito = Carrito.ObtenerCantidadTotal();
        StateHasChanged();
    }

    private void AbrirModalAgregar(int idArticulo, MouseEventArgs e)
    {
        idArticuloSeleccionado = idArticulo;
        mostrarModalAgregar = true;
    }

    private void CerrarModalAgregar()
    {
        mostrarModalAgregar = false;
        idArticuloSeleccionado = 0;
        StateHasChanged();
    }

    private void IrAlCarrito()
    {
        Navigation.NavigateTo("/carrito");
    }

    public void Dispose()
    {
        Carrito.OnChange -= ActualizarContadorCarrito;
    }
}

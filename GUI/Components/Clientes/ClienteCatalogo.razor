@page "/"
@page "/ClienteCatalogo"
@using GUI.Components.Layout
@using DAL.Interfaces
@using BLL.Interfaces
@using ENTITY.Articulos
@using ENTITY.Utilidades
@using ENTITY.Pedidos
@using GUI.Services
@using GUI.Components.Clientes
@inject CarritoService Carrito
@inject IArticuloDAO ArticuloDAO
@inject IFavoritoService FavoritoService
@inject SesionService SesionService
@inject NavigationManager Navigation
@layout ClienteLayout
@implements IDisposable

<section class="catalogo">

    @if (errorMessage != null)
    {
        <div class="error-container">
            <p>@errorMessage</p>
            <button class="btn" @onclick="LoadProducts">Reintentar</button>
        </div>
    }
    else
    {
        <div class="hero-carousel">
            <div class="carousel-container">
                <div class="carousel-slide @(currentSlide == 0 ? "active" : "")">
                    <div class="slide-content">
                        <div class="slide-text">
                            <span class="slide-badge">Nueva Colección</span>
                            <h1 class="slide-title">Descubre Tu Estilo</h1>
                            <p class="slide-description">Las mejores marcas y tendencias en un solo lugar</p>
                            <a href="#products-section"><button class="btn-hero">Explorar Ahora →</Button></a>
                        </div>
                        <div class="slide-image">
                            <img src="https://images.unsplash.com/photo-1523275335684-37898b6baf30?w=800&h=600&fit=crop" alt="Productos" />
                        </div>
                    </div>
                </div>
                <div class="carousel-slide @(currentSlide == 1 ? "active" : "")">
                    <div class="slide-content">
                        <div class="slide-text">
                            <span class="slide-badge">Ofertas Especiales</span>
                            <h1 class="slide-title">Hasta 50% OFF</h1>
                            <p class="slide-description">En productos seleccionados por tiempo limitado</p>
                            <a href="#products-section"><button class="btn-hero">Ver Ofertas →</button></a>
                        </div>
                        <div class="slide-image">
                            <img src="https://images.unsplash.com/photo-1441986300917-64674bd600d8?w=800&h=600&fit=crop" alt="Ofertas" />
                        </div>
                    </div>
                </div>
                <div class="carousel-slide @(currentSlide == 2 ? "active" : "")">
                    <div class="slide-content">
                        <div class="slide-text">
                            <span class="slide-badge">Envío Gratis</span>
                            <h1 class="slide-title">Compra Sin Límites</h1>
                            <p class="slide-description">Envío gratuito a toda Colombia en todos tus pedidos</p>
                            <a href="#products-section"><button class="btn-hero">Comprar Ahora →</button></a>
                        </div>
                        <div class="slide-image">
                            <img src="https://images.unsplash.com/photo-1445205170230-053b83016050?w=800&h=600&fit=crop" alt="Envíos" />
                        </div>
                    </div>
                </div>
            </div>
            <div class="carousel-controls">
                <div class="carousel-indicators">
                    @for (int i = 0; i < 3; i++)
                    {
                        var index = i;
                        <button class="indicator @(currentSlide == index ? "active" : "")"
                                @onclick="() => currentSlide = index"></button>
                    }
                </div>
            </div>
        </div>


        <div class="features-section">
            <div class="feature-card">
                <span class="feature-icon"><Icon Name="IconName.Truck"/></span>
                <h3>Envío Gratis</h3>
                <p>A toda Colombia</p>
            </div>
            <div class="feature-card">
                <span class="feature-icon"><Icon Name="IconName.Lock" /></span>
                <h3>Pago Seguro</h3>
                <p>100% Protegido</p>
            </div>
            <div class="feature-card">
                <span class="feature-icon"><Icon Name="IconName.Undo" /></span>
                <h3>Devoluciones</h3>
                <p>30 días garantía</p>
            </div>
            <div class="feature-card">
                <span class="feature-icon"><Icon Name="IconName.Moon" /></span>
                <h3>Soporte 24/7</h3>
                <p>Siempre disponibles</p>
            </div>
        </div>



        <div class="discount-banner">
            <div class="banner-content">
                <span class="banner-icon"><Icon Name="IconName.Gift" /></span>
                <div class="banner-text">
                    <h3>¡Querido Cliente!</h3>
                    <p>Aprovecha nuestras ofertas exclusivas y los mejores precios en una gran variedad de productos.</p>
                </div>
                <a href="#products-section"><button class="btn-banner">Ver Productos</button></a>
            </div>
        </div>



        <div class="toolbar" id="products-section">
            <input class="input mb-3" type="text" placeholder="Buscar productos, marcas..."
                   @bind="searchText" @bind:event="oninput" />

            <div class="filters">
                <select class="select" @bind="selectedCategoriaTipo">
                    <option value="">Todos los tipos</option>
                    @foreach (var tipo in categoriasTipo)
                    {
                        <option value="@tipo">@tipo</option>
                    }
                </select>

                <select class="select" @bind="selectedCategoriaOcasion">
                    <option value="">Todas las ocasiones</option>
                    @foreach (var ocasion in categoriasOcasion)
                    {
                        <option value="@ocasion">@ocasion</option>
                    }
                </select>

                <select class="select" @bind="selectedGenero">
                    <option value="">Todos los géneros</option>
                    @foreach (var genero in generos)
                    {
                        <option value="@genero">@genero</option>
                    }
                </select>

                <select class="select" @bind="selectedMarca">
                    <option value="">Todas las marcas</option>
                    @foreach (var marca in marcas)
                    {
                        <option value="@marca">@marca</option>
                    }
                </select>

                <div class="price-filter">
                    <label><Icon Name="IconName.DollarSign" /> Precio máx: <strong>@maxPriceFilter.ToString("C0")</strong></label>
                    <input type="range" min="@minPrice" max="@maxPrice" step="1000"
                           @bind="maxPriceFilter" @bind:event="oninput" class="price-slider" />
                </div>

                <select class="select" @bind="sortBy">
                    <option value="relevancia">Relevancia</option>
                    <option value="precio_asc">Precio: Menor a Mayor</option>
                    <option value="precio_desc">Precio: Mayor a Menor</option>
                    <option value="nombre_asc">Nombre: A-Z</option>
                    <option value="nombre_desc"> Nombre: Z-A</option>
                    <option value="nuevos">Más Recientes</option>
                </select>
            </div>
        </div>


        <div class="chips">
            <button class="chip @(string.IsNullOrEmpty(selectedCategoriaTipo) ? "active" : "")"
                    @onclick="() => SetCategoriaTipo(string.Empty)">
                <Icon Name="IconName.Star" /> Todos
            </button>
            @foreach (var tipo in categoriasTipo.Take(6))
            {
                <button class="chip @(selectedCategoriaTipo == tipo ? "active" : "")"
                        @onclick="() => SetCategoriaTipo(tipo)">
                    @tipo
                </button>
            }

        </div>


        <div class="results-info">
            <p>
                <strong>@FilteredProducts.Count()</strong> productos encontrados
                @if (selectedCategoriaTipo != "" || selectedMarca != "" || searchText != "")
                {
                    <span class="results-filtered">· Filtrado activo</span>
                }
            </p>
        </div>


        @if (PagedProducts.Any())
        {
            <div class="grid">
                @foreach (var articulo in PagedProducts)
                {
                    <div class="card">
                        <div class="img-wrap">
                            <img src="@GetImageUrl(articulo)" alt="@articulo.Nombre" loading="lazy" />

                            <button class="fav @(EsFavorito(articulo.IdArticulo) ? "on" : "")"
                                    title="@(EsFavorito(articulo.IdArticulo) ? "Quitar de favoritos" : "Agregar a favoritos")"
                                    @onclick="(e) => ToggleFavorite(articulo.IdArticulo, e)"
                                    @onclick:stopPropagation="true">
                                <Icon Name="IconName.Heart" />
                            </button>

                            @if (articulo.TotalVariantes > 0)
                            {
                                <span class="badge variants">@articulo.TotalVariantes variantes</span>
                            }
                        </div>

                        <div class="info">
                            <p class="brand">@articulo.Marca</p>
                            <h3>@articulo.Nombre</h3>
                            <div class="tags">
                                <span class="tag">@articulo.CategoriaTipo</span>
                                <span class="tag">@articulo.Genero</span>
                            </div>
                            <div class="price-section">
                                <p class="price">@articulo.PrecioBase.ToString("C")</p>
                            </div>
                            @if (!string.IsNullOrEmpty(articulo.Material))
                            {
                                <p class="material">@articulo.Material</p>
                            }
                        </div>

                        <div class="actions">
                            <button class="btn-add-cart"
                                    @onclick="(e) => AbrirModalAgregar(articulo.IdArticulo, e)"
                                    @onclick:stopPropagation="true">
                                <span class="btn-icon"><Icon Name="IconName.ShoppingCart" /></span>
                                <span class="btn-text">Agregar al Carrito</span>
                            </button>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="no-results">
                <div class="no-results-icon"></div>
                <h3>No encontramos productos</h3>
                <p>Intenta ajustar los filtros o buscar algo diferente</p>
                <button class="btn-primary" @onclick="ClearFilters">Limpiar Filtros</button>
            </div>
        }
    }
</section>

<ModalAgregarCarrito IdArticulo="idArticuloSeleccionado" mostrarModal="mostrarModalAgregar" OnCerrar="CerrarModalAgregar" />

<style>
    .fav {
        position: absolute;
        top: 12px;
        right: 12px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: none;
        background: white;
        color: #9ca3af;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        z-index: 10;
    }

    .fav:hover {
        transform: scale(1.1);
    }

    .fav.on {
        background: #ef4444;
        color: white;
        animation: heartbeat 0.5s ease;
    }

    @@keyframes heartbeat {
        0%, 100% { transform: scale(1); }
        25% { transform: scale(1.2); }
        50% { transform: scale(1.1); }
    }
</style>

@code {
    private List<ArticuloListaDTO> allProducts = new();
    private HashSet<int> favorites = new();
    private bool isLoading = true;
    private string? errorMessage = null;
    private int? idUsuarioActual = null;
    private bool estaLogueado = false;

    private string searchText = "";
    private string selectedCategoriaTipo = "";
    private string selectedCategoriaOcasion = "";
    private string selectedGenero = "";
    private string selectedMarca = "";
    private string sortBy = "relevancia";
    private decimal minPrice = 0;
    private decimal maxPrice = 5000000;
    private decimal maxPriceFilter = 5000000;
    private int pageSize = 12;
    private int currentPage = 1;
    private int currentSlide = 0;
    private List<string> categoriasTipo = new();
    private List<string> categoriasOcasion = new();
    private List<string> generos = new();
    private List<string> marcas = new();

    private int cantidadCarrito = 0;
    private bool mostrarModalAgregar = false;
    private int idArticuloSeleccionado = 0;
    private System.Threading.Timer? carouselTimer;

    protected override async Task OnInitializedAsync()
    {
        Carrito.OnChange += ActualizarContadorCarrito;
        ActualizarContadorCarrito();

        estaLogueado = await SesionService.EstaLogueado();
        idUsuarioActual = await SesionService.ObtenerIdUsuario();

        await LoadProducts();
        
        if (estaLogueado && idUsuarioActual.HasValue)
        {
            await CargarFavoritos();
        }

        carouselTimer = new System.Threading.Timer(_ =>
        {
            InvokeAsync(() =>
            {
                NextSlide();
                StateHasChanged();
            });
        }, null, 5000, 5000);
    }

    private async Task LoadProducts()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            var response = await ArticuloDAO.ObtenerArticulosActivos();

            if (response.IsSuccess && response.ListObject != null)
            {
                allProducts = response.ListObject.ToList();

                if (allProducts.Any())
                {
                    categoriasTipo = allProducts.Select(p => p.CategoriaTipo).Distinct().OrderBy(c => c).ToList();
                    categoriasOcasion = allProducts.Select(p => p.CategoriaOcasion).Distinct().OrderBy(c => c).ToList();
                    generos = allProducts.Select(p => p.Genero).Distinct().OrderBy(g => g).ToList();
                    marcas = allProducts.Select(p => p.Marca).Distinct().OrderBy(m => m).ToList();

                    minPrice = allProducts.Min(p => p.PrecioBase);
                    maxPrice = allProducts.Max(p => p.PrecioBase);
                    maxPriceFilter = maxPrice;
                }
                else
                {
                    errorMessage = "No hay productos disponibles en este momento.";
                }
            }
            else
            {
                errorMessage = response.Message ?? "Error al cargar los productos.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error inesperado: {ex.Message}";
            Console.WriteLine($"Error en LoadProducts: {ex}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task CargarFavoritos()
    {
        if (!idUsuarioActual.HasValue) return;

        try
        {
            var response = await FavoritoService.ObtenerFavoritosUsuario(idUsuarioActual.Value);
            
            if (response.IsSuccess && response.ListObject != null)
            {
                favorites = response.ListObject.Select(f => f.IdArticulo).ToHashSet();
                Console.WriteLine($"Favoritos cargados en catálogo: {favorites.Count}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar favoritos: {ex.Message}");
        }
    }

    private bool EsFavorito(int idArticulo)
    {
        return favorites.Contains(idArticulo);
    }

    private async Task ToggleFavorite(int idArticulo, MouseEventArgs e)
    {
        if (!estaLogueado || !idUsuarioActual.HasValue)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        try
        {
            var response = await FavoritoService.ToggleFavorito(idUsuarioActual.Value, idArticulo);

            if (response.IsSuccess && response.Object != null)
            {
                if (response.Object.Agregado == 1)
                {
                    favorites.Add(idArticulo);
                }
                else
                {
                    favorites.Remove(idArticulo);
                }

                StateHasChanged();
            }
            else
            {
                Console.WriteLine($" Error: {response.Message}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Excepción: {ex.Message}");
        }
    }

    private IEnumerable<ArticuloListaDTO> FilteredProducts => ApplySort(
        allProducts
            .Where(p => string.IsNullOrWhiteSpace(searchText)
                        || p.Nombre.Contains(searchText, StringComparison.OrdinalIgnoreCase)
                        || p.Descripcion?.Contains(searchText, StringComparison.OrdinalIgnoreCase) == true
                        || p.Marca.Contains(searchText, StringComparison.OrdinalIgnoreCase))
            .Where(p => string.IsNullOrWhiteSpace(selectedCategoriaTipo)
                        || p.CategoriaTipo.Equals(selectedCategoriaTipo, StringComparison.OrdinalIgnoreCase))
            .Where(p => string.IsNullOrWhiteSpace(selectedCategoriaOcasion)
                        || p.CategoriaOcasion.Equals(selectedCategoriaOcasion, StringComparison.OrdinalIgnoreCase))
            .Where(p => string.IsNullOrWhiteSpace(selectedGenero)
                        || p.Genero.Equals(selectedGenero, StringComparison.OrdinalIgnoreCase))
            .Where(p => string.IsNullOrWhiteSpace(selectedMarca)
                        || p.Marca.Equals(selectedMarca, StringComparison.OrdinalIgnoreCase))
            .Where(p => p.PrecioBase <= maxPriceFilter)
    );

    private IEnumerable<ArticuloListaDTO> ApplySort(IEnumerable<ArticuloListaDTO> seq) =>
        sortBy switch
        {
            "precio_asc" => seq.OrderBy(p => p.PrecioBase),
            "precio_desc" => seq.OrderByDescending(p => p.PrecioBase),
            "nombre_asc" => seq.OrderBy(p => p.Nombre),
            "nombre_desc" => seq.OrderByDescending(p => p.Nombre),
            "nuevos" => seq.OrderByDescending(p => p.FechaCreacion),
            _ => seq
        };

    private int TotalPages => Math.Max(1, (int)Math.Ceiling(FilteredProducts.Count() / (double)pageSize));

    private IEnumerable<ArticuloListaDTO> PagedProducts
    {
        get
        {
            if (currentPage > TotalPages) currentPage = 1;
            return FilteredProducts
                .Skip((currentPage - 1) * pageSize)
                .Take(pageSize);
        }
    }

    private string GetImageUrl(ArticuloListaDTO articulo)
    {
        if (!string.IsNullOrEmpty(articulo.ImagenPrincipal))
        {
            return articulo.ImagenPrincipal;
        }
        return $"https://images.unsplash.com/photo-1523381210434-271e8be1f52b?w=600&h=800&fit=crop&q=80";
    }

    private void SetCategoriaTipo(string tipo)
    {
        selectedCategoriaTipo = tipo;
        currentPage = 1;
    }

    private void ClearFilters()
    {
        searchText = "";
        selectedCategoriaTipo = "";
        selectedCategoriaOcasion = "";
        selectedGenero = "";
        selectedMarca = "";
        maxPriceFilter = maxPrice;
        sortBy = "relevancia";
        currentPage = 1;
    }

    private void PrevPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
        }
    }

    private void NextPage()
    {
        if (currentPage < TotalPages)
        {
            currentPage++;
        }
    }

    private void NextSlide()
    {
        currentSlide = (currentSlide + 1) % 3;
    }

    private void ActualizarContadorCarrito()
    {
        cantidadCarrito = Carrito.ObtenerCantidadTotal();
        StateHasChanged();
    }

    private void AbrirModalAgregar(int idArticulo, MouseEventArgs e)
    {
        idArticuloSeleccionado = idArticulo;
        mostrarModalAgregar = true;
    }

    private void CerrarModalAgregar()
    {
        mostrarModalAgregar = false;
        idArticuloSeleccionado = 0;
        StateHasChanged();
    }

    public void Dispose()
    {
        Carrito.OnChange -= ActualizarContadorCarrito;
        carouselTimer?.Dispose();
    }
}

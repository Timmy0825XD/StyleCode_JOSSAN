@page "/pedido-confirmado/{IdPedido:int}"
@using ENTITY.Pedidos
@using BLL.Interfaces
@using GUI.Components.Layout
@layout ClienteLayout
@inject IPedidoService PedidoService
@inject NavigationManager Navigation

<div class="confirmacion-wrapper">

    @if (errorMessage != null)
    {
        <div class="error-state">
            <h2>¡Algo salió mal!</h2>
            <p class="error-message">@errorMessage</p>
            <button class="btn-action btn-primary" @onclick="VolverAlCatalogo">Volver al Catálogo</button>
        </div>
    }
    else if (pedido != null)
    {
        <div class="confirmacion-content">
            <div class="success-header">
                <div class="checkmark-circle"> ✓ </div>
                <h1 class="success-title">¡Pedido Confirmado!</h1>
                <p class="pedido-numero">
                    Orden N° <strong>@pedido.NumeroPedido</strong>
                </p>
                <p class="success-message">
                    Tu pedido ha sido recibido exitosamente y está siendo procesado
                </p>
            </div>

            <div class="details-grid">
                <div class="left-column">
                    <div class="section-card productos-section">
                        <div class="section-header">
                            <h3>Tus Productos</h3>
                            <span class="badge-cantidad">@pedido.Productos.Count items</span>
                        </div>
                        <div class="productos-list">
                            @foreach (var producto in pedido.Productos)
                            {
                                <div class="producto-item-modern">
                                    <div class="producto-imagen-wrapper">
                                        @if (!string.IsNullOrEmpty(producto.ImagenUrl))
                                        {
                                            <img src="@producto.ImagenUrl" alt="@producto.NombreProducto" class="producto-img" />
                                        }
                                        else
                                        {
                                            <div class="producto-placeholder"></div>
                                        }
                                    </div>
                                    <div class="producto-detalles">
                                        <h4 class="producto-nombre">@producto.NombreProducto</h4>
                                        <p class="producto-marca">@producto.Marca</p>
                                        <div class="producto-variantes">
                                            <span class="variante-tag">@producto.Talla</span>
                                            <span class="variante-tag">@producto.Color</span>
                                        </div>
                                        <p class="producto-cantidad-texto">Cantidad: <strong>@producto.Cantidad</strong></p>
                                    </div>
                                    <div class="producto-precio-section">
                                        <p class="producto-precio-total">@producto.SubtotalLinea.ToString("C")</p>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>

                    <div class="section-card envio-section">
                        <div class="section-header">
                            <h3><Icon Name="IconName.Truck" /> Información de Envío</h3>
                        </div>
                        <div class="envio-detalles">
                            <div class="envio-grupo">
                                <div class="envio-icon"><Icon Name="IconName.User" /></div>
                                <div>
                                    <p class="envio-label">Destinatario</p>
                                    <p class="envio-valor">@pedido.NombreCliente</p>
                                </div>
                            </div>
                            <div class="envio-grupo">
                                <div class="envio-icon"><Icon Name="IconName.Directions" /></div>
                                <div>
                                    <p class="envio-label">Dirección</p>
                                    <p class="envio-valor">@pedido.DireccionCompleta</p>
                                    <p class="envio-valor-secundario">@pedido.Barrio</p>
                                    <p class="envio-valor-secundario">@pedido.Ciudad, @pedido.Departamento</p>
                                </div>
                            </div>
                            <div class="envio-grupo">
                                <div class="envio-icon"><Icon Name="IconName.Phone" /></div>
                                <div>
                                    <p class="envio-label">Teléfono</p>
                                    <p class="envio-valor">@pedido.TelefonoPrincipal</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="right-column">
                    <div class="section-card resumen-section">
                        <div class="section-header">
                            <h3>💳 Resumen del Pedido</h3>
                        </div>
                        <div class="resumen-contenido">
                            <div class="resumen-linea">
                                <span class="resumen-label">Subtotal</span>
                                <span class="resumen-valor">@pedido.Subtotal.ToString("C")</span>
                            </div>
                            <div class="resumen-linea">
                                <span class="resumen-label">IVA (19%)</span>
                                <span class="resumen-valor">@pedido.Impuesto.ToString("C")</span>
                            </div>
                            <div class="resumen-divider"></div>
                            <div class="resumen-total-linea">
                                <span class="resumen-total-label">Total</span>
                                <span class="resumen-total-valor">@pedido.Total.ToString("C")</span>
                            </div>
                            <div class="metodo-pago-info">
                                <div class="metodo-pago-icon"><Icon Name="IconName.MoneyBillAlt" /></div>
                                <div>
                                    <p class="metodo-label">Método de pago</p>
                                    <p class="metodo-valor">@pedido.MetodoPago</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="info-boxes">
                        <div class="info-box-modern">
                            <div class="info-box-icon"><Icon Name="IconName.Mail" /></div>
                            <div class="info-box-content">
                                <h4>Confirmación Enviada</h4>
                                <p>Revisa <strong>@pedido.CorreoCliente</strong> para más detalles</p>
                            </div>
                        </div>

                        <div class="info-box-modern">
                            <div class="info-box-icon"><Icon Name="IconName.Send" /></div>
                            <div class="info-box-content">
                                <h4>¿Necesitas Ayuda?</h4>
                                <p>Contáctanos con tu N° de orden</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="acciones-footer">
                <button class="btn-action btn-secondary" @onclick="VerMisPedidos">
                    <Icon Name="IconName.File" /> Ver Mis Pedidos
                </button>
                <button class="btn-action btn-primary" @onclick="VolverAlCatalogo">
                    <Icon Name="IconName.ShoppingCart" /> Seguir Comprando
                </button>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public int IdPedido { get; set; }

    private PedidoCompletoDTO? pedido;
    private bool cargando = true;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await CargarPedido();
    }

    private async Task CargarPedido()
    {
        try
        {
            cargando = true;
            errorMessage = null;

            var response = await PedidoService.ObtenerPedidoCompleto(IdPedido);

            if (response.IsSuccess && response.Object != null)
            {
                pedido = response.Object;
            }
            else
            {
                errorMessage = response.Message ?? "Error al cargar el pedido";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            cargando = false;
        }
    }

    private string GetEstadoClass(string estado)
    {
        return estado.ToLower() switch
        {
            "pendiente" => "badge-pendiente",
            "confirmado" => "badge-confirmado",
            "enviado" => "badge-enviado",
            "entregado" => "badge-entregado",
            _ => "badge-pendiente"
        };
    }

    private void VerMisPedidos()
    {
        Navigation.NavigateTo("/mis-pedidos");
    }

    private void VolverAlCatalogo()
    {
        Navigation.NavigateTo("/ClienteCatalogo");
    }
}

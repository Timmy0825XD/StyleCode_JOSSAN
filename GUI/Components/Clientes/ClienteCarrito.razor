@page "/carrito"
@using BLL.Interfaces
@using ENTITY.Pedidos
@using GUI.Components.Layout
@using GUI.Services
@inject CarritoService Carrito
@inject NavigationManager Navigation
@inject IUsuarioService UsuarioService
@layout ClienteLayout
@implements IDisposable

<div class="carrito-container">
    <div class="carrito-header">
        <h2>Mi Carrito</h2>
        <button class="btn-back" @onclick="VolverAlCatalogo">
            ← Seguir Comprando
        </button>
    </div>

    @if (Carrito.EstaVacio())
    {
        <div class="carrito-vacio">
            <div class="empty-icon"><Icon Name="IconName.Cart" /></div>
            <h3>Tu carrito está vacío</h3>
            <p>¡Agrega productos para comenzar tu compra!</p>
            <button class="btn-primary" @onclick="VolverAlCatalogo">
                Ver Productos
            </button>
        </div>
    }
    else
    {
        <div class="carrito-content">
            <div class="carrito-items">
                @foreach (var item in items)
                {
                    <div class="carrito-item">
                        <div class="item-imagen">
                            @if (!string.IsNullOrEmpty(item.ImagenUrl))
                            {
                                <img src="@item.ImagenUrl" alt="@item.NombreArticulo" />
                            }
                            else
                            {
                                <img src="https://via.placeholder.com/100x100/667eea/ffffff?text=Producto" alt="@item.NombreArticulo" />
                            }
                        </div>

                        <div class="item-info">
                            <h4>@item.NombreArticulo</h4>
                            <p class="item-marca">@item.Marca</p>
                            <div class="item-variante">
                                <span class="variante-badge">Talla: @item.Talla</span>
                                <span class="variante-badge">Color: @item.Color</span>
                            </div>
                            <p class="item-sku">SKU: @item.CodigoSKU</p>
                            <p class="item-stock">Stock disponible: @item.StockDisponible</p>
                        </div>

                        <div class="item-precio-unitario">
                            <p class="precio-label">Precio</p>
                            <p class="precio-valor">@item.PrecioUnitario.ToString("C")</p>
                        </div>

                        <div class="item-cantidad">
                            <p class="cantidad-label">Cantidad</p>
                            <div class="cantidad-controls">
                                <button class="btn-cantidad" @onclick="() => DisminuirCantidad(item)">−</button>
                                <input type="number"
                                       class="cantidad-input"
                                       value="@item.Cantidad"
                                       min="1"
                                       max="@item.StockDisponible"
                                       @onchange="(e) => CambiarCantidad(item, e)" />
                                <button class="btn-cantidad" @onclick="() => AumentarCantidad(item)">+</button>
                            </div>
                        </div>

                        <div class="item-subtotal">
                            <p class="subtotal-label">Subtotal</p>
                            <p class="subtotal-valor">@item.Subtotal.ToString("C")</p>
                        </div>

                        <button class="btn-eliminar" @onclick="() => EliminarItem(item)" title="Eliminar">
                            <Icon Name="IconName.Delete" />
                        </button>
                    </div>
                }
            </div>

            <div class="carrito-resumen">
                <div class="resumen-card">
                    <h3>Resumen del Pedido</h3>

                    <div class="resumen-linea">
                        <span>Productos (@totalProductos)</span>
                        <span>@subtotal.ToString("C")</span>
                    </div>

                    <div class="resumen-linea">
                        <span>Envío</span>
                        <span class="envio-gratis">GRATIS</span>
                    </div>

                    <div class="resumen-linea">
                        <span>IVA (19%)</span>
                        <span>@impuesto.ToString("C")</span>
                    </div>

                    <div class="resumen-divider"></div>

                    <div class="resumen-total">
                        <span>Total</span>
                        <span>@total.ToString("C")</span>
                    </div>

                    <button class="btn-checkout" @onclick="IrACheckout">
                        Proceder al Pago
                    </button>

                    <button class="btn-limpiar" @onclick="LimpiarCarrito">
                        Vaciar Carrito
                    </button>

                    <div class="resumen-info">
                        <p>✓ Envío gratis a toda Colombia</p>
                        <p>✓ Compra 100% segura</p>
                        <p>✓ Devoluciones fáciles</p>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<!-- Modal de login requerido -->
@if (mostrarModalLogin)
{
    <div class="modal-overlay" @onclick="CerrarModalLogin">
        <div class="modal-login" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>Inicia sesión para continuar</h3>
                <button class="btn-close" @onclick="CerrarModalLogin">✕</button>
            </div>
            <div class="modal-body">
                <p>Para proceder con tu compra necesitas iniciar sesión o crear una cuenta.</p>
                <div class="modal-actions">
                    <button class="btn-primary" @onclick="IrALogin">
                        Iniciar Sesión
                    </button>
                    <button class="btn-secondary" @onclick="IrARegistro">
                        Crear Cuenta
                    </button>
                </div>
            </div>
        </div>
    </div>
}


@code {
    private List<CarritoItemDTO> items = new();
    private int totalProductos = 0;
    private decimal subtotal = 0;
    private decimal impuesto = 0;
    private decimal total = 0;
    private bool mostrarModalLogin = false;

    protected override void OnInitialized()
    {
        Carrito.OnChange += ActualizarCarrito;
        ActualizarCarrito();
    }

    private void ActualizarCarrito()
    {
        items = Carrito.ObtenerItems();
        totalProductos = Carrito.ObtenerCantidadTotal();
        subtotal = Carrito.ObtenerSubtotal();
        impuesto = Carrito.ObtenerImpuesto();
        total = Carrito.ObtenerTotal();
        StateHasChanged();
    }

    private void AumentarCantidad(CarritoItemDTO item)
    {
        if (item.Cantidad < item.StockDisponible && item.Cantidad < 99)
        {
            Carrito.ActualizarCantidad(item.IdVariante, item.Cantidad + 1);
        }
    }

    private void DisminuirCantidad(CarritoItemDTO item)
    {
        if (item.Cantidad > 1)
        {
            Carrito.ActualizarCantidad(item.IdVariante, item.Cantidad - 1);
        }
    }

    private void CambiarCantidad(CarritoItemDTO item, ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int nuevaCantidad))
        {
            Carrito.ActualizarCantidad(item.IdVariante, nuevaCantidad);
        }
    }

    private void EliminarItem(CarritoItemDTO item)
    {
        Carrito.EliminarItem(item.IdVariante);
    }

    private void LimpiarCarrito()
    {
        if (confirm("¿Estás seguro de que quieres vaciar el carrito?"))
        {
            Carrito.Limpiar();
        }
    }

    private bool confirm(string mensaje)
    {
        return true;
    }

    private void VolverAlCatalogo()
    {
        Navigation.NavigateTo("/");
    }

    private void IrACheckout()
    {
        var nombreUsuario = UsuarioService.ObtenerNombreUsuario();

        if (string.IsNullOrEmpty(nombreUsuario) || nombreUsuario == "Cliente" || nombreUsuario == "Usuario")
        {
            mostrarModalLogin = true;
        }
        else
        {
            Navigation.NavigateTo("/checkout");
        }
    }

    private void CerrarModalLogin()
    {
        mostrarModalLogin = false;
    }

    private void IrALogin()
    {
        Navigation.NavigateTo("/login");
    }

    private void IrARegistro()
    {
        Navigation.NavigateTo("/registro");
    }

    public void Dispose()
    {
        Carrito.OnChange -= ActualizarCarrito;
    }
}
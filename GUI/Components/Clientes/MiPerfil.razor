@page "/mi-perfil"
@using BLL.Interfaces
@using ENTITY.Usuarios
@using ENTITY.Direcciones
@using ENTITY.Utilidades
@using GUI.Components.Layout
@using GUI.Services
@inject IUsuarioService UsuarioService
@inject IDireccionService DireccionService
@inject SesionService SesionService
@inject NavigationManager Navigation
@layout ClienteLayout

<div class="container">
    <h2 class="page-title">Mi Perfil</h2>

    @if (cargando)
    {
        <div class="empty-state">
            <p>Cargando información...</p>
        </div>
    }
    else if (usuario == null)
    {
        <div class="empty-state">
            <span class="empty-icon">⚠️</span>
            <p>No se pudo cargar la información del usuario</p>
            <button class="btn-primary" @onclick="@(() => Navigation.NavigateTo("/login"))">
                Iniciar Sesión
            </button>
        </div>
    }
    else
    {
        <!-- Información Personal -->
        <div class="content-card">
            <div class="card-header">
                <div class="header-content">
                    <span class="header-icon"><Icon Name="IconName.User" /></span>
                    <h3 class="card-title">Información Personal</h3>
                </div>
                @if (!editandoPersonal)
                {
                    <button class="btn-edit" @onclick="() => editandoPersonal = true">
                        <span><Icon Name="IconName.Pen" /></span> Editar
                    </button>
                }
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Cédula</label>
                    <input type="text" class="form-input" @bind="usuario.Cedula" disabled="@(!editandoPersonal)" />
                </div>

                <div class="form-group">
                    <label class="form-label">Primer Nombre</label>
                    <input type="text" class="form-input" @bind="usuario.PrimerNombre" disabled="@(!editandoPersonal)" />
                </div>

                <div class="form-group">
                    <label class="form-label">Segundo Nombre</label>
                    <input type="text" class="form-input" @bind="usuario.SegundoNombre" disabled="@(!editandoPersonal)" placeholder="Opcional" />
                </div>

                <div class="form-group">
                    <label class="form-label">Apellido Paterno</label>
                    <input type="text" class="form-input" @bind="usuario.ApellidoPaterno" disabled="@(!editandoPersonal)" />
                </div>

                <div class="form-group">
                    <label class="form-label">Apellido Materno</label>
                    <input type="text" class="form-input" @bind="usuario.ApellidoMaterno" disabled="@(!editandoPersonal)" placeholder="Opcional" />
                </div>

                <div class="form-group">
                    <label class="form-label">Correo Electrónico</label>
                    <input type="email" class="form-input" @bind="usuario.Correo" disabled="@(!editandoPersonal)" />
                </div>

                <div class="form-group">
                    <label class="form-label">Teléfono Principal</label>
                    <input type="tel" class="form-input" @bind="usuario.TelefonoPrincipal" disabled="@(!editandoPersonal)" />
                </div>

                <div class="form-group">
                    <label class="form-label">Teléfono Secundario</label>
                    <input type="tel" class="form-input" @bind="usuario.TelefonoSecundario" disabled="@(!editandoPersonal)" placeholder="Opcional" />
                </div>
            </div>

            @if (editandoPersonal)
            {
                <div class="form-group">
                    <label class="form-label">Nueva Contraseña (dejar en blanco para no cambiar)</label>
                    <input type="password" class="form-input" @bind="nuevaContrasena" placeholder="Mínimo 6 caracteres" />
                </div>

                <div class="action-buttons">
                    <button class="btn-primary" @onclick="GuardarCambiosPersonales" disabled="@guardandoPersonal">
                        @if (guardandoPersonal)
                        {
                            <span>Guardando...</span>
                        }
                        else
                        {
                            <span>Guardar Cambios</span>
                        }
                    </button>
                    <button class="btn-secondary" @onclick="CancelarEdicionPersonal" disabled="@guardandoPersonal">
                        Cancelar
                    </button>
                </div>
            }

            @if (!string.IsNullOrEmpty(mensajePersonal))
            {
                <div class="alert @(mensajePersonalExito ? "alert-success" : "alert-error")">
                    @mensajePersonal
                </div>
            }
        </div>


        <div class="content-card mt-4">
            <div class="card-header">
                <div class="header-content">
                    <span class="header-icon"><Icon Name="IconName.Truck" /></span>
                    <h3 class="card-title">Dirección de Envío</h3>
                </div>
                @if (!editandoDireccion && direccion != null)
                {
                    <button class="btn-edit" @onclick="() => editandoDireccion = true">
                        <span>✏️</span> Editar
                    </button>
                }
            </div>

            @if (direccion == null && !editandoDireccion)
            {
                <div class="empty-state-small">
                    <p>No tienes una dirección registrada</p>
                    <button class="btn-primary" @onclick="CrearNuevaDireccion">
                        <Icon Name="IconName.Add" />Agregar Dirección
                    </button>
                </div>
            }
            else
            {
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label class="form-label">Ciudad</label>
                        @if (editandoDireccion)
                        {
                            <select class="form-input" @bind="direccionEditar.CiudadId">
                                <option value="0">Seleccione una ciudad</option>
                                @foreach (var ciudad in ciudades)
                                {
                                    <option value="@ciudad.Id">@ciudad.Nombre - @ciudad.Departamento</option>
                                }
                            </select>
                        }
                        else
                        {
                            <input type="text" class="form-input" value="@ObtenerNombreCiudadCompleto()" disabled />
                        }
                    </div>

                    <div class="form-group full-width">
                        <label class="form-label">Dirección Completa</label>
                        <textarea class="form-textarea" rows="3" @bind="direccionEditar.DireccionCompleta"
                                  disabled="@(!editandoDireccion)" placeholder="Ej: Calle 123 #45-67"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Barrio</label>
                        <input type="text" class="form-input" @bind="direccionEditar.Barrio"
                               disabled="@(!editandoDireccion)" placeholder="Nombre del barrio" />
                    </div>

                    <div class="form-group">
                        <label class="form-label">Referencia (Opcional)</label>
                        <input type="text" class="form-input" @bind="direccionEditar.Referencia"
                               disabled="@(!editandoDireccion)" placeholder="Ej: Casa de color azul" />
                    </div>
                </div>

                @if (editandoDireccion)
                {
                    <div class="action-buttons">
                        <button class="btn-primary" @onclick="GuardarCambiosDireccion" disabled="@guardandoDireccion">
                            @if (guardandoDireccion)
                            {
                                <span> Guardando...</span>
                            }
                            else
                            {
                                <span>Guardar Dirección</span>
                            }
                        </button>
                        <button class="btn-secondary" @onclick="CancelarEdicionDireccion" disabled="@guardandoDireccion">
                             Cancelar
                        </button>
                    </div>
                }

                @if (!string.IsNullOrEmpty(mensajeDireccion))
                {
                    <div class="alert @(mensajeDireccionExito ? "alert-success" : "alert-error")">
                        @mensajeDireccion
                    </div>
                }
            }
        </div>

        <div class="content-card mt-4">
            <div class="card-header">
                <div class="header-content">
                    <h3 class="card-title">Información de Cuenta</h3>
                </div>
            </div>

            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Estado de Cuenta:</span>
                    <span class="status-badge @(usuario.Estado == "A" ? "activo" : "inactivo")">
                        @(usuario.Estado == "A" ? "Activa" : "Inactiva")
                    </span>
                </div>
                <div class="info-item">
                    <span class="info-label">Fecha de Registro:</span>
                    <span class="info-value">@usuario.FechaRegistro.ToString("dd/MM/yyyy")</span>
                </div>
                <div class="info-item">
                    <span class="info-label">ID de Usuario:</span>
                    <span class="info-value">@usuario.Id</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Rol:</span>
                    <span class="info-value">@(usuario.RolId == 1 ? "Administrador" : "Cliente")</span>
                </div>
            </div>
        </div>
    }
</div>


@code {
    private UsuarioDTO? usuario;
    private DireccionDetalleDTO? direccion;
    private List<CiudadDTO> ciudades = new();

    private bool cargando = true;
    private bool editandoPersonal = false;
    private bool editandoDireccion = false;
    private bool guardandoPersonal = false;
    private bool guardandoDireccion = false;

    private string mensajePersonal = "";
    private bool mensajePersonalExito = false;
    private string mensajeDireccion = "";
    private bool mensajeDireccionExito = false;

    private string nuevaContrasena = "";
    private UsuarioDTO usuarioOriginal = new();
    private DireccionActualizacionDTO direccionEditar = new();
    private bool esNuevaDireccion = false;

    protected override async Task OnInitializedAsync()
    {
        await CargarDatos();
    }

    private async Task CargarDatos()
    {
        cargando = true;

        try
        {
            var idUsuario = await SesionService.ObtenerIdUsuario();

            if (idUsuario == null)
            {
                Navigation.NavigateTo("/login");
                return;
            }

            var resultadoUsuarioCompleto = await UsuarioService.ObtenerTodosLosUsuarios();

            if (resultadoUsuarioCompleto.IsSuccess && resultadoUsuarioCompleto.ListObject != null)
            {
                usuario = resultadoUsuarioCompleto.ListObject.FirstOrDefault(u => u.Id == idUsuario.Value);

                if (usuario != null)
                {
                    usuarioOriginal = new UsuarioDTO
                    {
                        Id = usuario.Id,
                        Cedula = usuario.Cedula,
                        PrimerNombre = usuario.PrimerNombre,
                        SegundoNombre = usuario.SegundoNombre,
                        ApellidoPaterno = usuario.ApellidoPaterno,
                        ApellidoMaterno = usuario.ApellidoMaterno,
                        Correo = usuario.Correo,
                        TelefonoPrincipal = usuario.TelefonoPrincipal,
                        TelefonoSecundario = usuario.TelefonoSecundario,
                        Estado = usuario.Estado,
                        FechaRegistro = usuario.FechaRegistro,
                        RolId = usuario.RolId,
                        DireccionId = usuario.DireccionId,
                        Contrasena = usuario.Contrasena
                    };

                    if (usuario.DireccionId.HasValue && usuario.DireccionId.Value > 0)
                    {
                        var resultadoDireccion = await DireccionService.ObtenerDireccionPorId(usuario.DireccionId.Value);

                        if (resultadoDireccion.IsSuccess && resultadoDireccion.Object != null)
                        {
                            direccion = resultadoDireccion.Object;

                            direccionEditar = new DireccionActualizacionDTO
                            {
                                IdDireccion = direccion.IdDireccion,
                                CiudadId = direccion.CiudadId,
                                DireccionCompleta = direccion.DireccionCompleta,
                                Barrio = direccion.Barrio,
                                CodigoPostal = direccion.CodigoPostal,
                                Referencia = direccion.Referencia
                            };
                        }
                    }
                }
            }

            var resultadoCiudades = await DireccionService.ObtenerTodasLasCiudades();

            if (resultadoCiudades.IsSuccess && resultadoCiudades.ListObject != null)
            {
                ciudades = resultadoCiudades.ListObject.ToList();
            }
            else
            {
                ciudades = new List<CiudadDTO>();
            }
        }
        catch (Exception ex)
        {
        }
        finally
        {
            cargando = false;
        }
    }

    private string ObtenerNombreCiudadCompleto()
    {
        if (direccion == null) return "";

        var ciudad = ciudades.FirstOrDefault(c => c.Id == direccion.CiudadId);
        if (ciudad != null)
        {
            return $"{ciudad.Nombre} - {ciudad.Departamento}";
        }

        return "Ciudad no encontrada";
    }

    private void CrearNuevaDireccion()
    {
        esNuevaDireccion = true;
        editandoDireccion = true;
        direccionEditar = new DireccionActualizacionDTO
        {
            IdDireccion = 0,
            CiudadId = 0,
            DireccionCompleta = "",
            Barrio = "",
            Referencia = ""
        };
    }

    private async Task GuardarCambiosPersonales()
    {
        mensajePersonal = "";
        guardandoPersonal = true;

        try
        {
            if (!string.IsNullOrWhiteSpace(nuevaContrasena) && nuevaContrasena.Length < 6)
            {
                mensajePersonal = " La nueva contraseña debe tener al menos 6 caracteres";
                mensajePersonalExito = false;
                guardandoPersonal = false;
                return;
            }

            var contrasenaFinal = string.IsNullOrWhiteSpace(nuevaContrasena)
                ? usuarioOriginal.Contrasena
                : nuevaContrasena;

            var usuarioActualizar = new UsuarioDTO
            {
                Id = usuario!.Id,
                Cedula = usuario.Cedula,
                PrimerNombre = usuario.PrimerNombre,
                SegundoNombre = usuario.SegundoNombre,
                ApellidoPaterno = usuario.ApellidoPaterno,
                ApellidoMaterno = usuario.ApellidoMaterno,
                Correo = usuario.Correo,
                TelefonoPrincipal = usuario.TelefonoPrincipal,
                TelefonoSecundario = usuario.TelefonoSecundario,
                Estado = usuario.Estado,
                FechaRegistro = usuario.FechaRegistro,
                RolId = usuario.RolId,
                DireccionId = usuario.DireccionId,
                Contrasena = contrasenaFinal
            };

            var resultado = await UsuarioService.ActualizarUsuario(usuarioActualizar);

            if (resultado.IsSuccess)
            {
                mensajePersonal = " Información personal actualizada correctamente";
                mensajePersonalExito = true;
                editandoPersonal = false;
                nuevaContrasena = "";

                usuarioOriginal = new UsuarioDTO
                {
                    Id = usuarioActualizar.Id,
                    Cedula = usuarioActualizar.Cedula,
                    PrimerNombre = usuarioActualizar.PrimerNombre,
                    SegundoNombre = usuarioActualizar.SegundoNombre,
                    ApellidoPaterno = usuarioActualizar.ApellidoPaterno,
                    ApellidoMaterno = usuarioActualizar.ApellidoMaterno,
                    Correo = usuarioActualizar.Correo,
                    TelefonoPrincipal = usuarioActualizar.TelefonoPrincipal,
                    TelefonoSecundario = usuarioActualizar.TelefonoSecundario,
                    Estado = usuarioActualizar.Estado,
                    FechaRegistro = usuarioActualizar.FechaRegistro,
                    RolId = usuarioActualizar.RolId,
                    DireccionId = usuarioActualizar.DireccionId,
                    Contrasena = usuarioActualizar.Contrasena
                };

                await Task.Delay(3000);
                mensajePersonal = "";
            }
            else
            {
                mensajePersonal = $" {resultado.Message}";
                mensajePersonalExito = false;
            }
        }
        catch (Exception ex)
        {
            mensajePersonal = $" Error: {ex.Message}";
            mensajePersonalExito = false;
        }
        finally
        {
            guardandoPersonal = false;
        }
    }

    private void CancelarEdicionPersonal()
    {
        usuario!.Cedula = usuarioOriginal.Cedula;
        usuario.PrimerNombre = usuarioOriginal.PrimerNombre;
        usuario.SegundoNombre = usuarioOriginal.SegundoNombre;
        usuario.ApellidoPaterno = usuarioOriginal.ApellidoPaterno;
        usuario.ApellidoMaterno = usuarioOriginal.ApellidoMaterno;
        usuario.Correo = usuarioOriginal.Correo;
        usuario.TelefonoPrincipal = usuarioOriginal.TelefonoPrincipal;
        usuario.TelefonoSecundario = usuarioOriginal.TelefonoSecundario;

        nuevaContrasena = "";
        editandoPersonal = false;
        mensajePersonal = "";
    }

    private async Task GuardarCambiosDireccion()
    {
        mensajeDireccion = "";
        guardandoDireccion = true;

        try
        {
            if (direccionEditar.CiudadId <= 0)
            {
                mensajeDireccion = " Debe seleccionar una ciudad";
                mensajeDireccionExito = false;
                guardandoDireccion = false;
                return;
            }

            if (string.IsNullOrWhiteSpace(direccionEditar.DireccionCompleta) || direccionEditar.DireccionCompleta.Length < 10)
            {
                mensajeDireccion = " La dirección debe tener al menos 10 caracteres";
                mensajeDireccionExito = false;
                guardandoDireccion = false;
                return;
            }

            if (string.IsNullOrWhiteSpace(direccionEditar.Barrio) || direccionEditar.Barrio.Length < 3)
            {
                mensajeDireccion = " El barrio debe tener al menos 3 caracteres";
                mensajeDireccionExito = false;
                guardandoDireccion = false;
                return;
            }

            if (esNuevaDireccion)
            {
                var nuevaDireccion = new DireccionCreacionDTO
                {
                    CiudadId = direccionEditar.CiudadId,
                    DireccionCompleta = direccionEditar.DireccionCompleta,
                    Barrio = direccionEditar.Barrio,
                    Referencia = direccionEditar.Referencia
                };

                var resultado = await DireccionService.CrearDireccion(nuevaDireccion);

                if (resultado.IsSuccess)
                {
                    mensajeDireccion = " Dirección creada correctamente";
                    mensajeDireccionExito = true;
                    editandoDireccion = false;
                    esNuevaDireccion = false;

                    usuario!.DireccionId = resultado.Object;
                    await UsuarioService.ActualizarUsuario(usuario);

                    await Task.Delay(1500);
                    await CargarDatos();
                    mensajeDireccion = "";
                }
                else
                {
                    mensajeDireccion = $" {resultado.Message}";
                    mensajeDireccionExito = false;
                }
            }
            else
            {
                var resultado = await DireccionService.ActualizarDireccion(direccionEditar);

                if (resultado.IsSuccess)
                {
                    mensajeDireccion = " Dirección actualizada correctamente";
                    mensajeDireccionExito = true;
                    editandoDireccion = false;

                    await Task.Delay(1500);
                    await CargarDatos();
                    mensajeDireccion = "";
                }
                else
                {
                    mensajeDireccion = $" {resultado.Message}";
                    mensajeDireccionExito = false;
                }
            }
        }
        catch (Exception ex)
        {
            mensajeDireccion = $" Error: {ex.Message}";
            mensajeDireccionExito = false;
        }
        finally
        {
            guardandoDireccion = false;
        }
    }

    private void CancelarEdicionDireccion()
    {
        if (esNuevaDireccion)
        {
            esNuevaDireccion = false;
            direccionEditar = new DireccionActualizacionDTO();
        }
        else if (direccion != null)
        {
            direccionEditar = new DireccionActualizacionDTO
            {
                IdDireccion = direccion.IdDireccion,
                CiudadId = direccion.CiudadId,
                DireccionCompleta = direccion.DireccionCompleta,
                Barrio = direccion.Barrio,
                Referencia = direccion.Referencia
            };
        }

        editandoDireccion = false;
        mensajeDireccion = "";
    }
}
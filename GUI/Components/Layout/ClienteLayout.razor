@using BLL.Interfaces
@using ENTITY.Usuarios
@using GUI.Services
@inherits LayoutComponentBase
@inject CarritoService Carrito
@inject SesionService SesionService
@inject NavigationManager Navigation
@implements IDisposable

<div class="layout-container">
    <div class="page">
        <aside class="sidebar @(isMenuVisible ? "" : "collapsed")">
            <ClienteMenu />
        </aside>
        <main class="main-content @(isMenuVisible ? "" : "expanded")">
            <div class="header">
                <div class="header-left">
                    <button class="btn-toggle" @onclick="ToggleMenu">
                        @(isMenuVisible ? "✕" : "☰")
                    </button>
                    <div class="header-brand" @onclick="IrAlInicio" style="cursor: pointer;">
                        <span class="brand-icon">🛍️</span>
                        <span class="brand-text">Tienda JOSSAN</span>
                    </div>
                </div>
                <div class="header-right">
                    <button class="btn-carrito" @onclick="IrAlCarrito">
                        🛒 Carrito
                        @if (cantidadCarrito > 0)
                        {
                            <span class="carrito-badge">@cantidadCarrito</span>
                        }
                    </button>

                    @if (EstaLogueado)
                    {
                        <div class="user-menu">
                            <div class="user-avatar">@GetInitials(UserDisplayName)</div>
                            <div class="user-info">
                                <div class="user-name">@UserDisplayName</div>
                                <div class="user-role">Cliente</div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="auth-buttons">
                            <button class="btn-login" @onclick="IrALogin">
                                Iniciar Sesión
                            </button>
                            <button class="btn-registro" @onclick="IrARegistro">
                                Registrarse
                            </button>
                        </div>
                    }
                </div>
            </div>
            <article class="content" style="overflow-y:auto">
                @Body
            </article>
        </main>
    </div>
</div>

<style>
    .auth-buttons {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .btn-login, .btn-registro {
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
        font-size: 0.9rem;
    }

    .btn-login {
        background: transparent;
        color: #667eea;
        border: 2px solid #667eea;
    }

        .btn-login:hover {
            background: #667eea;
            color: white;
        }

    .btn-registro {
        background: #667eea;
        color: white;
    }

        .btn-registro:hover {
            background: #5568d3;
        }
</style>

@code {
    private string UserDisplayName { get; set; } = "Invitado";
    private bool EstaLogueado { get; set; } = false;
    private bool isMenuVisible = false;
    private int cantidadCarrito = 0;

    protected override async Task OnInitializedAsync()
    {
        Carrito.OnChange += ActualizarContadorCarrito;
        ActualizarContadorCarrito();

        await CargarUsuario();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await CargarUsuario();
            StateHasChanged();
        }
    }

    private async Task CargarUsuario()
    {
        try
        {
            var usuario = await SesionService.ObtenerUsuarioActual();

            if (usuario != null)
            {
                UserDisplayName = usuario.NombreCompleto;
                EstaLogueado = true;
                Console.WriteLine($"✅ Usuario cargado en layout: {UserDisplayName} (ID: {usuario.IdUsuario})");
            }
            else
            {
                UserDisplayName = "Invitado";
                EstaLogueado = false;
                Console.WriteLine("⚠️ No hay usuario logueado en layout");
            }
        }
        catch (Exception ex)
        {
            UserDisplayName = "Invitado";
            EstaLogueado = false;
            Console.WriteLine($"❌ Error al cargar usuario en layout: {ex.Message}");
        }
    }

    private void ToggleMenu()
    {
        isMenuVisible = !isMenuVisible;
    }

    private void ActualizarContadorCarrito()
    {
        cantidadCarrito = Carrito.ObtenerCantidadTotal();
        StateHasChanged();
    }

    private void IrAlCarrito()
    {
        Navigation.NavigateTo("/carrito");
    }

    private void IrAlInicio()
    {
        Navigation.NavigateTo("/");
    }

    private void IrALogin()
    {
        Navigation.NavigateTo("/login");
    }

    private void IrARegistro()
    {
        Navigation.NavigateTo("/register");
    }

    public void Dispose()
    {
        Carrito.OnChange -= ActualizarContadorCarrito;
    }

    private string GetInitials(string name)
    {
        if (string.IsNullOrWhiteSpace(name) || name == "Invitado")
            return "IN";

        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();

        return name.Length >= 2 ? name.Substring(0, 2).ToUpper() : name.ToUpper();
    }
}
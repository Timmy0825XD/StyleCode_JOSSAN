@using BLL.Interfaces
@using GUI.Services
@using Blazorise
@inject IUsuarioService UsuarioService
@inject SesionService SesionService
@inject NavigationManager Navigation

<div class="sidebar-header">
    <div class="sidebar-logo">
        <span class="logo-icon">🛍️</span>
        <div class="logo-text">
            <span class="logo-title">JOSSAN</span>
            <span class="logo-subtitle">Tu estilo perfecto</span>
        </div>
    </div>
</div>

<nav class="sidebar-nav">

    <NavLink class="nav-item" href="/" Match="NavLinkMatch.All">
        <span class="nav-icon"><Icon Name="IconName.Home" /></span>
        <span class="nav-text">Inicio</span>
    </NavLink>

    <!-- Páginas que requieren login -->
    <a class="nav-item" @onclick="@(() => IrAPagina("virtual-tryon"))" style="cursor: pointer;">
        <span class="nav-icon"><Icon Name="IconName.Eye" /></span>
        <span class="nav-text">Prueba Virtual</span>
    </a>

    <a class="nav-item" @onclick="@(() => IrAPagina("mis-pedidos"))" style="cursor: pointer;">
        <span class="nav-icon"><Icon Name="IconName.ShoppingBasket" /></span>
        <span class="nav-text">Mis Pedidos</span>
    </a>

    <a class="nav-item" @onclick="@(() => IrAPagina("favoritos"))" style="cursor: pointer;">
        <span class="nav-icon"><Icon Name="IconName.Heart" /></span>
        <span class="nav-text">Favoritos</span>
    </a>

    <a class="nav-item" @onclick="@(() => IrAPagina("mi-perfil"))" style="cursor: pointer;">
        <span class="nav-icon"><Icon Name="IconName.User" /></span>
        <span class="nav-text">Mi Perfil</span>
    </a>

    <a class="nav-item" @onclick="@(() => IrAPagina("asistente"))" style="cursor: pointer;">
        <span class="nav-icon"><Icon Name="IconName.Comment" /></span>
        <span class="nav-text">Asistente Virtual</span>
    </a>
</nav>

<div class="sidebar-footer">
    <div class="promo-card">
        <div class="promo-content">
            <p class="promo-title">¡Nueva Colección!</p>
            <p class="promo-text">Descubre las últimas tendencias</p>
        </div>
    </div>

    @if (EstaLogueado)
    {
        <button class="logout-btn" @onclick="CerrarSesion">
            <span>Cerrar Sesión</span>
        </button>
    }
    else
    {
        <button class="login-btn" @onclick="IrALoginDirecto">
            <span>Iniciar Sesión</span>
        </button>
    }
</div>

<!-- Modal de login requerido -->
@if (mostrarModalLogin)
{
    <div class="modal-overlay" @onclick="CerrarModalLogin">
        <div class="modal-login" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>Inicia sesión para continuar</h3>
                <button class="btn-close-modal" @onclick="CerrarModalLogin">✕</button>
            </div>
            <div class="modal-body">
                <p>Para acceder a esta sección necesitas iniciar sesión o crear una cuenta.</p>
                <div class="modal-actions">
                    <button class="btn-primary-modal" @onclick="IrALoginDesdeModal">
                        Iniciar Sesión
                    </button>
                    <button class="btn-secondary-modal" @onclick="IrARegistroDesdeModal">
                        Crear Cuenta
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<style>

    .logo-icon {
        font-size: 32px;
        animation: bounce 2s infinite;
    }

    @@keyframes bounce {
        0%, 100% {
            transform: translateY(0);
        }

        50% {
            transform: translateY(-5px);
        }
    }

    .nav-item {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 14px 16px;
        border-radius: 12px;
        color: #6b7280;
        text-decoration: none;
        transition: all 0.3s ease;
        margin-bottom: 8px;
        position: relative;
    }

        .nav-item:hover {
            background-color: #f3f4f6;
            transform: translateX(5px);
            color: #667eea;
        }

        .nav-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

    .nav-text {
        flex: 1;
        font-weight: 500;
        font-size: 14px;
    }

    .sidebar-footer {
        padding: 16px;
        border-top: 1px solid #e5e7eb;
    }

    .promo-title {
        color: white;
        font-weight: 700;
        font-size: 14px;
        margin: 0 0 4px 0;
    }

    .promo-text {
        color: rgba(255, 255, 255, 0.9);
        font-size: 12px;
        margin: 0;
    }

    .logout-btn, .login-btn {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 12px;
        border: none;
        border-radius: 12px;
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
    }

    .login-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

        .logout-btn:hover, .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

    /* Estilos del modal */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        animation: fadeIn 0.3s ease;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    .modal-login {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        max-width: 450px;
        width: 90%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.3s ease;
    }

    @@keyframes slideUp {
        from {
            transform: translateY(50px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #e5e7eb;
    }

        .modal-header h3 {
            margin: 0;
            color: #1a202c;
            font-size: 1.25rem;
        }

    .btn-close-modal {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #718096;
        transition: color 0.3s ease;
        padding: 0;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

        .btn-close-modal:hover {
            color: #1a202c;
            background: #f3f4f6;
        }

    .modal-body p {
        color: #4a5568;
        margin-bottom: 1.5rem;
        line-height: 1.6;
        font-size: 1rem;
    }

    .modal-actions {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .btn-primary-modal, .btn-secondary-modal {
        padding: 0.875rem 1.5rem;
        border: none;
        border-radius: 10px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 100%;
    }

    .btn-primary-modal {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

        .btn-primary-modal:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

    .btn-secondary-modal {
        background: #f3f4f6;
        color: #1a202c;
        border: 2px solid #e5e7eb;
    }

        .btn-secondary-modal:hover {
            background: #e5e7eb;
            border-color: #cbd5e0;
        }

    @@media (max-width: 480px) {
        .modal-login {
            padding: 1.5rem;
            max-width: 95%;
        }

        .modal-header h3 {
            font-size: 1.1rem;
        }

        .modal-body p {
            font-size: 0.95rem;
        }
    }
</style>

@code {
    private bool EstaLogueado { get; set; } = false;
    private bool mostrarModalLogin = false;
    private string paginaDestino = "";

    protected override async Task OnInitializedAsync()
    {
        await VerificarSesion();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await VerificarSesion();
            StateHasChanged();
        }
    }

    private async Task VerificarSesion()
    {
        try
        {
            EstaLogueado = await SesionService.EstaLogueado();
            Console.WriteLine($"✅ Estado de sesión en menú: {(EstaLogueado ? "Logueado" : "No logueado")}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error al verificar sesión en menú: {ex.Message}");
            EstaLogueado = false;
        }
    }

    private async Task IrAPagina(string pagina)
    {
        await VerificarSesion(); // Verificar sesión antes de navegar

        if (!EstaLogueado)
        {
            // Usuario no logueado, guardar destino y mostrar modal
            paginaDestino = pagina;
            mostrarModalLogin = true;
            Console.WriteLine($"⚠️ Usuario no logueado intentando acceder a: {pagina}");
        }
        else
        {
            // Usuario logueado, permitir navegación
            Console.WriteLine($"✅ Usuario logueado, navegando a: {pagina}");
            Navigation.NavigateTo($"/{pagina}");
        }
    }

    private void CerrarModalLogin()
    {
        mostrarModalLogin = false;
        paginaDestino = "";
    }

    private void IrALoginDesdeModal()
    {
        // Guardar la página de destino en sessionStorage o como query parameter
        Navigation.NavigateTo($"/login?returnUrl={paginaDestino}");
    }

    private void IrARegistroDesdeModal()
    {
        Navigation.NavigateTo($"/Register");
    }

    private void IrALoginDirecto()
    {
        Navigation.NavigateTo("/login");
    }

    private async Task CerrarSesion()
    {
        try
        {
            // Cerrar sesión en SesionService (limpia ProtectedLocalStorage)
            await SesionService.CerrarSesion();

            // Cerrar sesión en UsuarioService (limpia campo estático)
            UsuarioService.CerrarSesion();

            Console.WriteLine("🚪 Sesión cerrada correctamente");

            // Redirigir al inicio con recarga forzada
            Navigation.NavigateTo("/", forceLoad: true);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error al cerrar sesión: {ex.Message}");
            // Aún así redirigir al inicio
            Navigation.NavigateTo("/", forceLoad: true);
        }
    }
}
@page "/AdminCupones"
@using ENTITY.Cupones
@using ENTITY.Utilidades
@using BLL.Interfaces
@inject ICuponService CuponService
@inject IJSRuntime JS

<div class="container">
    <div class="header-section">
        <h2 class="page-title">Gestión de Cupones de Descuento</h2>
        <button class="btn-secondary" @onclick="MostrarModalCrear">
            <span class="icon"><Icon Name="IconName.Add" /></span>
            Crear Cupón
        </button>
    </div>

    @if (cargando)
    {
        <div class="loading-container">
            <div class="spinner"></div>
            <p>Cargando cupones...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(mensajeError))
    {
        <div class="error-message">
            <span class="error-icon"><Icon Name="IconName.Alert" /></span>
            <span>@mensajeError</span>
            <button class="btn-retry" @onclick="CargarCupones">Reintentar</button>
        </div>
    }
    else
    {
        <div class="content-card">
            <div class="stats-row">
                <div class="stat-card stat-total">
                    <span class="stat-icon"><Icon Name="IconName.Dashboard" /></span>
                    <div class="stat-info">
                        <span class="stat-label">Total Cupones</span>
                        <span class="stat-value">@cupones.Count</span>
                    </div>
                </div>
                <div class="stat-card stat-aprobadas">
                    <span class="stat-icon"><Icon Name="IconName.Check" /></span>
                    <div class="stat-info">
                        <span class="stat-label">Activos</span>
                        <span class="stat-value">@cupones.Count(c => c.Estado == 'A')</span>
                    </div>
                </div>
                <div class="stat-card stat-pendientes">
                    <span class="stat-icon"><Icon Name="IconName.TimesCircle" /></span>
                    <div class="stat-info">
                        <span class="stat-label">Inactivos</span>
                        <span class="stat-value">@cupones.Count(c => c.Estado == 'I')</span>
                    </div>
                </div>
            </div>

            <div class="filters-row">
                <div class="search-box">
                    <input type="text"
                           placeholder="Buscar por código o descripción..."
                           class="search-input"
                           @bind="searchTerm"
                           @bind:event="oninput" />
                </div>
                <div class="filter-group">
                    <select class="filter-select" @bind="filterEstado">
                        <option value="">Todos los estados</option>
                        <option value="A">Activos</option>
                        <option value="I">Inactivos</option>
                    </select>
                    <select class="filter-select" @bind="filterTipo">
                        <option value="">Todos los tipos</option>
                        <option value="PORCENTAJE">Porcentaje</option>
                        <option value="MONTO">Monto Fijo</option>
                    </select>
                </div>
            </div>

            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Código</th>
                            <th>Descripción</th>
                            <th>Tipo</th>
                            <th>Descuento</th>
                            <th>Usos</th>
                            <th>Fecha Inicio</th>
                            <th>Fecha Expiración</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (CuponesFiltrados.Any())
                        {
                            @foreach (var cupon in CuponesFiltrados)
                            {
                                <tr class="table-row">
                                    <td class="invoice-id">#@cupon.IdCupon</td>
                                    <td class="coupon-code">
                                        <span class="code-badge">@cupon.Codigo</span>
                                    </td>
                                    <td class="coupon-description" title="@cupon.Descripcion">@cupon.Descripcion</td>
                                    <td>
                                        <span class="type-badge @(cupon.TipoDescuento == "PORCENTAJE" ? "type-percentage" : "type-amount")">
                                            @cupon.TipoDescuento
                                        </span>
                                    </td>
                                    <td class="discount-value">
                                        @if (cupon.TipoDescuento == "PORCENTAJE")
                                        {
                                            <span class="discount-percentage">@cupon.ValorDescuento%</span>
                                        }
                                        else
                                        {
                                            <span class="discount-amount">$@cupon.ValorDescuento.ToString("N2")</span>
                                        }
                                    </td>
                                    <td class="usage-info">
                                        <span class="usage-text">
                                            @cupon.UsosActuales / @(cupon.UsosMaximos?.ToString() ?? "∞")
                                        </span>
                                        @if (cupon.UsosMaximos.HasValue && cupon.UsosMaximos.Value > 0)
                                        {
                                            var porcentaje = Math.Min((cupon.UsosActuales * 100.0) / cupon.UsosMaximos.Value, 100);
                                            <div class="usage-bar">
                                                <div class="usage-fill" style="width: @porcentaje%"></div>
                                            </div>
                                        }
                                    </td>
                                    <td class="invoice-date">@cupon.FechaInicio.ToString("dd/MM/yyyy")</td>
                                    <td class="invoice-date">
                                        @if (cupon.FechaExpiracion.HasValue)
                                        {
                                            @cupon.FechaExpiracion.Value.ToString("dd/MM/yyyy")
                                            @if (cupon.FechaExpiracion.Value < DateTime.Now)
                                            {
                                                <span class="expired-label">Expirado</span>
                                            }
                                        }
                                        else
                                        {
                                            <span class="text-muted">Sin expiración</span>
                                        }
                                    </td>
                                    <td>
                                        <span class="status-badge @(cupon.Estado == 'A' ? "aprobada" : "rechazada")">
                                            @(cupon.Estado == 'A' ? "Activo" : "Inactivo")
                                        </span>
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn-action btn-dian"
                                                    @onclick="() => VerHistorial(cupon.IdCupon)"
                                                    title="Ver historial">
                                                <span><Icon Name="IconName.List" /></span>
                                            </button>
                                            @if (cupon.Estado == 'A')
                                            {
                                                <button class="btn-action btn-delete"
                                                        @onclick="() => DesactivarCuponConfirm(cupon.IdCupon)"
                                                        title="Desactivar">
                                                    <span><Icon Name="IconName.Ban" /></span>
                                                </button>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>

            @if (!CuponesFiltrados.Any())
            {
                <div class="empty-state">
                    <span class="empty-icon">🎟️</span>
                    <p>No se encontraron cupones con los filtros aplicados</p>
                    @if (!string.IsNullOrEmpty(searchTerm) || !string.IsNullOrEmpty(filterEstado) || !string.IsNullOrEmpty(filterTipo))
                    {
                        <button class="btn-clear-filters" @onclick="LimpiarFiltros">Limpiar filtros</button>
                    }
                </div>
            }
        </div>
    }

    @if (mostrarModalCrear)
    {
        <div class="modal-overlay" @onclick="CerrarModal">
            <div class="modal-content" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <h3>Crear Nuevo Cupón</h3>
                    <button class="btn-close" @onclick="CerrarModal">✕</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Código del Cupón *</label>
                        <input type="text" class="form-input" @bind="nuevoCupon.Codigo" placeholder="Ej: VERANO2024" maxlength="20" />
                        <small class="form-hint">Entre 3 y 20 caracteres</small>
                    </div>
                    <div class="form-group">
                        <label>Descripción *</label>
                        <textarea class="form-input" @bind="nuevoCupon.Descripcion" placeholder="Describe el cupón..." rows="3"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tipo de Descuento *</label>
                            <select class="form-input" @bind="nuevoCupon.TipoDescuento">
                                <option value="PORCENTAJE">Porcentaje (%)</option>
                                <option value="MONTO">Monto Fijo ($)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Valor del Descuento *</label>
                            <input type="number" class="form-input" @bind="nuevoCupon.ValorDescuento"
                                   placeholder="@(nuevoCupon.TipoDescuento == "PORCENTAJE" ? "Ej: 20" : "Ej: 50000")" step="0.01" min="0" />
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Usos Máximos</label>
                            <input type="number" class="form-input" @bind="nuevoCupon.UsosMaximos" placeholder="Dejar vacío para ilimitado" min="1" />
                            <small class="form-hint">Opcional: limita cuántas veces se puede usar</small>
                        </div>

                        <div class="form-group">
                            <label>Fecha de Inicio</label>
                            <input type="date"
                                   class="form-input"
                                   @bind="nuevoCupon.FechaInicio"
                                   min="@DateTime.Now.ToString("yyyy-MM-dd")" />
                            <small class="form-hint">Opcional: desde cuándo es válido (por defecto: hoy)</small>
                        </div>

                        <div class="form-group">
                            <label>Fecha de Expiración</label>
                            <input type="date" class="form-input" @bind="nuevoCupon.FechaExpiracion" min="@DateTime.Now.ToString("yyyy-MM-dd")" />
                            <small class="form-hint">Opcional: fecha límite de uso</small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-cancel" @onclick="CerrarModal">Cancelar</button>
                    <button class="btn-primary" @onclick="CrearCupon">Crear Cupón</button>
                </div>
            </div>
        </div>
    }

    @if (mostrarModalHistorial && cuponSeleccionado.HasValue)
    {
        <div class="modal-overlay" @onclick="CerrarModalHistorial">
            <div class="modal-content modal-large" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <h3>Historial de Uso del Cupón</h3>
                    <button class="btn-close" @onclick="CerrarModalHistorial">✕</button>
                </div>
                <div class="modal-body">
                    @if (cargandoHistorial)
                    {
                        <div class="loading-container">
                            <div class="spinner"></div>
                            <p>Cargando historial...</p>
                        </div>
                    }
                    else if (historialUso.Any())
                    {
                        <div class="historial-stats">
                            <div class="stat-item">
                                <span class="stat-label">Total de Usos</span>
                                <span class="stat-value">@historialUso.Count</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Descuento Total Aplicado</span>
                                <span class="stat-value">$@historialUso.Sum(h => h.DescuentoAplicado).ToString("N2")</span>
                            </div>
                        </div>
                        <div class="historial-table">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>ID Pedido</th>
                                        <th>Número Pedido</th>
                                        <th>Usuario</th>
                                        <th>Email</th>
                                        <th>Descuento</th>
                                        <th>Fecha Uso</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var uso in historialUso)
                                    {
                                        <tr class="table-row">
                                            <td class="invoice-id">#@uso.IdPedido</td>
                                            <td class="invoice-number">@uso.NumeroPedido</td>
                                            <td>@uso.NombreUsuario</td>
                                            <td class="user-email">@uso.CorreoUsuario</td>
                                            <td class="discount-amount">$@uso.DescuentoAplicado.ToString("N2")</td>
                                            <td class="invoice-date">@uso.FechaUso.ToString("dd/MM/yyyy HH:mm")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="empty-state">
                            <span class="empty-icon">📋</span>
                            <p>Este cupón aún no ha sido utilizado</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    }

    @if (mostrarMensaje)
    {
        <div class="toast-notification @tipoMensaje">
            <span>@(tipoMensaje == "success" ? "✅" : tipoMensaje == "error" ? "❌" : "ℹ️")</span>
            <span>@textoMensaje</span>
        </div>
    }
</div>


@code {
    private List<CuponDTO> cupones = new();
    private string searchTerm = "";
    private string filterEstado = "";
    private string filterTipo = "";
    private bool cargando = true;
    private string? mensajeError = null;
    private bool mostrarMensaje = false;
    private string textoMensaje = "";
    private string tipoMensaje = "success";
    private bool mostrarModalCrear = false;
    private bool mostrarModalHistorial = false;
    private bool cargandoHistorial = false;
    private int? cuponSeleccionado = null;
    private List<HistorialUsoCuponDTO> historialUso = new();
    private CrearCuponDTO nuevoCupon = new();
    private bool enviarEmailMasivo = false;

    protected override async Task OnInitializedAsync()
    {
        await CargarCupones();
    }

    private async Task CargarCupones()
    {
        try
        {
            cargando = true;
            mensajeError = null;
            StateHasChanged();

            var response = await CuponService.ObtenerTodosCupones();

            if (response.IsSuccess)
            {
                cupones = response.ListObject?.ToList() ?? new List<CuponDTO>();

                if (!cupones.Any())
                {
                    MostrarNotificacion("No hay cupones registrados en el sistema", "info");
                }
            }
            else
            {
                mensajeError = response.Message ?? "Error al cargar los cupones";
                MostrarNotificacion(mensajeError, "error");
            }
        }
        catch (Exception ex)
        {
            mensajeError = $"Error inesperado: {ex.Message}";
            MostrarNotificacion(mensajeError, "error");
        }
        finally
        {
            cargando = false;
            StateHasChanged();
        }
    }

    private IEnumerable<CuponDTO> CuponesFiltrados
    {
        get
        {
            var resultado = cupones.AsEnumerable();

            if (!string.IsNullOrWhiteSpace(searchTerm))
            {
                resultado = resultado.Where(c =>
                    c.Codigo.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                    c.Descripcion.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)
                );
            }

            if (!string.IsNullOrWhiteSpace(filterEstado))
            {
                resultado = resultado.Where(c => c.Estado.ToString() == filterEstado);
            }

            if (!string.IsNullOrWhiteSpace(filterTipo))
            {
                resultado = resultado.Where(c => c.TipoDescuento == filterTipo);
            }

            return resultado.OrderByDescending(c => c.FechaCreacion);
        }
    }

    private void MostrarModalCrear()
    {
        nuevoCupon = new CrearCuponDTO { TipoDescuento = "PORCENTAJE" };
        enviarEmailMasivo = false;
        mostrarModalCrear = true;
    }

    private void CerrarModal()
    {
        mostrarModalCrear = false;
    }

    private async Task CrearCupon()
    {
        var response = await CuponService.CrearCupon(nuevoCupon, enviarEmailMasivo);

        if (response.IsSuccess)
        {
            MostrarNotificacion("Cupón creado exitosamente", "success");
            CerrarModal();
            await CargarCupones();
        }
        else
        {
            MostrarNotificacion(response.Message ?? "Error al crear cupón", "error");
        }
    }

    private async Task VerHistorial(int idCupon)
    {
        cuponSeleccionado = idCupon;
        mostrarModalHistorial = true;
        cargandoHistorial = true;
        historialUso.Clear();
        StateHasChanged();

        var response = await CuponService.ObtenerHistorialUso(idCupon);

        if (response.IsSuccess)
        {
            historialUso = response.ListObject?.ToList() ?? new List<HistorialUsoCuponDTO>();
        }
        else
        {
            MostrarNotificacion(response.Message ?? "Error al cargar historial", "error");
        }

        cargandoHistorial = false;
        StateHasChanged();
    }

    private void CerrarModalHistorial()
    {
        mostrarModalHistorial = false;
        cuponSeleccionado = null;
        historialUso.Clear();
    }

    private async Task CopiarCodigo(string codigo)
    {
        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", codigo);
            MostrarNotificacion("Código copiado al portapapeles", "success");
        }
        catch (Exception)
        {
            MostrarNotificacion("Error al copiar código", "error");
        }
    }

    private async Task DesactivarCuponConfirm(int idCupon)
    {
        bool confirmed = await JS.InvokeAsync<bool>("confirm", "¿Está seguro de desactivar este cupón?");

        if (confirmed)
        {
            var response = await CuponService.DesactivarCupon(idCupon);

            if (response.IsSuccess)
            {
                MostrarNotificacion("Cupón desactivado exitosamente", "success");
                await CargarCupones();
            }
            else
            {
                MostrarNotificacion(response.Message ?? "Error al desactivar cupón", "error");
            }
        }
    }

    private void LimpiarFiltros()
    {
        searchTerm = "";
        filterEstado = "";
        filterTipo = "";
        StateHasChanged();
    }

    private void MostrarNotificacion(string mensaje, string tipo = "success")
    {
        textoMensaje = mensaje;
        tipoMensaje = tipo;
        mostrarMensaje = true;
        StateHasChanged();

        Task.Delay(3000).ContinueWith(_ =>
        {
            mostrarMensaje = false;
            InvokeAsync(StateHasChanged);
        });
    }
}
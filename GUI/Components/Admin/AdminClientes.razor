@page "/AdminClientes"
@using ENTITY.Usuarios
@using BLL.Interfaces
@using System.Text
@using ENTITY.Utilidades
@inject IJSRuntime JSRuntime
@inject IUsuarioService UsuarioService
@using QuestPDF.Fluent
@using QuestPDF.Helpers
@using QuestPDF.Infrastructure

<div class="container">

    <h2 class="page-title">Gestión de Usuarios</h2>

    <div class="content-card">
        <div class="filters-row">

            <div class="search-box">
                <input type="text" placeholder="Buscar por nombre, email o cédula..." class="search-input" @bind="searchTerm" @bind:event="oninput" />
            </div>

            <select class="filter-select" @bind="filterEstado">
                <option value="">Todos los estados</option>
                <option value="A">Activos</option>
                <option value="I">Inactivos</option>
            </select>

            <button class="btn-secondary" @onclick="ExportarUsuariosPDF">
                <span class="icon"><Icon Name="IconName.FileDownload" /></span>
                Exportar PDF
            </button>

        </div>

        <div class="stats-row">
            <div class="stat-item">
                <span class="stat-value">@usuarios.Count</span>
                <span class="stat-label">Total Usuarios</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">@usuarios.Count(u => u.Estado == "A")</span>
                <span class="stat-label">Activos</span>
            </div>
        </div>

        @if (cargando)
        {
            <div class="empty-state">
                <span class="empty-icon">⏳</span>
                <p>Cargando usuarios...</p>
            </div>
        }
        else
        {
            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Correo Electrónico</th>
                            <th>Celular</th>
                            <th>Estado</th>
                            <th>Fecha Registro</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var usuario in UsuariosFiltrados)
                        {
                            <tr class="table-row">

                                <td class="user-info">
                                    <div class="user-avatar">
                                        @GetIniciales(usuario.ObtenerNombreCompleto())
                                    </div>
                                    <div class="user-details">
                                        <div style="font-weight: 600; color: #1f2937;">@usuario.ObtenerNombreCompleto()</div>
                                    </div>
                                </td>

                                <td style="color: #6b7280">@usuario.Correo</td>
                                <td style="color: #6b7280;">@usuario.TelefonoPrincipal</td>

                                <td>
                                    <span class="status-badge @GetStatusClass(usuario.Estado)">
                                        @GetEstadoText(usuario.Estado)
                                    </span>
                                </td>

                                <td style="color: #6b7280;font-size: 13px;">@usuario.FechaRegistro.ToString("dd/MM/yyyy")</td>

                                <td>
                                    <button class="btn-action btn-toggle" @onclick="() => CambiarEstado(usuario)" title="@(usuario.Estado == "A" ? "Desactivar" : "Activar")">
                                        <span>
                                            @if (usuario.Estado == "A")
                                            {
                                                <Icon Name="IconName.Lock" />
                                            }
                                            else
                                            {
                                                <Icon Name="IconName.LockOpen" />
                                            }
                                        </span>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            @if (!UsuariosFiltrados.Any())
            {
                <div class="empty-state">
                    <span class="empty-icon">👥</span>
                    <p>No se encontraron usuarios</p>
                </div>
            }
        }
    </div>
</div>

@code {
    private List<UsuarioDTO> usuarios = new();
    private string searchTerm = "";
    private string filterEstado = "";
    private bool cargando = true;

    protected override async Task OnInitializedAsync()
    {
        QuestPDF.Settings.License = LicenseType.Community;
        await CargarUsuarios();
    }

    private async Task CargarUsuarios()
    {
        cargando = true;
        var resultado = await UsuarioService.ObtenerTodosLosUsuarios();

        if (resultado.IsSuccess)
        {
            usuarios = resultado.ListObject.ToList();
        }

        cargando = false;
    }

    private async Task ExportarUsuariosPDF()
    {
        try
        {
            var usuariosParaExportar = UsuariosFiltrados.ToList();

            if (!usuariosParaExportar.Any())
            {
                await JSRuntime.InvokeVoidAsync("alert", "No hay usuarios para exportar");
                return;
            }

            var document = Document.Create(container =>
            {
                container.Page(page =>
                {
                    page.Size(PageSizes.A4);
                    page.Margin(40);
                    page.DefaultTextStyle(x => x.FontSize(9).FontFamily("Arial"));

                    // Header
                    page.Header().Element(ComposeHeader);

                    // Content
                    page.Content().Element(container => ComposeContent(container, usuariosParaExportar));

                    // Footer
                    page.Footer().Element(ComposeFooter);
                });
            });

            var pdfBytes = document.GeneratePdf();
            var base64 = Convert.ToBase64String(pdfBytes);
            var fileName = $"Reporte_Usuarios_{DateTime.Now:yyyyMMdd_HHmmss}.pdf";

            await JSRuntime.InvokeVoidAsync("downloadFile", fileName, base64);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al exportar: {ex.Message}");
            await JSRuntime.InvokeVoidAsync("alert", $"Error al generar PDF: {ex.Message}");
        }
    }

    private void ComposeHeader(IContainer container)
    {
        container.Column(column =>
        {
            // Título y estadísticas
            column.Item().Row(row =>
            {
                row.RelativeItem().Column(col =>
                {
                    col.Item().Text("DIRECTORIO DE USUARIOS")
                        .FontSize(20)
                        .Bold()
                        .FontColor("#1e40af");

                    col.Item().PaddingTop(5).Text("Sistema de Gestión de Clientes")
                        .FontSize(10)
                        .FontColor("#64748b");

                    col.Item().PaddingTop(3).Text($"Generado el {DateTime.Now:dd/MM/yyyy HH:mm:ss}")
                        .FontSize(8)
                        .FontColor("#94a3b8");
                });

                row.ConstantItem(140).Column(col =>
                {
                    col.Item().Background("#f8fafc").Padding(12).Column(statsCol =>
                    {
                        statsCol.Item().Row(statsRow =>
                        {
                            statsRow.RelativeItem().Column(c =>
                            {
                                c.Item().Text("TOTAL").FontSize(8).FontColor("#64748b");
                                c.Item().Text(usuarios.Count.ToString())
                                    .FontSize(24).Bold();
                            });

                            statsRow.ConstantItem(60).Column(c =>
                            {
                                c.Item().Text("ACTIVOS").FontSize(8).FontColor("#64748b");
                                c.Item().Text(usuarios.Count(u => u.Estado == "A").ToString())
                                    .FontSize(24).Bold();
                            });
                        });
                    });
                });
            });

            // Línea divisoria
            column.Item().PaddingTop(15).PaddingBottom(10).LineHorizontal(2).LineColor("#e2e8f0");
        });
    }

    private void ComposeContent(IContainer container, List<UsuarioDTO> usuariosExportar)
    {
        container.PaddingTop(10).Column(column =>
        {
            // Resumen de estados
            column.Item().PaddingBottom(15).Background("#f8fafc").Padding(12).Row(row =>
            {
                row.RelativeItem().Column(col =>
                {
                    col.Item().Text("RESUMEN DE ESTADOS").FontSize(11).Bold().FontColor("#0f172a");
                    col.Item().PaddingTop(5).Row(summaryRow =>
                    {
                        summaryRow.RelativeItem().Column(c =>
                        {
                            c.Item().Text("Usuarios Activos").FontSize(8).FontColor("#64748b");
                            c.Item().Row(r =>
                            {
                                r.RelativeItem().PaddingLeft(5).Text($"{usuarios.Count(u => u.Estado == "A")} usuarios")
                                    .FontSize(11).Bold().FontColor("#10b981");
                            });
                        });

                        summaryRow.RelativeItem().Column(c =>
                        {
                            c.Item().Text("Usuarios Inactivos").FontSize(8).FontColor("#64748b");
                            c.Item().Row(r =>
                            {
                                r.RelativeItem().PaddingLeft(5).Text($"{usuarios.Count(u => u.Estado == "I")} usuarios")
                                    .FontSize(11).Bold().FontColor("#ef4444");
                            });
                        });

                        summaryRow.RelativeItem().Column(c =>
                        {
                            c.Item().Text("Tasa de Actividad").FontSize(8).FontColor("#64748b");
                            var tasaActividad = usuarios.Any() ? (usuarios.Count(u => u.Estado == "A") * 100.0 / usuarios.Count) : 0;
                            c.Item().Text($"{tasaActividad:F1}%")
                                .FontSize(14).Bold().FontColor("#1e40af");
                        });
                    });
                });
            });

            // Tabla de usuarios
            column.Item().Table(table =>
            {
                // Definir columnas con tamaños optimizados
                table.ColumnsDefinition(columns =>
                {
                    columns.RelativeColumn(2.2f);  // Nombre completo
                    columns.RelativeColumn(1f);    // Cédula
                    columns.RelativeColumn(2f);    // Correo
                    columns.RelativeColumn(1.2f);  // Teléfono
                    columns.RelativeColumn(0.8f);  // Estado
                    columns.RelativeColumn(1f);    // Fecha
                });

                // Header de tabla
                table.Header(header =>
                {
                    header.Cell().Element(CellStyle).Background("#1e40af").Padding(5)
                        .Text("NOMBRE").FontSize(7).Bold().FontColor("#ffffff");
                    header.Cell().Element(CellStyle).Background("#1e40af").Padding(5)
                        .Text("CÉDULA").FontSize(7).Bold().FontColor("#ffffff");
                    header.Cell().Element(CellStyle).Background("#1e40af").Padding(5)
                        .Text("CORREO").FontSize(7).Bold().FontColor("#ffffff");
                    header.Cell().Element(CellStyle).Background("#1e40af").Padding(5)
                        .Text("TELÉFONO").FontSize(7).Bold().FontColor("#ffffff");
                    header.Cell().Element(CellStyle).Background("#1e40af").Padding(5)
                        .Text("ESTADO").FontSize(7).Bold().FontColor("#ffffff");
                    header.Cell().Element(CellStyle).Background("#1e40af").Padding(5)
                        .Text("FECHA").FontSize(7).Bold().FontColor("#ffffff");
                });

                // Filas de datos
                var index = 0;
                foreach (var usuario in usuariosExportar)
                {
                    var backgroundColor = index % 2 == 0 ? "#ffffff" : "#f8fafc";

                    // Nombre con iniciales
                    table.Cell().Element(CellStyle).Background(backgroundColor).Padding(5).Row(row =>
                    {
                        row.ConstantItem(24).Height(24).Background("#e0e7ff")
                            .AlignCenter().AlignMiddle()
                            .Text(GetIniciales(usuario.ObtenerNombreCompleto()))
                            .FontSize(8).Bold().FontColor("#3730a3");

                        row.RelativeItem().PaddingLeft(5).AlignMiddle()
                            .Text(usuario.ObtenerNombreCompleto())
                            .FontSize(7.5f).Bold().FontColor("#0f172a");
                    });

                    // Cédula
                    table.Cell().Element(CellStyle).Background(backgroundColor).Padding(5)
                        .AlignMiddle().Text(usuario.Cedula ?? "N/A")
                        .FontSize(7).FontColor("#475569");

                    // Correo - truncar si es muy largo
                    var correo = usuario.Correo ?? "N/A";
                    if (correo.Length > 25)
                        correo = correo.Substring(0, 22) + "...";

                    table.Cell().Element(CellStyle).Background(backgroundColor).Padding(5)
                        .AlignMiddle().Text(correo)
                        .FontSize(7).FontColor("#475569");

                    // Teléfono
                    table.Cell().Element(CellStyle).Background(backgroundColor).Padding(5)
                        .AlignMiddle().Text(usuario.TelefonoPrincipal ?? "N/A")
                        .FontSize(7).FontColor("#475569");

                    // Estado con badge
                    var estadoColor = usuario.Estado == "A" ? "#10b981" : "#ef4444";
                    var estadoBgColor = usuario.Estado == "A" ? "#d1fae5" : "#fee2e2";
                    table.Cell().Element(CellStyle).Background(backgroundColor).Padding(5)
                        .AlignMiddle().AlignCenter().Column(col =>
                        {
                            col.Item().MaxWidth(50).Height(18)
                                .AlignCenter().AlignMiddle()
                                .Text(GetEstadoText(usuario.Estado))
                                .FontSize(6.5f).Bold().FontColor(estadoColor);
                        });

                    // Fecha
                    table.Cell().Element(CellStyle).Background(backgroundColor).Padding(5)
                        .AlignMiddle().Text(usuario.FechaRegistro.ToString("dd/MM/yy"))
                        .FontSize(7).FontColor("#64748b");

                    index++;
                }
            });
        });
    }

    private void ComposeFooter(IContainer container)
    {
        container.AlignBottom().Column(column =>
        {
            column.Item().LineHorizontal(1).LineColor("#e2e8f0");

            column.Item().PaddingTop(8).Row(row =>
            {
                row.RelativeItem().Column(col =>
                {
                    col.Item().Text("Sistema de Gestión de Usuarios")
                        .FontSize(8).Bold().FontColor("#475569");
                    col.Item().Text("Documento confidencial - Uso interno")
                        .FontSize(7).FontColor("#94a3b8");
                });

                row.RelativeItem().AlignRight().Text(page =>
                {
                    page.Span("Página ").FontSize(8).FontColor("#64748b");
                    page.CurrentPageNumber().FontSize(8).Bold().FontColor("#475569");
                    page.Span(" de ").FontSize(8).FontColor("#64748b");
                    page.TotalPages().FontSize(8).Bold().FontColor("#475569");
                });
            });
        });
    }

    private IContainer CellStyle(IContainer container)
    {
        return container.Border(0.5f).BorderColor("#e2e8f0");
    }

    private IEnumerable<UsuarioDTO> UsuariosFiltrados
    {
        get
        {
            var resultado = usuarios.AsEnumerable();
            if (!string.IsNullOrWhiteSpace(searchTerm))
            {
                resultado = resultado.Where(u =>
                    (u.ObtenerNombreCompleto() ?? "").Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                    (u.Correo ?? "").Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                    (u.Cedula ?? "").Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                    (u.TelefonoPrincipal ?? "").Contains(searchTerm, StringComparison.OrdinalIgnoreCase)
                );
            }
            if (!string.IsNullOrWhiteSpace(filterEstado))
            {
                resultado = resultado.Where(u => u.Estado == filterEstado);
            }
            return resultado.OrderByDescending(u => u.FechaRegistro);
        }
    }

    private string GetIniciales(string nombreCompleto)
    {
        var palabras = nombreCompleto.Split(' ', StringSplitOptions.RemoveEmptyEntries);

        if (palabras.Length >= 2)
            return $"{palabras[0][0]}{palabras[1][0]}".ToUpper();

        return palabras[0].Substring(0, Math.Min(2, palabras[0].Length)).ToUpper();
    }

    private async Task CambiarEstado(UsuarioDTO usuario)
    {
        var accion = usuario.Estado == "A" ? "desactivar" : "activar";

        var confirmado = await JSRuntime.InvokeAsync<bool>("confirm",
            $"¿Está seguro de {accion} al usuario {usuario.ObtenerNombreCompleto()}?");

        if (!confirmado)
            return;

        try
        {
            Response<bool> resultado;

            if (usuario.Estado == "A")
            {
                resultado = await UsuarioService.EliminarUsuario(usuario.Id);
            }
            else
            {
                usuario.Estado = "A";
                resultado = await UsuarioService.ActualizarUsuario(usuario);
            }

            if (resultado.IsSuccess)
            {
                await CargarUsuarios();
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert", $"Error: {resultado.Message}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
            await JSRuntime.InvokeVoidAsync("alert", "Error al cambiar el estado del usuario");
        }

        StateHasChanged();
    }

    private string GetStatusClass(string estado) => estado == "A" ? "activo" : "inactivo";
    private string GetEstadoText(string estado) => estado == "A" ? "Activo" : "Inactivo";
}

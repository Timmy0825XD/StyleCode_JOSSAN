@page "/AdminFacturas"
@using ENTITY.Facturas
@using ENTITY.Utilidades
@using BLL.Interfaces
@inject IFacturaService FacturaService
@inject IJSRuntime JS
@inject NavigationManager Navigation
@using ClosedXML.Excel

<div class="container">
    <div class="header-section">
        <h2 class="page-title">Gestión de Facturas Electrónicas</h2>
            <button class="btn-secondary" @onclick="ExportarFacturas">
            <span class="icon"><Icon Name="IconName.FileDownload" /></span>
                Exportar
            </button>
    </div>

    @if (cargando)
    {
        <div class="loading-container">
            <div class="spinner"></div>
            <p>Cargando facturas...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(mensajeError))
    {
        <div class="error-message">
            <span class="error-icon"><Icon Name="IconName.Alert" /></span>
            <span>@mensajeError</span>
            <button class="btn-retry" @onclick="CargarFacturas">Reintentar</button>
        </div>
    }
    else
    {
        <div class="content-card">
            <div class="stats-row">
                <div class="stat-card stat-total">
                    <span class="stat-icon"><Icon Name="IconName.Dashboard" /></span>
                    <div class="stat-info">
                        <span class="stat-label">Total Facturas</span>
                        <span class="stat-value">@facturas.Count</span>
                    </div>
                </div>
                <div class="stat-card stat-aprobadas">
                    <span class="stat-icon"><Icon Name="IconName.Check" /></span>
                    <div class="stat-info">
                        <span class="stat-label">Aprobadas</span>
                        <span class="stat-value">@facturas.Count(f => f.EstadoDian == "Aprobada")</span>
                    </div>
                </div>
                <div class="stat-card stat-pendientes">
                    <span class="stat-icon"><Icon Name="IconName.TimesCircle" /></span>
                    <div class="stat-info">
                        <span class="stat-label">Pendientes</span>
                        <span class="stat-value">@facturas.Count(f => f.EstadoDian != "Aprobada")</span>
                    </div>
                </div>
            </div>

            <div class="filters-row">
                <div class="search-box">
                    <input type="text"
                           placeholder="Buscar por número, CUFE o pedido..."
                           class="search-input"
                           @bind="searchTerm"
                           @bind:event="oninput" />
                </div>
                <div class="filter-group">
                    <select class="filter-select" @bind="filterEstado">
                        <option value="">Todos los estados</option>
                        <option value="Aprobada">Aprobadas DIAN</option>
                        <option value="Rechazada">Rechazadas</option>
                        <option value="Pendiente">Pendientes</option>
                    </select>
                    <input type="date" class="filter-date" @bind="filterFecha" />
                </div>
            </div>

            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Número Factura</th>
                            <th>Fecha Emisión</th>
                            <th>ID Pedido</th>
                            <th>Usuario</th>
                            <th>CUFE</th>
                            <th>Subtotal</th>
                            <th>IVA</th>
                            <th>Total</th>
                            <th>Estado DIAN</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (FacturasFiltradas.Any())
                        {
                            @foreach (var factura in FacturasFiltradas)
                            {
                                <tr class="table-row">
                                    <td class="invoice-id">#@factura.Id</td>
                                    <td class="invoice-number">@factura.NumeroFactura</td>
                                    <td class="invoice-date">@factura.FechaEmision.ToString("dd/MM/yyyy HH:mm")</td>
                                    <td class="pedido-id">PED-@factura.IdPedido</td>
                                    <td class="user-id">Usuario #@factura.IdUsuario</td>
                                    <td class="cufe-cell">
                                        @if (!string.IsNullOrEmpty(factura.Cufe))
                                        {
                                            <div class="cufe-container">
                                                <span class="cufe-text" title="@factura.Cufe">
                                                    @(factura.Cufe.Length > 25 ? factura.Cufe.Substring(0, 25) + "..." : factura.Cufe)
                                                </span>
                                                <button class="btn-copy-mini" @onclick="() => CopiarCUFE(factura.Cufe)" title="Copiar CUFE">
                                                    
                                                </button>
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="text-muted">N/A</span>
                                        }
                                    </td>
                                    <td class="invoice-amount">$@factura.Subtotal.ToString("N2")</td>
                                    <td class="invoice-tax">$@factura.Impuesto.ToString("N2")</td>
                                    <td class="invoice-total">$@factura.Total.ToString("N2")</td>
                                    <td>
                                        <span class="status-badge @GetEstadoClass(factura.EstadoDian)">
                                            @(string.IsNullOrEmpty(factura.EstadoDian) ? "Sin estado" : factura.EstadoDian)
                                        </span>
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            @if (!string.IsNullOrEmpty(factura.Cufe))
                                            {
                                                <button class="btn-action btn-dian"
                                                        @onclick="() => VerEnDIAN(factura.Cufe)"
                                                        title="Ver en DIAN">
                                                    <span><Icon Name="IconName.Store" /></span>
                                                </button>
                                            }
                                            @if (!string.IsNullOrEmpty(factura.Cufe))
                                            {
                                                <button class="btn-action btn-copy"
                                                        @onclick="() => CopiarCUFE(factura.Cufe)"
                                                        title="Copiar CUFE">
                                                    <span><Icon Name="IconName.File" /></span>
                                                </button>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>

            @if (!FacturasFiltradas.Any())
            {
                <div class="empty-state">
                    <span class="empty-icon">📄</span>
                    <p>No se encontraron facturas con los filtros aplicados</p>
                    @if (!string.IsNullOrEmpty(searchTerm) || !string.IsNullOrEmpty(filterEstado) || !string.IsNullOrEmpty(filterFechaStr))
                    {
                        <button class="btn-clear-filters" @onclick="LimpiarFiltros">Limpiar filtros</button>
                    }
                </div>
            }
        </div>
    }

    @if (mostrarMensaje)
    {
        <div class="toast-notification @tipoMensaje">
            <span>@(tipoMensaje == "success" ? "✅" : tipoMensaje == "error" ? "❌" : "ℹ️")</span>
            <span>@textoMensaje</span>
        </div>
    }
</div>

<style>

</style>

@code {
    private List<FacturaDTO> facturas = new();
    private string searchTerm = "";
    private string filterEstado = "";
    private string filterFechaStr = "";
    private bool cargando = true;
    private string? mensajeError = null;
    private bool mostrarMensaje = false;
    private string textoMensaje = "";
    private string tipoMensaje = "success";
    private bool mostrarQR = false;
    private FacturaDTO? facturaSeleccionada = null;
    private DateTime? filterFecha = null;

    protected override async Task OnInitializedAsync()
    {
        await CargarFacturas();
    }

    private async Task CargarFacturas()
    {
        try
        {
            cargando = true;
            mensajeError = null;
            StateHasChanged();

            var response = await FacturaService.ObtenerTodasFacturas();

            if (response.IsSuccess)
            {
                facturas = response.ListObject?.ToList() ?? new List<FacturaDTO>();

                if (!facturas.Any())
                {
                    MostrarNotificacion("No hay facturas registradas en el sistema", "info");
                }
            }
            else
            {
                mensajeError = response.Message ?? "Error al cargar las facturas";
                MostrarNotificacion(mensajeError, "error");
            }
        }
        catch (Exception ex)
        {
            mensajeError = $"Error inesperado: {ex.Message}";
            MostrarNotificacion(mensajeError, "error");
        }
        finally
        {
            cargando = false;
            StateHasChanged();
        }
    }

    private IEnumerable<FacturaDTO> FacturasFiltradas
    {
        get
        {
            var resultado = facturas.AsEnumerable();

            if (!string.IsNullOrWhiteSpace(searchTerm))
            {
                resultado = resultado.Where(f =>
                    f.NumeroFactura.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                    f.IdPedido.ToString().Contains(searchTerm) ||
                    (f.Cufe != null && f.Cufe.Contains(searchTerm, StringComparison.OrdinalIgnoreCase))
                );
            }

            if (!string.IsNullOrWhiteSpace(filterEstado))
            {
                resultado = resultado.Where(f =>
                    f.EstadoDian != null &&
                    f.EstadoDian.Equals(filterEstado, StringComparison.OrdinalIgnoreCase)
                );
            }

            if (filterFecha.HasValue)
            {
                resultado = resultado.Where(f => f.FechaEmision.Date == filterFecha.Value.Date);
            }

            return resultado.OrderByDescending(f => f.FechaEmision);
        }
    }

    private async Task CopiarCUFE(string? cufe)
    {
        if (string.IsNullOrEmpty(cufe))
        {
            MostrarNotificacion("No hay CUFE disponible para copiar", "error");
            return;
        }

        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", cufe);
            MostrarNotificacion("CUFE copiado al portapapeles", "success");
        }
        catch (Exception)
        {
            MostrarNotificacion("Error al copiar CUFE", "error");
        }
    }

    private void VerEnDIAN(string? cufe)
    {
        if (string.IsNullOrEmpty(cufe))
        {
            MostrarNotificacion("No hay CUFE disponible", "error");
            return;
        }

        var url = $"https://catalogo-vpfe-hab.dian.gov.co/User/SearchDocument?documentkey={cufe}";
        Navigation.NavigateTo(url, true);
    }

    private void LimpiarFiltros()
    {
        searchTerm = "";
        filterEstado = "";
        filterFecha = null;
        StateHasChanged();
    }

    private async Task ExportarFacturas()
    {
        try
        {
            var facturasParaExportar = FacturasFiltradas.ToList();

            if (!facturasParaExportar.Any())
            {
                MostrarNotificacion("No hay facturas para exportar", "error");
                return;
            }

            using var workbook = new XLWorkbook();

            var worksheet = workbook.Worksheets.Add("Facturas");

            var headerRange = worksheet.Range("A1:J1");
            headerRange.Style.Font.Bold = true;
            headerRange.Style.Fill.BackgroundColor = XLColor.FromHtml("#4F46E5");
            headerRange.Style.Font.FontColor = XLColor.White;
            headerRange.Style.Alignment.Horizontal = XLAlignmentHorizontalValues.Center;

            worksheet.Cell(1, 1).Value = "ID";
            worksheet.Cell(1, 2).Value = "Número Factura";
            worksheet.Cell(1, 3).Value = "Fecha Emisión";
            worksheet.Cell(1, 4).Value = "ID Pedido";
            worksheet.Cell(1, 5).Value = "ID Usuario";
            worksheet.Cell(1, 6).Value = "CUFE";
            worksheet.Cell(1, 7).Value = "Subtotal";
            worksheet.Cell(1, 8).Value = "IVA";
            worksheet.Cell(1, 9).Value = "Total";
            worksheet.Cell(1, 10).Value = "Estado DIAN";

            int row = 2;
            foreach (var factura in facturasParaExportar)
            {
                worksheet.Cell(row, 1).Value = factura.Id;
                worksheet.Cell(row, 2).Value = factura.NumeroFactura;
                worksheet.Cell(row, 3).Value = factura.FechaEmision.ToString("dd/MM/yyyy HH:mm");
                worksheet.Cell(row, 4).Value = $"PED-{factura.IdPedido}";
                worksheet.Cell(row, 5).Value = factura.IdUsuario;
                worksheet.Cell(row, 6).Value = factura.Cufe ?? "N/A";
                worksheet.Cell(row, 7).Value = factura.Subtotal;
                worksheet.Cell(row, 8).Value = factura.Impuesto;
                worksheet.Cell(row, 9).Value = factura.Total;
                worksheet.Cell(row, 10).Value = string.IsNullOrEmpty(factura.EstadoDian) ? "Sin estado" : factura.EstadoDian;

                worksheet.Cell(row, 7).Style.NumberFormat.Format = "$#,##0.00";
                worksheet.Cell(row, 8).Style.NumberFormat.Format = "$#,##0.00";
                worksheet.Cell(row, 9).Style.NumberFormat.Format = "$#,##0.00";

                var estadoCell = worksheet.Cell(row, 10);
                if (factura.EstadoDian?.ToLower() == "aprobada")
                {
                    estadoCell.Style.Font.FontColor = XLColor.FromHtml("#10B981");
                    estadoCell.Style.Font.Bold = true;
                }
                else if (factura.EstadoDian?.ToLower() == "rechazada")
                {
                    estadoCell.Style.Font.FontColor = XLColor.FromHtml("#EF4444");
                    estadoCell.Style.Font.Bold = true;
                }
                else
                {
                    estadoCell.Style.Font.FontColor = XLColor.FromHtml("#F59E0B");
                }

                row++;
            }

            worksheet.Columns().AdjustToContents();

            worksheet.RangeUsed().SetAutoFilter();

            var resumenSheet = workbook.Worksheets.Add("Resumen");

            resumenSheet.Cell(1, 1).Value = "Resumen de Facturas Electrónicas";
            resumenSheet.Cell(1, 1).Style.Font.Bold = true;
            resumenSheet.Cell(1, 1).Style.Font.FontSize = 16;
            resumenSheet.Range("A1:B1").Merge();

            resumenSheet.Cell(3, 1).Value = "Métrica";
            resumenSheet.Cell(3, 2).Value = "Valor";
            var resumenHeader = resumenSheet.Range("A3:B3");
            resumenHeader.Style.Font.Bold = true;
            resumenHeader.Style.Fill.BackgroundColor = XLColor.FromHtml("#E5E7EB");

            resumenSheet.Cell(4, 1).Value = "Total Facturas";
            resumenSheet.Cell(4, 2).Value = facturas.Count;

            resumenSheet.Cell(5, 1).Value = "Facturas Aprobadas";
            resumenSheet.Cell(5, 2).Value = facturas.Count(f => f.EstadoDian == "Aprobada");
            resumenSheet.Cell(5, 2).Style.Font.FontColor = XLColor.FromHtml("#10B981");

            resumenSheet.Cell(6, 1).Value = "Facturas Pendientes";
            resumenSheet.Cell(6, 2).Value = facturas.Count(f => f.EstadoDian != "Aprobada");
            resumenSheet.Cell(6, 2).Style.Font.FontColor = XLColor.FromHtml("#F59E0B");

            resumenSheet.Cell(8, 1).Value = "Subtotal Acumulado";
            resumenSheet.Cell(8, 2).Value = facturas.Sum(f => f.Subtotal);
            resumenSheet.Cell(8, 2).Style.NumberFormat.Format = "$#,##0.00";

            resumenSheet.Cell(9, 1).Value = "IVA Total";
            resumenSheet.Cell(9, 2).Value = facturas.Sum(f => f.Impuesto);
            resumenSheet.Cell(9, 2).Style.NumberFormat.Format = "$#,##0.00";

            resumenSheet.Cell(10, 1).Value = "Total General";
            resumenSheet.Cell(10, 2).Value = facturas.Sum(f => f.Total);
            resumenSheet.Cell(10, 2).Style.NumberFormat.Format = "$#,##0.00";
            resumenSheet.Cell(10, 2).Style.Font.Bold = true;

            resumenSheet.Cell(12, 1).Value = "Fecha de Exportación";
            resumenSheet.Cell(12, 2).Value = DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss");

            resumenSheet.Columns().AdjustToContents();

            using var stream = new MemoryStream();
            workbook.SaveAs(stream);
            var bytes = stream.ToArray();
            var base64 = Convert.ToBase64String(bytes);
            var fileName = $"facturas_{DateTime.Now:yyyyMMdd_HHmmss}.xlsx";

            await JS.InvokeVoidAsync("downloadFile", fileName, base64);

            MostrarNotificacion($"Se exportaron {facturasParaExportar.Count} facturas correctamente", "success");
        }
        catch (Exception ex)
        {
            MostrarNotificacion($"Error al exportar: {ex.Message}", "error");
        }
    }

    private void MostrarNotificacion(string mensaje, string tipo = "success")
    {
        textoMensaje = mensaje;
        tipoMensaje = tipo;
        mostrarMensaje = true;
        StateHasChanged();

        Task.Delay(3000).ContinueWith(_ =>
        {
            mostrarMensaje = false;
            InvokeAsync(StateHasChanged);
        });
    }

    private string GetEstadoClass(string? estado)
    {
        if (string.IsNullOrEmpty(estado))
            return "default";

        return estado.ToLower() switch
        {
            "aprobada" => "aprobada",
            "rechazada" => "rechazada",
            "pendiente" => "pendiente",
            _ => "default"
        };
    }
}

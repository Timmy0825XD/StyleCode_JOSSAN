@page "/AdminFacturas"
@using ENTITY.Facturas
@using ENTITY.Utilidades
@using BLL.Interfaces
@inject IFacturaService FacturaService
@inject IJSRuntime JS
@inject NavigationManager Navigation
@using QuestPDF.Fluent
@using QuestPDF.Helpers
@using QuestPDF.Infrastructure

<div class="container">
    <div class="header-section">
        <h2 class="page-title">Gestión de Facturas Electrónicas</h2>
        <button class="btn-secondary" @onclick="ExportarFacturasPDF">
            <span class="icon"><Icon Name="IconName.FileDownload" /></span>
            Exportar PDF
        </button>
    </div>

    @if (cargando)
    {
        <div class="loading-container">
            <div class="spinner"></div>
            <p>Cargando facturas...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(mensajeError))
    {
        <div class="error-message">
            <span class="error-icon"><Icon Name="IconName.Alert" /></span>
            <span>@mensajeError</span>
            <button class="btn-retry" @onclick="CargarFacturas">Reintentar</button>
        </div>
    }
    else
    {
        <div class="content-card">
            <div class="stats-row">
                <div class="stat-card stat-total">
                    <span class="stat-icon"><Icon Name="IconName.Dashboard" /></span>
                    <div class="stat-info">
                        <span class="stat-label">Total Facturas</span>
                        <span class="stat-value">@facturas.Count</span>
                    </div>
                </div>
                <div class="stat-card stat-aprobadas">
                    <span class="stat-icon"><Icon Name="IconName.Check" /></span>
                    <div class="stat-info">
                        <span class="stat-label">Aprobadas</span>
                        <span class="stat-value">@facturas.Count(f => f.EstadoDian == "Aprobada")</span>
                    </div>
                </div>
                <div class="stat-card stat-pendientes">
                    <span class="stat-icon"><Icon Name="IconName.TimesCircle" /></span>
                    <div class="stat-info">
                        <span class="stat-label">Pendientes</span>
                        <span class="stat-value">@facturas.Count(f => f.EstadoDian != "Aprobada")</span>
                    </div>
                </div>
            </div>

            <div class="filters-row">
                <div class="search-box">
                    <input type="text"
                           placeholder="Buscar por número, CUFE o pedido..."
                           class="search-input"
                           @bind="searchTerm"
                           @bind:event="oninput" />
                </div>
                <div class="filter-group">
                    <select class="filter-select" @bind="filterEstado">
                        <option value="">Todos los estados</option>
                        <option value="Aprobada">Aprobadas DIAN</option>
                        <option value="Rechazada">Rechazadas</option>
                        <option value="Pendiente">Pendientes</option>
                    </select>
                    <input type="date" class="filter-date" @bind="filterFecha" />
                </div>
            </div>

            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Número Factura</th>
                            <th>Fecha Emisión</th>
                            <th>ID Pedido</th>
                            <th>Usuario</th>
                            <th>CUFE</th>
                            <th>Subtotal</th>
                            <th>IVA</th>
                            <th>Total</th>
                            <th>Estado DIAN</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (FacturasFiltradas.Any())
                        {
                            @foreach (var factura in FacturasFiltradas)
                            {
                                <tr class="table-row">
                                    <td class="invoice-id">#@factura.Id</td>
                                    <td class="invoice-number">@factura.NumeroFactura</td>
                                    <td class="invoice-date">@factura.FechaEmision.ToString("dd/MM/yyyy HH:mm")</td>
                                    <td class="pedido-id">PED-@factura.IdPedido</td>
                                    <td class="user-id">Usuario #@factura.IdUsuario</td>
                                    <td class="cufe-cell">
                                        @if (!string.IsNullOrEmpty(factura.Cufe))
                                        {
                                            <div class="cufe-container">
                                                <span class="cufe-text" title="@factura.Cufe">
                                                    @(factura.Cufe.Length > 25 ? factura.Cufe.Substring(0, 25) + "..." : factura.Cufe)
                                                </span>
                                                <button class="btn-copy-mini" @onclick="() => CopiarCUFE(factura.Cufe)" title="Copiar CUFE">
                                                </button>
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="text-muted">N/A</span>
                                        }
                                    </td>
                                    <td class="invoice-amount">$@factura.Subtotal.ToString("N2")</td>
                                    <td class="invoice-tax">$@factura.Impuesto.ToString("N2")</td>
                                    <td class="invoice-total">$@factura.Total.ToString("N2")</td>
                                    <td>
                                        <span class="status-badge @GetEstadoClass(factura.EstadoDian)">
                                            @(string.IsNullOrEmpty(factura.EstadoDian) ? "Sin estado" : factura.EstadoDian)
                                        </span>
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            @if (!string.IsNullOrEmpty(factura.Cufe))
                                            {
                                                <button class="btn-action btn-dian"
                                                        @onclick="() => VerEnDIAN(factura.Cufe)"
                                                        title="Ver en DIAN">
                                                    <span><Icon Name="IconName.Store" /></span>
                                                </button>
                                            }
                                            @if (!string.IsNullOrEmpty(factura.Cufe))
                                            {
                                                <button class="btn-action btn-copy"
                                                        @onclick="() => CopiarCUFE(factura.Cufe)"
                                                        title="Copiar CUFE">
                                                    <span><Icon Name="IconName.File" /></span>
                                                </button>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>

            @if (!FacturasFiltradas.Any())
            {
                <div class="empty-state">
                    <span class="empty-icon">📄</span>
                    <p>No se encontraron facturas con los filtros aplicados</p>
                    @if (!string.IsNullOrEmpty(searchTerm) || !string.IsNullOrEmpty(filterEstado) || !string.IsNullOrEmpty(filterFechaStr))
                    {
                        <button class="btn-clear-filters" @onclick="LimpiarFiltros">Limpiar filtros</button>
                    }
                </div>
            }
        </div>
    }

    @if (mostrarMensaje)
    {
        <div class="toast-notification @tipoMensaje">
            <span>@(tipoMensaje == "success" ? "✅" : tipoMensaje == "error" ? "❌" : "ℹ️")</span>
            <span>@textoMensaje</span>
        </div>
    }
</div>

<style>

</style>

@code {
    private List<FacturaDTO> facturas = new();
    private string searchTerm = "";
    private string filterEstado = "";
    private string filterFechaStr = "";
    private bool cargando = true;
    private string? mensajeError = null;
    private bool mostrarMensaje = false;
    private string textoMensaje = "";
    private string tipoMensaje = "success";
    private bool mostrarQR = false;
    private FacturaDTO? facturaSeleccionada = null;
    private DateTime? filterFecha = null;

    protected override async Task OnInitializedAsync()
    {
        QuestPDF.Settings.License = LicenseType.Community;
        await CargarFacturas();
    }

    private async Task CargarFacturas()
    {
        try
        {
            cargando = true;
            mensajeError = null;
            StateHasChanged();

            var response = await FacturaService.ObtenerTodasFacturas();

            if (response.IsSuccess)
            {
                facturas = response.ListObject?.ToList() ?? new List<FacturaDTO>();

                if (!facturas.Any())
                {
                    MostrarNotificacion("No hay facturas registradas en el sistema", "info");
                }
            }
            else
            {
                mensajeError = response.Message ?? "Error al cargar las facturas";
                MostrarNotificacion(mensajeError, "error");
            }
        }
        catch (Exception ex)
        {
            mensajeError = $"Error inesperado: {ex.Message}";
            MostrarNotificacion(mensajeError, "error");
        }
        finally
        {
            cargando = false;
            StateHasChanged();
        }
    }

    private IEnumerable<FacturaDTO> FacturasFiltradas
    {
        get
        {
            var resultado = facturas.AsEnumerable();

            if (!string.IsNullOrWhiteSpace(searchTerm))
            {
                resultado = resultado.Where(f =>
                    f.NumeroFactura.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                    f.IdPedido.ToString().Contains(searchTerm) ||
                    (f.Cufe != null && f.Cufe.Contains(searchTerm, StringComparison.OrdinalIgnoreCase))
                );
            }

            if (!string.IsNullOrWhiteSpace(filterEstado))
            {
                resultado = resultado.Where(f =>
                    f.EstadoDian != null &&
                    f.EstadoDian.Equals(filterEstado, StringComparison.OrdinalIgnoreCase)
                );
            }

            if (filterFecha.HasValue)
            {
                resultado = resultado.Where(f => f.FechaEmision.Date == filterFecha.Value.Date);
            }

            return resultado.OrderByDescending(f => f.FechaEmision);
        }
    }

    private async Task CopiarCUFE(string? cufe)
    {
        if (string.IsNullOrEmpty(cufe))
        {
            MostrarNotificacion("No hay CUFE disponible para copiar", "error");
            return;
        }

        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", cufe);
            MostrarNotificacion("CUFE copiado al portapapeles", "success");
        }
        catch (Exception)
        {
            MostrarNotificacion("Error al copiar CUFE", "error");
        }
    }

    private void VerEnDIAN(string? cufe)
    {
        if (string.IsNullOrEmpty(cufe))
        {
            MostrarNotificacion("No hay CUFE disponible", "error");
            return;
        }

        var url = $"https://catalogo-vpfe-hab.dian.gov.co/User/SearchDocument?documentkey={cufe}";
        Navigation.NavigateTo(url, true);
    }

    private void LimpiarFiltros()
    {
        searchTerm = "";
        filterEstado = "";
        filterFecha = null;
        StateHasChanged();
    }

    private async Task ExportarFacturasPDF()
    {
        try
        {
            var facturasParaExportar = FacturasFiltradas.ToList();

            if (!facturasParaExportar.Any())
            {
                MostrarNotificacion("No hay facturas para exportar", "error");
                return;
            }

            var document = Document.Create(container =>
            {
                container.Page(page =>
                {
                    page.Size(PageSizes.A4.Landscape());
                    page.Margin(40);
                    page.DefaultTextStyle(x => x.FontSize(9).FontFamily("Arial"));

                    // Header
                    page.Header().Element(ComposeHeader);

                    // Content
                    page.Content().Element(container => ComposeContent(container, facturasParaExportar));

                    // Footer
                    page.Footer().Element(ComposeFooter);
                });
            });

            var pdfBytes = document.GeneratePdf();
            var base64 = Convert.ToBase64String(pdfBytes);
            var fileName = $"Reporte_Facturas_{DateTime.Now:yyyyMMdd_HHmmss}.pdf";

            await JS.InvokeVoidAsync("downloadFile", fileName, base64);

            MostrarNotificacion($"PDF generado exitosamente con {facturasParaExportar.Count} facturas", "success");
        }
        catch (Exception ex)
        {
            MostrarNotificacion($"Error al generar PDF: {ex.Message}", "error");
        }
    }

    private void ComposeHeader(IContainer container)
    {
        container.Column(column =>
        {
            // Logo y título principal
            column.Item().Row(row =>
            {
                row.RelativeItem().Column(col =>
                {
                    col.Item().Text("REPORTE DE FACTURAS ELECTRÓNICAS")
                        .FontSize(18)
                        .Bold()
                        .FontColor("#1e40af");

                    col.Item().PaddingTop(5).Text($"Generado el {DateTime.Now:dd/MM/yyyy HH:mm:ss}")
                        .FontSize(9)
                        .FontColor("#64748b");
                });

                row.ConstantItem(120).AlignRight().Column(col =>
                {
                    col.Item().Background("#f1f5f9").Padding(8).Column(statsCol =>
                    {
                        statsCol.Item().Text("Estadísticas").FontSize(8).Bold().FontColor("#475569");
                        statsCol.Item().PaddingTop(3).Text($"Total: {facturas.Count}").FontSize(8);
                        statsCol.Item().Text($"Aprobadas: {facturas.Count(f => f.EstadoDian == "Aprobada")}")
                            .FontSize(8).FontColor("#10b981");
                    });
                });
            });

            // Línea divisoria
            column.Item().PaddingTop(15).PaddingBottom(10).LineHorizontal(2).LineColor("#e2e8f0");
        });
    }

    private void ComposeContent(IContainer container, List<FacturaDTO> facturasExportar)
    {
        container.PaddingTop(10).Column(column =>
        {
            // Resumen ejecutivo
            column.Item().PaddingBottom(15).Background("#f8fafc").Padding(12).Row(row =>
            {
                row.RelativeItem().Column(col =>
                {
                    col.Item().Text("RESUMEN FINANCIERO").FontSize(11).Bold().FontColor("#0f172a");
                    col.Item().PaddingTop(5).Row(summaryRow =>
                    {
                        summaryRow.RelativeItem().Column(c =>
                        {
                            c.Item().Text("Subtotal Acumulado").FontSize(8).FontColor("#64748b");
                            c.Item().Text($"${facturas.Sum(f => f.Subtotal):N2}")
                                .FontSize(12).Bold().FontColor("#0f172a");
                        });

                        summaryRow.RelativeItem().Column(c =>
                        {
                            c.Item().Text("IVA Total").FontSize(8).FontColor("#64748b");
                            c.Item().Text($"${facturas.Sum(f => f.Impuesto):N2}")
                                .FontSize(12).Bold().FontColor("#0f172a");
                        });

                        summaryRow.RelativeItem().Column(c =>
                        {
                            c.Item().Text("Total General").FontSize(8).FontColor("#64748b");
                            c.Item().Text($"${facturas.Sum(f => f.Total):N2}")
                                .FontSize(13).Bold().FontColor("#1e40af");
                        });
                    });
                });
            });

            // Tabla de facturas
            column.Item().Table(table =>
            {
                // Definir columnas
                table.ColumnsDefinition(columns =>
                {
                    columns.ConstantColumn(35);  // ID
                    columns.RelativeColumn(1.2f); // Número
                    columns.RelativeColumn(1.2f); // Fecha
                    columns.RelativeColumn(0.8f); // Pedido
                    columns.RelativeColumn(0.8f); // Usuario
                    columns.RelativeColumn(2f);   // CUFE
                    columns.RelativeColumn(0.9f); // Subtotal
                    columns.RelativeColumn(0.9f); // IVA
                    columns.RelativeColumn(1f);   // Total
                    columns.RelativeColumn(0.9f); // Estado
                });

                // Header de tabla
                table.Header(header =>
                {
                    header.Cell().Element(CellStyle).Background("#1e40af").Padding(6)
                        .Text("ID").FontSize(8).Bold().FontColor("#ffffff");
                    header.Cell().Element(CellStyle).Background("#1e40af").Padding(6)
                        .Text("N° Factura").FontSize(8).Bold().FontColor("#ffffff");
                    header.Cell().Element(CellStyle).Background("#1e40af").Padding(6)
                        .Text("Fecha Emisión").FontSize(8).Bold().FontColor("#ffffff");
                    header.Cell().Element(CellStyle).Background("#1e40af").Padding(6)
                        .Text("Pedido").FontSize(8).Bold().FontColor("#ffffff");
                    header.Cell().Element(CellStyle).Background("#1e40af").Padding(6)
                        .Text("Usuario").FontSize(8).Bold().FontColor("#ffffff");
                    header.Cell().Element(CellStyle).Background("#1e40af").Padding(6)
                        .Text("CUFE").FontSize(8).Bold().FontColor("#ffffff");
                    header.Cell().Element(CellStyle).Background("#1e40af").Padding(6)
                        .Text("Subtotal").FontSize(8).Bold().FontColor("#ffffff");
                    header.Cell().Element(CellStyle).Background("#1e40af").Padding(6)
                        .Text("IVA").FontSize(8).Bold().FontColor("#ffffff");
                    header.Cell().Element(CellStyle).Background("#1e40af").Padding(6)
                        .Text("Total").FontSize(8).Bold().FontColor("#ffffff");
                    header.Cell().Element(CellStyle).Background("#1e40af").Padding(6)
                        .Text("Estado").FontSize(8).Bold().FontColor("#ffffff");
                });

                // Filas de datos
                var index = 0;
                foreach (var factura in facturasExportar)
                {
                    var backgroundColor = index % 2 == 0 ? "#ffffff" : "#f8fafc";

                    table.Cell().Element(CellStyle).Background(backgroundColor).Padding(6)
                        .Text($"#{factura.Id}").FontSize(8);
                    table.Cell().Element(CellStyle).Background(backgroundColor).Padding(6)
                        .Text(factura.NumeroFactura).FontSize(8).Bold();
                    table.Cell().Element(CellStyle).Background(backgroundColor).Padding(6)
                        .Text(factura.FechaEmision.ToString("dd/MM/yyyy HH:mm")).FontSize(7);
                    table.Cell().Element(CellStyle).Background(backgroundColor).Padding(6)
                        .Text($"PED-{factura.IdPedido}").FontSize(8);
                    table.Cell().Element(CellStyle).Background(backgroundColor).Padding(6)
                        .Text($"{factura.IdUsuario}").FontSize(8);
                    table.Cell().Element(CellStyle).Background(backgroundColor).Padding(6)
                        .Text(factura.Cufe?.Length > 35 ? factura.Cufe.Substring(0, 35) + "..." : factura.Cufe ?? "N/A")
                        .FontSize(6).FontColor("#64748b");
                    table.Cell().Element(CellStyle).Background(backgroundColor).Padding(6)
                        .AlignRight().Text($"${factura.Subtotal:N2}").FontSize(8);
                    table.Cell().Element(CellStyle).Background(backgroundColor).Padding(6)
                        .AlignRight().Text($"${factura.Impuesto:N2}").FontSize(8);
                    table.Cell().Element(CellStyle).Background(backgroundColor).Padding(6)
                        .AlignRight().Text($"${factura.Total:N2}").FontSize(8).Bold();

                    var estadoColor = GetEstadoColor(factura.EstadoDian);
                    table.Cell().Element(CellStyle).Background(backgroundColor).Padding(6)
                        .Text(string.IsNullOrEmpty(factura.EstadoDian) ? "Sin estado" : factura.EstadoDian)
                        .FontSize(7).Bold().FontColor(estadoColor);

                    index++;
                }
            });
        });
    }

    private void ComposeFooter(IContainer container)
    {
        container.AlignBottom().Column(column =>
        {
            column.Item().LineHorizontal(1).LineColor("#e2e8f0");

            column.Item().PaddingTop(5).Row(row =>
            {
                row.RelativeItem().Text(text =>
                {
                    text.Span("Sistema de Facturación Electrónica").FontSize(8).FontColor("#64748b");
                    text.Span(" | ").FontSize(8).FontColor("#cbd5e1");
                    text.Span("Generado automáticamente").FontSize(8).FontColor("#64748b");
                });

                row.RelativeItem().AlignRight().Text(page =>
                {
                    page.Span("Página ").FontSize(8).FontColor("#64748b");
                    page.CurrentPageNumber().FontSize(8).Bold().FontColor("#475569");
                    page.Span(" de ").FontSize(8).FontColor("#64748b");
                    page.TotalPages().FontSize(8).Bold().FontColor("#475569");
                });
            });
        });
    }

    private IContainer CellStyle(IContainer container)
    {
        return container.Border(0.5f).BorderColor("#e2e8f0");
    }

    private string GetEstadoColor(string? estado)
    {
        if (string.IsNullOrEmpty(estado))
            return "#94a3b8";

        return estado.ToLower() switch
        {
            "aprobada" => "#10b981",
            "rechazada" => "#ef4444",
            "pendiente" => "#f59e0b",
            _ => "#94a3b8"
        };
    }

    private void MostrarNotificacion(string mensaje, string tipo = "success")
    {
        textoMensaje = mensaje;
        tipoMensaje = tipo;
        mostrarMensaje = true;
        StateHasChanged();

        Task.Delay(3000).ContinueWith(_ =>
        {
            mostrarMensaje = false;
            InvokeAsync(StateHasChanged);
        });
    }

    private string GetEstadoClass(string? estado)
    {
        if (string.IsNullOrEmpty(estado))
            return "default";

        return estado.ToLower() switch
        {
            "aprobada" => "aprobada",
            "rechazada" => "rechazada",
            "pendiente" => "pendiente",
            _ => "default"
        };
    }
}

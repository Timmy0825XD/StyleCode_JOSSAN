@page "/AdminPedidos"
@using System.Collections.Generic
@using ENTITY.Pedidos
@using BLL.Interfaces
@using GUI.Components.Admin
@using System.Text
@inject IJSRuntime JSRuntime
@inject IFacturaService FacturaService
@inject IPedidoService PedidoService
@inject NavigationManager Navigation
@using QuestPDF.Fluent
@using QuestPDF.Helpers
@using QuestPDF.Infrastructure

<div class="container">
    <div class="header-section">
        <h2 class="page-title">Gestión de Pedidos</h2>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="error-alert">
            <p>@errorMessage</p>
        </div>
    }
    else
    {
        <div class="content-card">
            <div class="filters-row">
                <div class="search-box">
                    <input type="text"
                           placeholder="Buscar pedidos..."
                           class="search-input"
                           @bind="searchTerm"
                           @bind:event="oninput" />
                </div>
                <div class="filter-group">
                    <select class="filter-select" @bind="filterStatus">
                        <option value="">Todos los estados</option>
                        <option value="Pendiente">Pendiente</option>
                        <option value="Confirmado">Confirmado</option>
                        <option value="Enviado">Enviado</option>
                        <option value="Entregado">Entregado</option>
                        <option value="Cancelado">Cancelado</option>
                    </select>
                    <input type="date" class="filter-date" @bind="filterDate" @bind:format="yyyy-MM-dd" />
                </div>
                <button class="btn-secondary" @onclick="ExportarPedidosPDF">
                    <span class="icon"><Icon Name="IconName.FileDownload" /></span>
                    Exportar PDF
                </button>
            </div>

            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Número Pedido</th>
                            <th>Cliente</th>
                            <th>Fecha</th>
                            <th>Total</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var pedido in PedidosFiltrados)
                        {
                            <tr class="table-row">
                                <td class="order-id">@pedido.NumeroPedido</td>
                                <td class="customer-info">
                                    <div class="customer-name">@pedido.NombreCliente</div>
                                    <div class="customer-email">@pedido.CorreoCliente</div>
                                </td>
                                <td class="order-date">@pedido.FechaPedido.ToString("dd/MM/yyyy HH:mm")</td>
                                <td class="order-total">@pedido.Total.ToString("C")</td>
                                <td>
                                    <select class="status-select @GetStatusClass(pedido.Estado)"
                                            @onchange="@((e) => CambiarEstado(pedido, e.Value.ToString()))">
                                        <option value="Pendiente" selected="@(pedido.Estado == "Pendiente")">Pendiente</option>
                                        <option value="Confirmado" selected="@(pedido.Estado == "Confirmado")">Confirmado</option>
                                        <option value="Enviado" selected="@(pedido.Estado == "Enviado")">Enviado</option>
                                        <option value="Entregado" selected="@(pedido.Estado == "Entregado")">Entregado</option>
                                        <option value="Cancelado" selected="@(pedido.Estado == "Cancelado")">Cancelado</option>
                                    </select>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn-action btn-view" @onclick="() => VerDetalles(pedido)" title="Ver Detalles">
                                            <Icon Name="IconName.Eye" />
                                        </button>
                                        <button class="btn btn-factura"
                                                @onclick="() => AbrirModalFactura(pedido.IdPedido)"
                                                disabled="@(pedido.Estado == "Cancelado")">
                                            <Icon Name="IconName.File" /> Generar Factura
                                        </button>
                                        <button class="btn-action btn-delete" @onclick="() => CancelarPedido(pedido)" title="Cancelar">
                                            <Icon Name="IconName.Delete" />
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            @if (!PedidosFiltrados.Any())
            {
                <div class="empty-state">
                    <span class="empty-icon"><i class="fa-solid fa-box"></i></span>
                    <p>No se encontraron pedidos</p>
                </div>
            }
        </div>
    }

    @if (mostrarDetalles && pedidoSeleccionado != null)
    {
        <div class="modal-overlay" @onclick="CerrarDetalles">
            <div class="modal-content" @onclick:stopPropagation>
                <div class="modal-header">
                    <h3>Detalles del Pedido @pedidoSeleccionado.NumeroPedido</h3>
                    <button class="btn-close" @onclick="CerrarDetalles">✕</button>
                </div>
                <div class="modal-body">
                    <div class="detail-section">
                        <h4>Información del Cliente</h4>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <span class="detail-label">Nombre:</span>
                                <span class="detail-value">@pedidoSeleccionado.NombreCliente</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Email:</span>
                                <span class="detail-value">@pedidoSeleccionado.CorreoCliente</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Teléfono:</span>
                                <span class="detail-value">@pedidoSeleccionado.TelefonoPrincipal</span>
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h4>Información del Pedido</h4>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <span class="detail-label">Número:</span>
                                <span class="detail-value">@pedidoSeleccionado.NumeroPedido</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Fecha:</span>
                                <span class="detail-value">@pedidoSeleccionado.FechaPedido.ToString("dd/MM/yyyy HH:mm")</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Estado:</span>
                                <span class="detail-value status-badge @GetStatusClass(pedidoSeleccionado.Estado)">
                                    @pedidoSeleccionado.Estado
                                </span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Método de Pago:</span>
                                <span class="detail-value">@pedidoSeleccionado.MetodoPago</span>
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h4>Dirección de Envío</h4>
                        <div class="direccion-box">
                            <p><strong>@pedidoSeleccionado.DireccionCompleta</strong></p>
                            <p>@pedidoSeleccionado.Barrio</p>
                            <p>@pedidoSeleccionado.Ciudad, @pedidoSeleccionado.Departamento</p>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h4>Productos</h4>
                        <div class="products-list">
                            @foreach (var item in pedidoSeleccionado.Productos)
                            {
                                <div class="product-item">
                                    @if (!string.IsNullOrEmpty(item.ImagenUrl))
                                    {
                                        <img src="@item.ImagenUrl" alt="@item.NombreProducto" class="product-image" />
                                    }
                                    <div class="product-info">
                                        <span class="product-name">@item.NombreProducto</span>
                                        <span class="product-details">@item.Marca - @item.Talla - @item.Color</span>
                                        <span class="product-sku">SKU: @item.CodigoSKU</span>
                                        <span class="product-quantity">Cantidad: <strong>@item.Cantidad</strong></span>
                                    </div>
                                    <div class="product-prices">
                                        <span class="product-unit-price">@item.PrecioUnitario.ToString("C") c/u</span>
                                        <span class="product-subtotal">@item.SubtotalLinea.ToString("C")</span>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>

                    <div class="detail-section">
                        <h4>Resumen de Pago</h4>
                        <div class="payment-summary">
                            <div class="summary-row">
                                <span>Subtotal:</span>
                                <span>@pedidoSeleccionado.Subtotal.ToString("C")</span>
                            </div>
                            <div class="summary-row">
                                <span>Costo de Envío:</span>
                                <span>@pedidoSeleccionado.CostoEnvio.ToString("C")</span>
                            </div>
                            <div class="summary-row">
                                <span>IVA (19%):</span>
                                <span>@pedidoSeleccionado.Impuesto.ToString("C")</span>
                            </div>
                            <div class="summary-row total-row">
                                <span>Total:</span>
                                <span>@pedidoSeleccionado.Total.ToString("C")</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    @if (mostrarConfirmacion)
    {
        <div class="modal-overlay" @onclick="CerrarConfirmacion">
            <div class="modal-content confirmation-modal" @onclick:stopPropagation>
                <div class="modal-header">
                    <h3>Confirmar Cancelación</h3>
                    <button class="btn-close" @onclick="CerrarConfirmacion">✕</button>
                </div>
                <div class="modal-body">
                    <p>¿Está seguro de cancelar el pedido <strong>@pedidoParaCancelar?.NumeroPedido</strong>?</p>
                    <p class="warning-text">Esta acción no se puede deshacer.</p>
                    <div class="confirmation-buttons">
                        <button class="btn-secondary" @onclick="CerrarConfirmacion">No, mantener pedido</button>
                        <button class="btn-danger" @onclick="ConfirmarCancelacion">Sí, cancelar pedido</button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<ModalGenerarFactura IdPedido="idPedidoSeleccionado" MostrarModal="mostrarModalFactura" OnCerrar="CerrarModalFactura" OnFacturaGenerada="OnFacturaGenerada" />

<style>

</style>

@code {
    private List<PedidoListaDTO> pedidos = new();
    private PedidoCompletoDTO? pedidoSeleccionado;
    private PedidoListaDTO? pedidoParaCancelar;

    private string searchTerm = "";
    private string filterStatus = "";
    private DateTime? filterDate;

    private bool cargando = true;
    private bool mostrarDetalles = false;
    private bool mostrarConfirmacion = false;
    private string? errorMessage;

    private bool mostrarModalFactura = false;
    private int idPedidoSeleccionado = 0;

    protected override async Task OnInitializedAsync()
    {
        QuestPDF.Settings.License = LicenseType.Community;
        await CargarPedidos();
    }

    private async Task CargarPedidos()
    {
        try
        {
            cargando = true;
            errorMessage = null;

            var response = await PedidoService.ObtenerTodosPedidos();

            if (response.IsSuccess && response.ListObject != null)
            {
                pedidos = response.ListObject.ToList();
            }
            else
            {
                errorMessage = response.Message ?? "Error al cargar los pedidos";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            cargando = false;
        }
    }

    private async Task ExportarPedidosPDF()
    {
        try
        {
            var pedidosParaExportar = PedidosFiltrados.ToList();

            if (!pedidosParaExportar.Any())
            {
                errorMessage = "No hay pedidos para exportar";
                return;
            }

            var document = Document.Create(container =>
            {
                container.Page(page =>
                {
                    page.Size(PageSizes.A4.Landscape());
                    page.Margin(40);
                    page.DefaultTextStyle(x => x.FontSize(9).FontFamily("Arial"));

                    // Header
                    page.Header().Element(ComposeHeader);

                    // Content
                    page.Content().Element(container => ComposeContent(container, pedidosParaExportar));

                    // Footer
                    page.Footer().Element(ComposeFooter);
                });
            });

            var pdfBytes = document.GeneratePdf();
            var base64 = Convert.ToBase64String(pdfBytes);
            var fileName = $"Reporte_Pedidos_{DateTime.Now:yyyyMMdd_HHmmss}.pdf";

            await JSRuntime.InvokeVoidAsync("downloadFile", fileName, base64);
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al generar PDF: {ex.Message}";
        }
    }

    private void ComposeHeader(IContainer container)
    {
        container.Column(column =>
        {
            column.Item().Row(row =>
            {
                row.RelativeItem().Column(col =>
                {
                    col.Item().Text("REPORTE DE PEDIDOS")
                        .FontSize(20)
                        .Bold()
                        .FontColor("#1e40af");

                    col.Item().PaddingTop(5).Text("Sistema de Gestión de Pedidos")
                        .FontSize(10)
                        .FontColor("#64748b");

                    col.Item().PaddingTop(3).Text($"Generado el {DateTime.Now:dd/MM/yyyy HH:mm:ss}")
                        .FontSize(8)
                        .FontColor("#94a3b8");
                });

                row.ConstantItem(220).Column(col =>
                {
                    col.Item().Background("#f8fafc").Padding(10).Row(statsRow =>
                    {
                        statsRow.RelativeItem().Column(c =>
                        {
                            c.Item().Text("TOTAL").FontSize(8).FontColor("#64748b");
                            c.Item().Text(pedidos.Count.ToString())
                                .FontSize(22).Bold().FontColor("#1e40af");
                        });

                        statsRow.RelativeItem().Column(c =>
                        {
                            c.Item().Text("ENTREGADOS").FontSize(8).FontColor("#64748b");
                            c.Item().Text(pedidos.Count(p => p.Estado == "Entregado").ToString())
                                .FontSize(22).Bold().FontColor("#10b981");
                        });

                        statsRow.RelativeItem().Column(c =>
                        {
                            c.Item().Text("PENDIENTES").FontSize(8).FontColor("#64748b");
                            c.Item().Text(pedidos.Count(p => p.Estado == "Pendiente").ToString())
                                .FontSize(22).Bold().FontColor("#f59e0b");
                        });
                    });
                });
            });

            column.Item().PaddingTop(15).PaddingBottom(10).LineHorizontal(2).LineColor("#e2e8f0");
        });
    }

    private void ComposeContent(IContainer container, List<PedidoListaDTO> pedidosExportar)
    {
        container.PaddingTop(10).Column(column =>
        {
            // Resumen financiero
            column.Item().PaddingBottom(15).Background("#f8fafc").Padding(12).Row(row =>
            {
                row.RelativeItem().Column(col =>
                {
                    col.Item().Text("RESUMEN FINANCIERO").FontSize(11).Bold().FontColor("#0f172a");
                    col.Item().PaddingTop(5).Row(summaryRow =>
                    {
                        summaryRow.RelativeItem().Column(c =>
                        {
                            c.Item().Text("Valor Total Pedidos").FontSize(8).FontColor("#64748b");
                            c.Item().Text($"${pedidos.Sum(p => p.Total):N2}")
                                .FontSize(14).Bold().FontColor("#1e40af");
                        });

                        summaryRow.RelativeItem().Column(c =>
                        {
                            c.Item().Text("Promedio por Pedido").FontSize(8).FontColor("#64748b");
                            var promedio = pedidos.Any() ? pedidos.Average(p => p.Total) : 0;
                            c.Item().Text($"${promedio:N2}")
                                .FontSize(14).Bold().FontColor("#0f172a");
                        });

                        summaryRow.RelativeItem().Column(c =>
                        {
                            c.Item().Text("Pedidos Activos").FontSize(8).FontColor("#64748b");
                            var activos = pedidos.Count(p => p.Estado != "Cancelado" && p.Estado != "Entregado");
                            c.Item().Text(activos.ToString())
                                .FontSize(14).Bold().FontColor("#f59e0b");
                        });

                        summaryRow.RelativeItem().Column(c =>
                        {
                            c.Item().Text("Tasa de Entrega").FontSize(8).FontColor("#64748b");
                            var tasa = pedidos.Any() ? (pedidos.Count(p => p.Estado == "Entregado") * 100.0 / pedidos.Count) : 0;
                            c.Item().Text($"{tasa:F1}%")
                                .FontSize(14).Bold().FontColor("#10b981");
                        });
                    });
                });
            });

            // Tabla de pedidos
            column.Item().Table(table =>
            {
                table.ColumnsDefinition(columns =>
                {
                    columns.RelativeColumn(1.2f); // Número
                    columns.RelativeColumn(2f);   // Cliente
                    columns.RelativeColumn(1.8f); // Email
                    columns.RelativeColumn(1.3f); // Fecha
                    columns.RelativeColumn(1f);   // Total
                    columns.RelativeColumn(1f);   // Estado
                    columns.RelativeColumn(1.2f); // Método Pago
                });

                table.Header(header =>
                {
                    header.Cell().Element(CellStyle).Background("#1e40af").Padding(6)
                        .Text("N° PEDIDO").FontSize(8).Bold().FontColor("#ffffff");
                    header.Cell().Element(CellStyle).Background("#1e40af").Padding(6)
                        .Text("CLIENTE").FontSize(8).Bold().FontColor("#ffffff");
                    header.Cell().Element(CellStyle).Background("#1e40af").Padding(6)
                        .Text("CORREO").FontSize(8).Bold().FontColor("#ffffff");
                    header.Cell().Element(CellStyle).Background("#1e40af").Padding(6)
                        .Text("FECHA").FontSize(8).Bold().FontColor("#ffffff");
                    header.Cell().Element(CellStyle).Background("#1e40af").Padding(6)
                        .Text("TOTAL").FontSize(8).Bold().FontColor("#ffffff");
                    header.Cell().Element(CellStyle).Background("#1e40af").Padding(6)
                        .Text("ESTADO").FontSize(8).Bold().FontColor("#ffffff");
                    header.Cell().Element(CellStyle).Background("#1e40af").Padding(6)
                        .Text("MÉTODO PAGO").FontSize(8).Bold().FontColor("#ffffff");
                });

                var index = 0;
                foreach (var pedido in pedidosExportar)
                {
                    var backgroundColor = index % 2 == 0 ? "#ffffff" : "#f8fafc";

                    table.Cell().Element(CellStyle).Background(backgroundColor).Padding(6)
                        .Text(pedido.NumeroPedido).FontSize(8).Bold().FontColor("#0f172a");

                    table.Cell().Element(CellStyle).Background(backgroundColor).Padding(6)
                        .Text(pedido.NombreCliente).FontSize(7.5f).FontColor("#475569");

                    var correo = pedido.CorreoCliente;
                    if (correo.Length > 28)
                        correo = correo.Substring(0, 25) + "...";
                    table.Cell().Element(CellStyle).Background(backgroundColor).Padding(6)
                        .Text(correo).FontSize(7).FontColor("#64748b");

                    table.Cell().Element(CellStyle).Background(backgroundColor).Padding(6)
                        .Text(pedido.FechaPedido.ToString("dd/MM/yy HH:mm")).FontSize(7).FontColor("#64748b");

                    table.Cell().Element(CellStyle).Background(backgroundColor).Padding(6)
                        .AlignRight().Text($"${pedido.Total:N2}").FontSize(8).Bold().FontColor("#0f172a");

                    var estadoColor = GetEstadoColor(pedido.Estado);
                    var estadoBgColor = GetEstadoBgColor(pedido.Estado);
                    table.Cell().Element(CellStyle).Background(backgroundColor).Padding(6)
                        .AlignCenter().Column(col =>
                        {
                            col.Item().MaxWidth(70).Height(18)
                                .AlignCenter().AlignMiddle()
                                .Text(pedido.Estado)
                                .FontSize(6.5f).Bold().FontColor(estadoColor);
                        });

                    table.Cell().Element(CellStyle).Background(backgroundColor).Padding(6)
                        .Text(pedido.MetodoPago).FontSize(7).FontColor("#475569");

                    index++;
                }
            });
        });
    }

    private void ComposeFooter(IContainer container)
    {
        container.AlignBottom().Column(column =>
        {
            column.Item().LineHorizontal(1).LineColor("#e2e8f0");

            column.Item().PaddingTop(8).Row(row =>
            {
                row.RelativeItem().Column(col =>
                {
                    col.Item().Text("Sistema de Gestión de Pedidos")
                        .FontSize(8).Bold().FontColor("#475569");
                    col.Item().Text("Reporte generado automáticamente")
                        .FontSize(7).FontColor("#94a3b8");
                });

                row.RelativeItem().AlignRight().Text(page =>
                {
                    page.Span("Página ").FontSize(8).FontColor("#64748b");
                    page.CurrentPageNumber().FontSize(8).Bold().FontColor("#475569");
                    page.Span(" de ").FontSize(8).FontColor("#64748b");
                    page.TotalPages().FontSize(8).Bold().FontColor("#475569");
                });
            });
        });
    }

    private IContainer CellStyle(IContainer container)
    {
        return container.Border(0.5f).BorderColor("#e2e8f0");
    }

    private string GetEstadoColor(string estado)
    {
        return estado switch
        {
            "Entregado" => "#10b981",
            "Enviado" => "#3b82f6",
            "Confirmado" => "#8b5cf6",
            "Pendiente" => "#f59e0b",
            "Cancelado" => "#ef4444",
            _ => "#64748b"
        };
    }

    private string GetEstadoBgColor(string estado)
    {
        return estado switch
        {
            "Entregado" => "#d1fae5",
            "Enviado" => "#dbeafe",
            "Confirmado" => "#ede9fe",
            "Pendiente" => "#fef3c7",
            "Cancelado" => "#fee2e2",
            _ => "#f1f5f9"
        };
    }

    private IEnumerable<PedidoListaDTO> PedidosFiltrados
    {
        get
        {
            var resultado = pedidos.AsEnumerable();

            if (!string.IsNullOrWhiteSpace(searchTerm))
            {
                resultado = resultado.Where(p =>
                    p.NumeroPedido.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                    p.NombreCliente.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                    p.CorreoCliente.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)
                );
            }

            if (!string.IsNullOrWhiteSpace(filterStatus))
            {
                resultado = resultado.Where(p => p.Estado == filterStatus);
            }

            if (filterDate.HasValue)
            {
                resultado = resultado.Where(p => p.FechaPedido.Date == filterDate.Value.Date);
            }

            return resultado.OrderByDescending(p => p.FechaPedido);
        }
    }

    private async Task CambiarEstado(PedidoListaDTO pedido, string nuevoEstado)
    {
        try
        {
            var actualizacion = new ActualizarEstadoPedidoDTO
            {
                IdPedido = pedido.IdPedido,
                Estado = nuevoEstado
            };

            var response = await PedidoService.ActualizarEstadoPedido(actualizacion);

            if (response.IsSuccess)
            {
                pedido.Estado = nuevoEstado;
                StateHasChanged();
            }
            else
            {
                errorMessage = response.Message;
                await CargarPedidos();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al cambiar estado: {ex.Message}";
            await CargarPedidos();
        }
    }

    private async Task VerDetalles(PedidoListaDTO pedido)
    {
        try
        {
            cargando = true;
            var response = await PedidoService.ObtenerPedidoCompleto(pedido.IdPedido);

            if (response.IsSuccess && response.Object != null)
            {
                pedidoSeleccionado = response.Object;
                mostrarDetalles = true;
            }
            else
            {
                errorMessage = response.Message ?? "Error al cargar los detalles del pedido";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            cargando = false;
        }
    }

    private void CerrarDetalles()
    {
        mostrarDetalles = false;
        pedidoSeleccionado = null;
    }

    private void CancelarPedido(PedidoListaDTO pedido)
    {
        pedidoParaCancelar = pedido;
        mostrarConfirmacion = true;
    }

    private void CerrarConfirmacion()
    {
        mostrarConfirmacion = false;
        pedidoParaCancelar = null;
    }

    private async Task ConfirmarCancelacion()
    {
        if (pedidoParaCancelar == null) return;

        try
        {
            var response = await PedidoService.CancelarPedido(pedidoParaCancelar.IdPedido);

            if (response.IsSuccess)
            {
                await CargarPedidos();
                CerrarConfirmacion();
            }
            else
            {
                errorMessage = response.Message;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al cancelar pedido: {ex.Message}";
        }
    }

    private string GetStatusClass(string status)
    {
        return status;
    }

    private void AbrirModalFactura(int idPedido)
    {
        idPedidoSeleccionado = idPedido;
        mostrarModalFactura = true;
    }

    private void CerrarModalFactura()
    {
        mostrarModalFactura = false;
        idPedidoSeleccionado = 0;
    }

    private async Task OnFacturaGenerada(int idFactura)
    {
        await CargarPedidos();
        StateHasChanged();
    }
}

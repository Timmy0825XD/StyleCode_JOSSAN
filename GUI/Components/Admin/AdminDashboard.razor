@page "/AdminDashboard"
@layout AdminLayout
@using Blazorise
@using Blazorise.Charts
@using System.Collections.Generic
@using GUI.Components.Layout
@using BLL.Interfaces
@using ENTITY.Estadisticas
@using ENTITY.Utilidades
@inject IEstadisticaService EstadisticaService

<section style="padding: 24px">

    @if (isLoading)
    {
        <div style="display: flex; justify-content: center; align-items: center; min-height: 400px;">
            <div class="loading-spinner">Cargando estadísticas...</div>
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger" role="alert">
            <strong>Error:</strong> @errorMessage
        </div>
    }
    else
    {
        <div class="stats-grid">
            @foreach (var stat in stats)
            {
                <div class="stat-card">
                    <div class="stat-content">
                        <div class="stat-info">
                            <p style="color: grey;">@stat.Title</p>
                            <h3 style="font-weight:bold">@stat.Value</h3>
                            @if (!string.IsNullOrEmpty(stat.Subtitle))
                            {
                                <p class="stat-subtitle">@stat.Subtitle</p>
                            }
                        </div>
                        <div class="stat-icon @stat.ColorClass">
                            <Icon Name="@stat.IconName" />
                        </div>
                    </div>
                </div>
            }
        </div>

        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Ventas por Categoría</h3>
                    <button class="view-more-btn" @onclick="RefreshVentasCategoria">Actualizar</button>
                </div>
                <div class="chart-content">
                    <BarChart @ref="barChartCategoria" TItem="double" />
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <h3>Ventas por Género</h3>
                    <button class="view-more-btn" @onclick="RefreshVentasGenero">Actualizar</button>
                </div>
                <div class="chart-content">
                    <BarChart @ref="barChartGenero" TItem="double" />
                </div>
            </div>
        </div>

        <div class="orders-card">
            <h3 class="orders-title">Pedidos Recientes</h3>
            <div class="table-container">
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>Número Pedido</th>
                            <th>Cliente</th>
                            <th>Productos</th>
                            <th>Total</th>
                            <th>Método Pago</th>
                            <th>Estado</th>
                            <th>Fecha</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (pedidosRecientes != null && pedidosRecientes.Any())
                        {
                            @foreach (var pedido in pedidosRecientes.Take(10))
                            {
                                <tr>
                                    <td class="order-id">@pedido.NumeroPedido</td>
                                    <td>
                                        <div class="customer-info">
                                            <div>@pedido.Cliente</div>
                                            <div class="customer-email">@pedido.EmailCliente</div>
                                        </div>
                                    </td>
                                    <td>@pedido.CantidadProductos</td>
                                    <td class="order-total">$@pedido.Total.ToString("N2")</td>
                                    <td>@pedido.MetodoPago</td>
                                    <td>
                                        <span class="status-badge @GetStatusClass(pedido.Estado)">
                                            @GetStatusText(pedido.Estado)
                                        </span>
                                    </td>
                                    <td class="order-date">@pedido.FechaPedido.ToString("dd/MM/yyyy HH:mm")</td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 24px; color: #6b7280;">
                                    No hay pedidos recientes
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        @if (topProductos != null && topProductos.Any())
        {
            <div class="orders-card" style="margin-top: 24px;">
                <h3 class="orders-title">Top 10 Productos Más Vendidos</h3>
                <div class="products-grid">
                    @foreach (var producto in topProductos.Take(10))
                    {
                        <div class="product-card">
                            @if (!string.IsNullOrEmpty(producto.Imagen))
                            {
                                <img src="@producto.Imagen" alt="@producto.Nombre" class="product-image" />
                            }
                            else
                            {
                                <div class="product-image-placeholder">📦</div>
                            }
                            <div class="product-info">
                                <h4>@producto.Nombre</h4>
                                <p class="product-brand">@producto.Marca</p>
                                <div class="product-stats">
                                    <span>$@producto.PrecioBase.ToString("N2")</span>
                                    <span>@producto.UnidadesVendidas vendidas</span>
                                </div>
                                <div class="product-revenue">
                                    Ingresos: $@producto.IngresosGenerados.ToString("N2")
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }

        @if (productosStockBajo != null && productosStockBajo.Any())
        {
            <div class="orders-card alert-card" style="margin-top: 24px;">
                <h3 class="orders-title" style="color: #dc2626;">Productos con Stock Bajo</h3>
                <div class="table-container">
                    <table class="orders-table">
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>Producto</th>
                                <th>Marca</th>
                                <th>Talla</th>
                                <th>Color</th>
                                <th>Stock</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var producto in productosStockBajo)
                            {
                                <tr>
                                    <td class="order-id">@producto.CodigoSku</td>
                                    <td>@producto.Nombre</td>
                                    <td>@producto.Marca</td>
                                    <td>@producto.Talla</td>
                                    <td>@producto.Color</td>
                                    <td>
                                        <span class="stock-badge">@producto.Stock unidades</span>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }

        @if (topClientes != null && topClientes.Any())
        {
            <div class="orders-card" style="margin-top: 24px;">
                <h3 class="orders-title">Top 10 Mejores Clientes</h3>
                <div class="table-container">
                    <table class="orders-table">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Correo</th>
                                <th>Teléfono</th>
                                <th>Total Pedidos</th>
                                <th>Total Gastado</th>
                                <th>Ticket Promedio</th>
                                <th>Última Compra</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var cliente in topClientes.Take(10))
                            {
                                <tr>
                                    <td>@cliente.NombreCompleto</td>
                                    <td class="customer-email">@cliente.Correo</td>
                                    <td>@cliente.TelefonoPrincipal</td>
                                    <td>@cliente.TotalPedidos</td>
                                    <td class="order-total">$@cliente.TotalGastado.ToString("N2")</td>
                                    <td>$@cliente.TicketPromedio.ToString("N2")</td>
                                    <td class="order-date">@cliente.UltimaCompra.ToString("dd/MM/yyyy")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }
    }
</section>

@code {
    private BarChart<double> barChartCategoria;
    private BarChart<double> barChartGenero;
    private LineChart<int> lineChartEstado;

    private bool isLoading = true;
    private string errorMessage = string.Empty;

    public class StatCard
    {
        public string Title { get; set; }
        public string Value { get; set; }
        public string ColorClass { get; set; }
        public IconName IconName { get; set; }
        public string Subtitle { get; set; }
    }

    private List<StatCard> stats = new List<StatCard>();
    private List<PedidoRecienteDTO> pedidosRecientes = new List<PedidoRecienteDTO>();
    private List<TopProductoDTO> topProductos = new List<TopProductoDTO>();
    private List<ProductoStockBajoDTO> productosStockBajo = new List<ProductoStockBajoDTO>();
    private List<TopClienteDTO> topClientes = new List<TopClienteDTO>();

    private List<VentaCategoriaDTO> ventasPorCategoria = new List<VentaCategoriaDTO>();
    private List<VentaGeneroDTO> ventasPorGenero = new List<VentaGeneroDTO>();

    protected override async Task OnInitializedAsync()
    {
        await CargarDatosCompletos();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !isLoading)
        {
            await RenderizarGraficos();
        }
    }

    private async Task CargarDatosCompletos()
    {
        try
        {
            isLoading = true;
            errorMessage = string.Empty;

            var tasks = new List<Task>
            {
                CargarMetricasDashboard(),
                CargarVentasPorCategoria(),
                CargarVentasPorGenero(),
                CargarPedidosRecientes(),
                CargarTopProductos(),
                CargarTopClientes(),
                CargarProductosStockBajo()
            };

            await Task.WhenAll(tasks);
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al cargar las estadísticas: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task CargarMetricasDashboard()
    {
        var response = await EstadisticaService.ObtenerMetricasDashboard();

        if (response.IsSuccess && response.Object != null)
        {
            var metricas = response.Object;

            stats = new List<StatCard>
            {
                new StatCard
                {
                    Title = "Ventas Totales (Mes)",
                    Value = $"${metricas.VentasMesActual:N2}",
                    ColorClass = "purple",
                    IconName = IconName.ShoppingCart,
                    Subtitle = $"Hoy: ${metricas.VentasHoy:N2}",
                },
                new StatCard
                {
                    Title = "Pedidos Totales",
                    Value = metricas.TotalPedidosMes.ToString("N0"),
                    ColorClass = "blue",
                    IconName = IconName.File,
                    Subtitle = $"Pendientes: {metricas.PedidosPendientes}",
                },
                new StatCard
                {
                    Title = "Clientes",
                    Value = metricas.TotalClientes.ToString("N0"),
                    ColorClass = "green",
                    IconName = IconName.Users,
                    Subtitle = $"Nuevos: {metricas.ClientesNuevosMes} este mes"
                },
                new StatCard
                {
                    Title = "Productos Activos",
                    Value = metricas.TotalProductosActivos.ToString("N0"),
                    ColorClass = "orange",
                    IconName = IconName.Archive,
                    Subtitle = $"Stock bajo: {metricas.ProductosStockBajo}"
                },
                new StatCard
                {
                    Title = "Ticket Promedio",
                    Value = $"${metricas.TicketPromedio:N2}",
                    ColorClass = "indigo",
                    IconName = IconName.DollarSign
                },
            };
        }
    }

    private async Task CargarVentasPorCategoria()
    {
        var response = await EstadisticaService.ObtenerVentasPorCategoria();

        if (response.IsSuccess && response.ListObject != null)
        {
            ventasPorCategoria = response.ListObject.ToList();
        }
    }

    private async Task CargarVentasPorGenero()
    {
        var response = await EstadisticaService.ObtenerVentasPorGenero();

        if (response.IsSuccess && response.ListObject != null)
        {
            ventasPorGenero = response.ListObject.ToList();
        }
    }

    private async Task CargarPedidosRecientes()
    {
        var response = await EstadisticaService.ObtenerPedidosRecientes(10);

        if (response.IsSuccess && response.ListObject != null)
        {
            pedidosRecientes = response.ListObject.ToList();
        }
    }

    private async Task CargarTopProductos()
    {
        var response = await EstadisticaService.ObtenerTopProductos(10);

        if (response.IsSuccess && response.ListObject != null)
        {
            topProductos = response.ListObject.ToList();
        }
    }

    private async Task CargarTopClientes()
    {
        var response = await EstadisticaService.ObtenerTopClientes(10);

        if (response.IsSuccess && response.ListObject != null)
        {
            topClientes = response.ListObject.ToList();
        }
    }

    private async Task CargarProductosStockBajo()
    {
        var response = await EstadisticaService.ObtenerProductosStockBajo(10);

        if (response.IsSuccess && response.ListObject != null)
        {
            productosStockBajo = response.ListObject.ToList();
        }
    }

    private async Task RenderizarGraficos()
    {
        await RenderizarVentasPorCategoria();
        await RenderizarVentasPorGenero();
    }

    private async Task RenderizarVentasPorCategoria()
    {
        if (barChartCategoria == null || !ventasPorCategoria.Any()) return;

        await barChartCategoria.Clear();

        var labels = ventasPorCategoria.Select(v => v.Categoria).ToArray();
        var data = ventasPorCategoria.Select(v => (double)v.TotalVentas).ToList();

        await barChartCategoria.AddLabelsDatasetsAndUpdate(labels, GetBarChartDataset(data, "Ventas por Categoría"));
    }

    private async Task RenderizarVentasPorGenero()
    {
        if (barChartGenero == null || !ventasPorGenero.Any()) return;

        await barChartGenero.Clear();

        var labels = ventasPorGenero.Select(v => v.Genero).ToArray();
        var data = ventasPorGenero.Select(v => (double)v.TotalVentas).ToList();

        await barChartGenero.AddLabelsDatasetsAndUpdate(labels, GetBarChartDataset(data, "Ventas por Género"));
    }

    private BarChartDataset<double> GetBarChartDataset(List<double> data, string label)
    {
        return new BarChartDataset<double>
        {
            Label = label,
            Data = data,
            BackgroundColor = new List<string>
            {
                "rgba(168, 85, 247, 0.8)",
                "rgba(59, 130, 246, 0.8)",
                "rgba(16, 185, 129, 0.8)",
                "rgba(245, 158, 11, 0.8)",
                "rgba(239, 68, 68, 0.8)"
            },
            BorderColor = new List<string>
            {
                "rgba(168, 85, 247, 1)",
                "rgba(59, 130, 246, 1)",
                "rgba(16, 185, 129, 1)",
                "rgba(245, 158, 11, 1)",
                "rgba(239, 68, 68, 1)"
            },
            BorderWidth = 2
        };
    }

    private LineChartDataset<int> GetLineChartDataset(List<int> data)
    {
        return new LineChartDataset<int>
        {
            Label = "Pedidos",
            Data = data,
            BackgroundColor = new List<string> { "rgba(168, 85, 247, 0.2)" },
            BorderColor = new List<string> { "rgba(168, 85, 247, 1)" },
            Fill = true,
            PointRadius = 5,
            PointHoverRadius = 7,
            BorderWidth = 3,
        };
    }

    private async Task RefreshVentasCategoria()
    {
        await CargarVentasPorCategoria();
        await RenderizarVentasPorCategoria();
    }

    private async Task RefreshVentasGenero()
    {
        await CargarVentasPorGenero();
        await RenderizarVentasPorGenero();
    }

    private string GetStatusClass(string status)
    {
        return status.ToLower() switch
        {
            "completado" or "completed" or "entregado" => "completed",
            "en proceso" or "processing" or "en-proceso" => "processing",
            "pendiente" or "pending" => "pending",
            "cancelado" or "cancelled" => "cancelled",
            _ => "pending"
        };
    }

    private string GetStatusText(string status)
    {
        return status.ToLower() switch
        {
            "completado" or "completed" or "entregado" => "Completado",
            "en proceso" or "processing" or "en-proceso" => "En Proceso",
            "pendiente" or "pending" => "Pendiente",
            "cancelado" or "cancelled" => "Cancelado",
            _ => status
        };
    }
}

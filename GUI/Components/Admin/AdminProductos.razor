@page "/AdminProductos"
@using CloudinaryDotNet
@using ENTITY.Articulos
@using BLL.Interfaces
@using ENTITY.Utilidades
@inject IArticuloServices ArticuloService
@inject ICategoriaServices CategoriaService
@inject Cloudinary cloudinary

<div class="container">
    <div class="page-header">
        <h2 style="font-size: 28px; font-weight: 700;"> Gestión de Productos </h2>
        <button class="btn-primary" @onclick="AbrirModalNuevoProducto">
            <span>➕</span>
            Nuevo Producto
        </button>
    </div>

    <div class="products-card">
        <div class="toolbar">
            <div class="search-container">
                <input type="text"
                       placeholder="Buscar productos..."
                       class="search-input"
                       @bind="searchText"
                       @bind:event="oninput" />
            </div>
            <button class="btn-secondary" @onclick="AbrirModalFiltros">
                <span><Icon Name="IconName.ExpandMore" /></span>
                Filtros
            </button>
        </div>

        @if (cargando)
        {
            <div class="empty-state">
                <span class="empty-icon">⏳</span>
                <p>Cargando productos...</p>
            </div>
        }
        else
        {
            <div class="table-container">
                <table class="products-table">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Categoría</th>
                            <th>Precio</th>
                            <th>Variantes</th>
                            <th>Marca</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var product in ProductosFiltrados)
                        {
                            <tr>
                                <td class="product-name">
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        @if (!string.IsNullOrEmpty(product.ImagenPrincipal))
                                        {
                                            <img src="@product.ImagenPrincipal" alt="@product.Nombre" style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px;" />
                                        }
                                        <span>@product.Nombre</span>
                                    </div>
                                </td>
                                <td class="product-category">
                                    <div>
                                        <span style="display: block; font-weight: 600;">@product.CategoriaTipo</span>
                                        <span style="font-size: 12px; color: #6b7280;">@product.CategoriaOcasion</span>
                                    </div>
                                </td>
                                <td class="product-price">$@product.PrecioBase.ToString("F2")</td>
                                <td>
                                    <span class="@GetVariantesClass(product.TotalVariantes)">
                                        @product.TotalVariantes
                                    </span>
                                </td>
                                <td class="product-sales">@product.Marca</td>
                                <td>
                                    <span class="badge @GetStatusBadgeClass(product.Estado)">
                                        @GetStatusText(product.Estado)
                                    </span>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <!-- 🆕 MENÚ DESPLEGABLE PARA EDICIÓN -->
                                        <div class="dropdown">
                                            <button class="btn-action btn-edit" title="Editar">
                                                <Icon Name="IconName.Pen" />
                                            </button>
                                            <div class="dropdown-menu">
                                                <button class="dropdown-item" @onclick="() => EditarInformacion(product.IdArticulo)">
                                                    <Icon Name="IconName.File" /> Información
                                                </button>
                                                <button class="dropdown-item" @onclick="() => EditarVariantes(product.IdArticulo)">
                                                    <Icon Name="IconName.List" /> Variantes
                                                </button>
                                                <button class="dropdown-item" @onclick="() => EditarImagenes(product.IdArticulo)">
                                                    <Icon Name="IconName.Image" /> Imágenes
                                                </button>
                                            </div>
                                        </div>
                                        <button class="btn-action btn-delete" @onclick="() => ConfirmarEliminarProducto(product.IdArticulo, product.Nombre)" title="Eliminar">
                                            <Icon Name="IconName.Delete" />
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>

                @if (!ProductosFiltrados.Any())
                {
                    <div class="empty-state">
                        <span class="empty-icon">📦</span>
                        <p>No se encontraron productos</p>
                    </div>
                }
            </div>
        }
    </div>
</div>

<!-- MODAL DE FILTROS -->
@if (mostrarModalFiltros)
{
    <div class="modal-overlay" @onclick="CerrarModalFiltros">
        <div class="modal-content modal-medium" @onclick:stopPropagation>
            <div class="modal-header">
                <h3>Filtros Avanzados</h3>
                <button class="btn-close" @onclick="CerrarModalFiltros">✕</button>
            </div>

            <div class="modal-body">
                <div class="form-section">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Categoría Tipo</label>
                            <select class="form-select" @bind="filtroCategoriaTipo">
                                <option value="">Todas</option>
                                @foreach (var cat in categoriasTipo)
                                {
                                    <option value="@cat.Nombre">@cat.Nombre</option>
                                }
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Categoría Ocasión</label>
                            <select class="form-select" @bind="filtroCategoriaOcasion">
                                <option value="">Todas</option>
                                @foreach (var cat in categoriasOcasion)
                                {
                                    <option value="@cat.Nombre">@cat.Nombre</option>
                                }
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Género</label>
                            <select class="form-select" @bind="filtroGenero">
                                <option value="">Todos</option>
                                <option value="Hombre">Hombre</option>
                                <option value="Mujer">Mujer</option>
                                <option value="Unisex">Unisex</option>
                                <option value="Niño">Niño</option>
                                <option value="Niña">Niña</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Estado</label>
                            <select class="form-select" @bind="filtroEstado">
                                <option value="">Todos</option>
                                <option value="A">Activo</option>
                                <option value="I">Inactivo</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Precio Mínimo</label>
                            <input type="number" class="form-input" @bind="filtroPrecioMin" min="0" step="0.01" placeholder="0.00" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Precio Máximo</label>
                            <input type="number" class="form-input" @bind="filtroPrecioMax" min="0" step="0.01" placeholder="0.00" />
                        </div>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-modal-back" @onclick="LimpiarFiltros">
                        Limpiar Filtros
                    </button>
                    <button type="button" class="btn-modal-save" @onclick="AplicarFiltros">
                        Aplicar Filtros
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- MODAL CONFIRMACIÓN ELIMINAR -->
@if (mostrarModalConfirmacion)
{
    <div class="modal-overlay" @onclick="CerrarModalConfirmacion">
        <div class="modal-content modal-small" @onclick:stopPropagation>
            <div class="modal-header">
                <h3>⚠️ Confirmar Eliminación</h3>
                <button class="btn-close" @onclick="CerrarModalConfirmacion">✕</button>
            </div>

            <div class="modal-body">
                <p style="margin-bottom: 20px; text-align: center;">
                    ¿Estás seguro de que deseas eliminar el producto<br />
                    <strong>"@nombreProductoAEliminar"</strong>?
                </p>
                <p style="text-align: center; color: #ef4444; font-size: 14px;">
                    Esta acción no se puede deshacer.
                </p>

                <div class="modal-actions" style="margin-top: 24px;">
                    <button type="button" class="btn-modal-back" @onclick="CerrarModalConfirmacion">
                        Cancelar
                    </button>
                    <button type="button" class="btn-delete-confirm" @onclick="EliminarProductoConfirmado" disabled="@eliminandoProducto">
                        @if (eliminandoProducto)
                        {
                            <span>Eliminando...</span>
                        }
                        else
                        {
                            <span>🗑️ Eliminar</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- 🆕 MODAL CREAR PRODUCTO (Paso a paso) -->
@if (mostrarModalCrear)
{
    <div class="modal-overlay" @onclick="CerrarModalCrear">
        <div class="modal-content modal-large" @onclick:stopPropagation>
            <div class="modal-header">
                <h3>Nuevo Producto</h3>
                <button class="btn-close" @onclick="CerrarModalCrear">✕</button>
            </div>

            <div class="modal-body">
                <div class="modal-steps">
                    <div class="step @(pasoModal == 1 ? "active" : pasoModal > 1 ? "completed" : "")">
                        <div class="step-number">1</div>
                        <span>Información</span>
                    </div>
                    <div class="step-line @(pasoModal > 1 ? "completed" : "")"></div>
                    <div class="step @(pasoModal == 2 ? "active" : pasoModal > 2 ? "completed" : "")">
                        <div class="step-number">2</div>
                        <span>Variantes</span>
                    </div>
                    <div class="step-line @(pasoModal > 2 ? "completed" : "")"></div>
                    <div class="step @(pasoModal == 3 ? "active" : "")">
                        <div class="step-number">3</div>
                        <span>Imágenes</span>
                    </div>
                </div>

                <form @onsubmit="GuardarProducto" @onsubmit:preventDefault>
                    @if (pasoModal == 1)
                    {
                        <div class="form-section">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Nombre del Producto *</label>
                                    <input type="text" class="form-input" @bind="nuevoProducto.Nombre" required />
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Marca *</label>
                                    <input type="text" class="form-input" @bind="nuevoProducto.Marca" required />
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Descripción *</label>
                                <textarea class="form-textarea" rows="3" @bind="nuevoProducto.Descripcion" required></textarea>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Categoría Tipo *</label>
                                    <select class="form-select" @bind="nuevoProducto.CategoriaTipoId" required>
                                        <option value="0">Seleccionar...</option>
                                        @foreach (var cat in categoriasTipo)
                                        {
                                            <option value="@cat.Id">@cat.Nombre</option>
                                        }
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Categoría Ocasión *</label>
                                    <select class="form-select" @bind="nuevoProducto.CategoriaOcasionId" required>
                                        <option value="0">Seleccionar...</option>
                                        @foreach (var cat in categoriasOcasion)
                                        {
                                            <option value="@cat.Id">@cat.Nombre</option>
                                        }
                                    </select>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Género *</label>
                                    <select class="form-select" @bind="nuevoProducto.Genero" required>
                                        <option value="">Seleccionar...</option>
                                        <option value="Hombre">Hombre</option>
                                        <option value="Mujer">Mujer</option>
                                        <option value="Unisex">Unisex</option>
                                        <option value="Niño">Niño</option>
                                        <option value="Niña">Niña</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Material</label>
                                    <input type="text" class="form-input" @bind="nuevoProducto.Material" placeholder="Algodón, Poliéster..." />
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Precio Base *</label>
                                    <input type="number" class="form-input" @bind="nuevoProducto.PrecioBase" min="0" step="0.01" required />
                                </div>
                            </div>
                        </div>
                    }

                    @if (pasoModal == 2)
                    {
                        <div class="form-section">
                            <div class="variantes-header">
                                <h4>Configurar Variantes (Talla y Color)</h4>
                                <button type="button" class="btn-add-variant" @onclick="AgregarVariante">
                                    ➕ Agregar Variante
                                </button>
                            </div>

                            <div class="variantes-list">
                                @foreach (var (variante, index) in nuevoProducto.Variantes.Select((v, i) => (v, i)))
                                {
                                    <div class="variante-item">
                                        <div class="variante-number">@(index + 1)</div>
                                        <div class="variante-fields">
                                            <div class="form-group-inline">
                                                <label>Talla *</label>
                                                <select class="form-select-sm" @bind="variante.Talla" required>
                                                    <option value="">Seleccionar...</option>
                                                    <option value="XS">XS</option>
                                                    <option value="S">S</option>
                                                    <option value="M">M</option>
                                                    <option value="L">L</option>
                                                    <option value="XL">XL</option>
                                                    <option value="XXL">XXL</option>
                                                </select>
                                            </div>
                                            <div class="form-group-inline">
                                                <label>Color *</label>
                                                <input type="text" class="form-input-sm" @bind="variante.Color" placeholder="Rojo, Azul..." required />
                                            </div>
                                            <div class="form-group-inline">
                                                <label>Stock</label>
                                                <input type="number" class="form-input-sm" @bind="variante.Stock" min="0" />
                                            </div>
                                        </div>
                                        <button type="button" class="btn-remove-variant" @onclick="() => EliminarVariante(index)">
                                            🗑️
                                        </button>
                                    </div>
                                }
                            </div>

                            @if (!nuevoProducto.Variantes.Any())
                            {
                                <div class="empty-variants">
                                    <span>📦</span>
                                    <p>No hay variantes. Agrega al menos una.</p>
                                </div>
                            }
                        </div>
                    }

                    @if (pasoModal == 3)
                    {
                        <div class="form-section">
                            <h4>Imágenes del Producto</h4>

                            <div class="image-upload-area">
                                <div class="upload-box">
                                    <span class="upload-icon">📸</span>
                                    <p>Sube imágenes desde tu computadora</p>

                                    <label class="btn-upload" style="cursor:pointer; display: inline-block; margin-top: 10px;">
                                        Seleccionar Imagen
                                        <InputFile OnChange="OnFileSelectedModal" accept="image/*" style="display:none" />
                                    </label>

                                    @if (file != null)
                                    {
                                        <p style="margin-top: 10px; color: #059669; font-size: 14px;">
                                            ✓ Imagen seleccionada: <strong>@file.Name</strong>
                                        </p>
                                    }

                                    <button type="button"
                                            class="btn-upload"
                                            @onclick="SubirImagenACloudinary"
                                            disabled="@(!hayImagenSeleccionada || subiendoImagen)"
                                            style="margin-top: 10px; background-color: #059669;">
                                        @if (subiendoImagen)
                                        {
                                            <span>⏳ Subiendo...</span>
                                        }
                                        else
                                        {
                                            <span>📤 Subir imagen</span>
                                        }
                                    </button>
                                </div>
                            </div>

                            <div class="images-grid">
                                @foreach (var (imagen, index) in nuevoProducto.Imagenes.Select((img, i) => (img, i)))
                                {
                                    <div class="image-preview">
                                        <img src="@imagen.Url" alt="Imagen @(index + 1)" />
                                        <div class="image-controls">
                                            <label class="image-principal">
                                                <input type="radio" name="principal" checked="@(imagen.EsPrincipal == 'S')" @onchange="() => MarcarComoPrincipal(index)" />
                                                <span>Principal</span>
                                            </label>
                                            <button type="button" class="btn-remove-image" @onclick="() => EliminarImagen(index)">
                                                ✕
                                            </button>
                                        </div>
                                        <div class="image-order">
                                            <input type="number" class="form-input-xs" @bind="imagen.Orden" min="1" placeholder="Orden" />
                                        </div>
                                    </div>
                                }
                            </div>

                            @if (!nuevoProducto.Imagenes.Any())
                            {
                                <div class="empty-images">
                                    <span>🖼️</span>
                                    <p>No se han agregado imágenes</p>
                                </div>
                            }
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(mensajeErrorModal))
                    {
                        <div class="error-message-modal">
                            <span>⚠️</span>
                            <span>@mensajeErrorModal</span>
                        </div>
                    }

                    <div class="modal-actions">
                        @if (pasoModal > 1)
                        {
                            <button type="button" class="btn-modal-back" @onclick="PasoAnteriorModal">
                                ← Anterior
                            </button>
                        }
                        @if (pasoModal < 3)
                        {
                            <button type="button" class="btn-modal-next" @onclick="PasoSiguienteModal">
                                Siguiente →
                            </button>
                        }
                        else
                        {
                            <button type="submit" class="btn-modal-save" disabled="@guardandoProducto">
                                @if (guardandoProducto)
                                {
                                    <span>Guardando...</span>
                                }
                                else
                                {
                                    <span>💾 Guardar Producto</span>
                                }
                            </button>
                        }
                    </div>
                </form>
            </div>
        </div>
    </div>
}

<!-- 🆕 MODAL EDITAR INFORMACIÓN -->
@if (mostrarModalEditarInfo)
{
    <div class="modal-overlay" @onclick="CerrarModalEditarInfo">
        <div class="modal-content modal-medium" @onclick:stopPropagation>
            <div class="modal-header">
                <h3>Editar Información del Producto</h3>
                <button class="btn-close" @onclick="CerrarModalEditarInfo">✕</button>
            </div>

            <div class="modal-body">
                <form @onsubmit="GuardarInformacion" @onsubmit:preventDefault>
                    <div class="form-section">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Nombre del Producto *</label>
                                <input type="text" class="form-input" @bind="productoEditando.Nombre" required />
                            </div>
                            <div class="form-group">
                                <label class="form-label">Marca *</label>
                                <input type="text" class="form-input" @bind="productoEditando.Marca" required />
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Descripción *</label>
                            <textarea class="form-textarea" rows="3" @bind="productoEditando.Descripcion" required></textarea>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Género *</label>
                                <select class="form-select" @bind="productoEditando.Genero" required>
                                    <option value="">Seleccionar...</option>
                                    <option value="Hombre">Hombre</option>
                                    <option value="Mujer">Mujer</option>
                                    <option value="Unisex">Unisex</option>
                                    <option value="Niño">Niño</option>
                                    <option value="Niña">Niña</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Material</label>
                                <input type="text" class="form-input" @bind="productoEditando.Material" placeholder="Algodón, Poliéster..." />
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Precio Base *</label>
                                <input type="number" class="form-input" @bind="productoEditando.PrecioBase" min="0" step="0.01" required />
                            </div>
                            <div class="form-group">
                                <label class="form-label">Estado</label>
                                <select class="form-select" @bind="productoEditando.Estado">
                                    <option value="A">Activo</option>
                                    <option value="I">Inactivo</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(mensajeErrorModal))
                    {
                        <div class="error-message-modal">
                            <span>⚠️</span>
                            <span>@mensajeErrorModal</span>
                        </div>
                    }

                    <div class="modal-actions">
                        <button type="button" class="btn-modal-back" @onclick="CerrarModalEditarInfo">
                            Cancelar
                        </button>
                        <button type="submit" class="btn-modal-save" disabled="@guardandoProducto">
                            @if (guardandoProducto)
                            {
                                <span>Guardando...</span>
                            }
                            else
                            {
                                <span>💾 Guardar Cambios</span>
                            }
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

<!-- 🆕 MODAL EDITAR VARIANTES -->
@if (mostrarModalEditarVariantes)
{
    <div class="modal-overlay" @onclick="CerrarModalEditarVariantes">
        <div class="modal-content modal-large" @onclick:stopPropagation>
            <div class="modal-header">
                <h3>Editar Variantes del Producto</h3>
                <button class="btn-close" @onclick="CerrarModalEditarVariantes">✕</button>
            </div>

            <div class="modal-body">
                <div class="variantes-header">
                    <h4>Variantes (Talla y Color)</h4>
                    <button type="button" class="btn-add-variant" @onclick="AgregarVarianteEdicion">
                        ➕ Agregar Variante
                    </button>
                </div>

                <div class="variantes-list">
                    @foreach (var (variante, index) in variantesEditando.Select((v, i) => (v, i)))
                    {
                        <div class="variante-item">
                            <div class="variante-number">@(index + 1)</div>
                            <div class="variante-fields">
                                <div class="form-group-inline">
                                    <label>Talla *</label>
                                    <select class="form-select-sm" @bind="variante.Talla" required>
                                        <option value="">Seleccionar...</option>
                                        <option value="XS">XS</option>
                                        <option value="S">S</option>
                                        <option value="M">M</option>
                                        <option value="L">L</option>
                                        <option value="XL">XL</option>
                                        <option value="XXL">XXL</option>
                                    </select>
                                </div>
                                <div class="form-group-inline">
                                    <label>Color *</label>
                                    <input type="text" class="form-input-sm" @bind="variante.Color" placeholder="Rojo, Azul..." required />
                                </div>
                                <div class="form-group-inline">
                                    <label>Stock</label>
                                    <input type="number" class="form-input-sm" @bind="variante.Stock" min="0" />
                                </div>
                                <div class="form-group-inline">
                                    <label>Estado</label>
                                    <select class="form-select-sm" @bind="variante.Estado">
                                        <option value="A">Activo</option>
                                        <option value="I">Inactivo</option>
                                    </select>
                                </div>
                            </div>
                            <button type="button" class="btn-remove-variant" @onclick="() => EliminarVarianteEdicion(index)">
                                🗑️
                            </button>
                        </div>
                    }
                </div>

                @if (!variantesEditando.Any())
                {
                    <div class="empty-variants">
                        <span>📦</span>
                        <p>No hay variantes. Agrega al menos una.</p>
                    </div>
                }

                @if (!string.IsNullOrEmpty(mensajeErrorModal))
                {
                    <div class="error-message-modal">
                        <span>⚠️</span>
                        <span>@mensajeErrorModal</span>
                    </div>
                }

                <div class="modal-actions">
                    <button type="button" class="btn-modal-back" @onclick="CerrarModalEditarVariantes">
                        Cancelar
                    </button>
                    <button type="button" class="btn-modal-save" @onclick="GuardarVariantes" disabled="@guardandoProducto">
                        @if (guardandoProducto)
                        {
                            <span>Guardando...</span>
                        }
                        else
                        {
                            <span>💾 Guardar Variantes</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- 🆕 MODAL EDITAR IMÁGENES -->
@if (mostrarModalEditarImagenes)
{
    <div class="modal-overlay" @onclick="CerrarModalEditarImagenes">
        <div class="modal-content modal-large" @onclick:stopPropagation>
            <div class="modal-header">
                <h3>Editar Imágenes del Producto</h3>
                <button class="btn-close" @onclick="CerrarModalEditarImagenes">✕</button>
            </div>

            <div class="modal-body">
                <div class="form-section">
                    <h4>Imágenes del Producto</h4>

                    <div class="image-upload-area">
                        <div class="upload-box">
                            <span class="upload-icon">📸</span>
                            <p>Sube nuevas imágenes desde tu computadora</p>

                            <label class="btn-upload" style="cursor:pointer; display: inline-block; margin-top: 10px;">
                                Seleccionar Imagen
                                <InputFile OnChange="OnFileSelectedModalEdicion" accept="image/*" style="display:none" />
                            </label>

                            @if (fileEdicion != null)
                            {
                                <p style="margin-top: 10px; color: #059669; font-size: 14px;">
                                    ✓ Imagen seleccionada: <strong>@fileEdicion.Name</strong>
                                </p>
                            }

                            <button type="button"
                                    class="btn-upload"
                                    @onclick="SubirImagenACloudinaryEdicion"
                                    disabled="@(!hayImagenSeleccionadaEdicion || subiendoImagenEdicion)"
                                    style="margin-top: 10px; background-color: #059669;">
                                @if (subiendoImagenEdicion)
                                {
                                    <span>⏳ Subiendo...</span>
                                }
                                else
                                {
                                    <span>📤 Subir imagen</span>
                                }
                            </button>
                        </div>
                    </div>

                    <div class="images-grid">
                        @foreach (var (imagen, index) in imagenesEditando.Select((img, i) => (img, i)))
                        {
                            <div class="image-preview">
                                <img src="@imagen.Url" alt="Imagen @(index + 1)" />
                                <div class="image-controls">
                                    <label class="image-principal">
                                        <input type="radio" name="principalEdit" checked="@(imagen.EsPrincipal == 'S')" @onchange="() => MarcarComoPrincipalEdicion(index)" />
                                        <span>Principal</span>
                                    </label>
                                    <button type="button" class="btn-remove-image" @onclick="() => EliminarImagenEdicion(index)">
                                        ✕
                                    </button>
                                </div>
                                <div class="image-order">
                                    <input type="number" class="form-input-xs" @bind="imagen.Orden" min="1" placeholder="Orden" />
                                </div>
                            </div>
                        }
                    </div>

                    @if (!imagenesEditando.Any())
                    {
                        <div class="empty-images">
                            <span>🖼️</span>
                            <p>No hay imágenes. Agrega al menos una.</p>
                        </div>
                    }
                </div>

                @if (!string.IsNullOrEmpty(mensajeErrorModal))
                {
                    <div class="error-message-modal">
                        <span>⚠️</span>
                        <span>@mensajeErrorModal</span>
                    </div>
                }

                <div class="modal-actions">
                    <button type="button" class="btn-modal-back" @onclick="CerrarModalEditarImagenes">
                        Cancelar
                    </button>
                    <button type="button" class="btn-modal-save" @onclick="GuardarImagenes" disabled="@guardandoProducto">
                        @if (guardandoProducto)
                        {
                            <span>Guardando...</span>
                        }
                        else
                        {
                            <span>💾 Guardar Imágenes</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<style>
    /* Estilos para el menú desplegable */
    .dropdown {
        position: relative;
        display: inline-block;
    }

        .dropdown:hover .dropdown-menu {
            display: block;
        }

    .dropdown-menu {
        display: none;
        position: absolute;
        right: 0;
        background-color: white;
        min-width: 160px;
        box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
        z-index: 1000;
        border-radius: 8px;
        padding: 8px 0;
    }

    .dropdown-item {
        padding: 10px 16px;
        text-align: left;
        background: none;
        border: none;
        width: 100%;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        transition: background-color 0.2s;
    }

        .dropdown-item:hover {
            background-color: #f3f4f6;
        }
</style>

@code {
    // Variables existentes
    private string searchText = "";
    private List<ArticuloListaDTO> products = new();
    private bool mostrarModalFiltros = false;
    private bool mostrarModalConfirmacion = false;
    private bool cargando = true;

    private List<CategoriaTipoDTO> categoriasTipo = new();
    private List<CategoriaOcasionDTO> categoriasOcasion = new();

    private string filtroCategoriaTipo = "";
    private string filtroCategoriaOcasion = "";
    private string filtroGenero = "";
    private string filtroEstado = "";
    private decimal? filtroPrecioMin = null;
    private decimal? filtroPrecioMax = null;

    private int? idProductoAEliminar = null;
    private string nombreProductoAEliminar = "";
    private bool eliminandoProducto = false;

    // 🆕 Variables para CREAR producto
    private bool mostrarModalCrear = false;
    private int pasoModal = 1;
    private ArticuloCreacionDTO nuevoProducto = new();
    private bool guardandoProducto = false;
    private string mensajeErrorModal = "";
    private IBrowserFile? file;
    private bool hayImagenSeleccionada => file != null;
    private bool subiendoImagen = false;

    // 🆕 Variables para EDITAR INFORMACIÓN
    private bool mostrarModalEditarInfo = false;
    private ArticuloActualizacionDTO productoEditando = new();

    // 🆕 Variables para EDITAR VARIANTES
    private bool mostrarModalEditarVariantes = false;
    private int idProductoEditandoVariantes = 0;
    private List<VarianteActualizacionDTO> variantesEditando = new();

    // 🆕 Variables para EDITAR IMÁGENES
    private bool mostrarModalEditarImagenes = false;
    private int idProductoEditandoImagenes = 0;
    private List<ImagenActualizacionDTO> imagenesEditando = new();
    private IBrowserFile? fileEdicion;
    private bool hayImagenSeleccionadaEdicion => fileEdicion != null;
    private bool subiendoImagenEdicion = false;

    protected override async Task OnInitializedAsync()
    {
        await CargarDatosIniciales();
    }

    private async Task CargarDatosIniciales()
    {
        cargando = true;
        await Task.WhenAll(
            CargarProductos(),
            CargarCategorias()
        );
        cargando = false;
    }

    private async Task CargarProductos()
    {
        try
        {
            var resultado = await ArticuloService.ObtenerArticulosActivos();

            if (resultado.IsSuccess && resultado.ListObject != null)
            {
                products = resultado.ListObject.ToList();
            }
            else
            {
                Console.WriteLine($"Error al cargar productos: {resultado.Message}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar productos: {ex.Message}");
        }
    }

    private async Task CargarCategorias()
    {
        try
        {
            var resultadoTipo = await CategoriaService.ObtenerCategoriasTipo();
            var resultadoOcasion = await CategoriaService.ObtenerCategoriasOcasion();

            if (resultadoTipo.IsSuccess && resultadoTipo.ListObject != null)
            {
                categoriasTipo = resultadoTipo.ListObject.ToList();
            }

            if (resultadoOcasion.IsSuccess && resultadoOcasion.ListObject != null)
            {
                categoriasOcasion = resultadoOcasion.ListObject.ToList();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar categorías: {ex.Message}");
        }
    }

    private IEnumerable<ArticuloListaDTO> ProductosFiltrados
    {
        get
        {
            var resultado = products.AsEnumerable();

            if (!string.IsNullOrWhiteSpace(searchText))
            {
                resultado = resultado.Where(p =>
                    p.Nombre.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                    p.CategoriaTipo.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                    p.Marca.Contains(searchText, StringComparison.OrdinalIgnoreCase)
                );
            }

            if (!string.IsNullOrWhiteSpace(filtroCategoriaTipo))
            {
                resultado = resultado.Where(p => p.CategoriaTipo == filtroCategoriaTipo);
            }

            if (!string.IsNullOrWhiteSpace(filtroCategoriaOcasion))
            {
                resultado = resultado.Where(p => p.CategoriaOcasion == filtroCategoriaOcasion);
            }

            if (!string.IsNullOrWhiteSpace(filtroGenero))
            {
                resultado = resultado.Where(p => p.Genero == filtroGenero);
            }

            if (!string.IsNullOrWhiteSpace(filtroEstado))
            {
                resultado = resultado.Where(p => p.Estado == filtroEstado);
            }

            if (filtroPrecioMin.HasValue)
            {
                resultado = resultado.Where(p => p.PrecioBase >= filtroPrecioMin.Value);
            }

            if (filtroPrecioMax.HasValue)
            {
                resultado = resultado.Where(p => p.PrecioBase <= filtroPrecioMax.Value);
            }

            return resultado;
        }
    }

    // ========== MÉTODOS DE FILTROS ==========
    private void AbrirModalFiltros()
    {
        mostrarModalFiltros = true;
    }

    private void CerrarModalFiltros()
    {
        mostrarModalFiltros = false;
    }

    private void AplicarFiltros()
    {
        CerrarModalFiltros();
    }

    private void LimpiarFiltros()
    {
        filtroCategoriaTipo = "";
        filtroCategoriaOcasion = "";
        filtroGenero = "";
        filtroEstado = "";
        filtroPrecioMin = null;
        filtroPrecioMax = null;
    }

    // ========== MÉTODOS PARA CREAR PRODUCTO ==========
    private void AbrirModalNuevoProducto()
    {
        nuevoProducto = new ArticuloCreacionDTO();
        pasoModal = 1;
        mensajeErrorModal = "";
        file = null;
        mostrarModalCrear = true;
    }

    private void CerrarModalCrear()
    {
        mostrarModalCrear = false;
        pasoModal = 1;
        nuevoProducto = new();
        mensajeErrorModal = "";
        file = null;
        subiendoImagen = false;
    }

    private void PasoSiguienteModal()
    {
        mensajeErrorModal = "";

        if (pasoModal == 1)
        {
            if (string.IsNullOrWhiteSpace(nuevoProducto.Nombre) ||
                string.IsNullOrWhiteSpace(nuevoProducto.Marca) ||
                string.IsNullOrWhiteSpace(nuevoProducto.Genero) ||
                nuevoProducto.CategoriaTipoId == 0 ||
                nuevoProducto.CategoriaOcasionId == 0 ||
                nuevoProducto.PrecioBase <= 0)
            {
                mensajeErrorModal = "Por favor completa todos los campos obligatorios (*)";
                return;
            }
        }
        else if (pasoModal == 2)
        {
            if (!nuevoProducto.Variantes.Any())
            {
                mensajeErrorModal = "Debes agregar al menos una variante";
                return;
            }

            var variantesSinTalla = nuevoProducto.Variantes
                .Where(v => string.IsNullOrWhiteSpace(v.Talla))
                .ToList();

            if (variantesSinTalla.Any())
            {
                mensajeErrorModal = "Todas las variantes deben tener una talla seleccionada";
                return;
            }

            var variantesSinColor = nuevoProducto.Variantes
                .Where(v => string.IsNullOrWhiteSpace(v.Color))
                .ToList();

            if (variantesSinColor.Any())
            {
                mensajeErrorModal = "Todas las variantes deben tener un color especificado";
                return;
            }
        }

        pasoModal++;
    }

    private void PasoAnteriorModal()
    {
        mensajeErrorModal = "";
        pasoModal--;
    }

    private void AgregarVariante()
    {
        nuevoProducto.Variantes.Add(new VarianteArticuloDTO
        {
            Talla = "",
            Color = "",
            Stock = 0
        });
    }

    private void EliminarVariante(int index)
    {
        nuevoProducto.Variantes.RemoveAt(index);
    }

    private void OnFileSelectedModal(InputFileChangeEventArgs e)
    {
        file = e.File;
        StateHasChanged();
    }

    private async Task SubirImagenACloudinary()
    {
        if (file == null)
        {
            mensajeErrorModal = "No hay imagen seleccionada";
            return;
        }

        try
        {
            subiendoImagen = true;
            mensajeErrorModal = "";

            if (file.Size > 10 * 1024 * 1024)
            {
                mensajeErrorModal = "La imagen no puede superar los 10MB";
                return;
            }

            using var stream = file.OpenReadStream(10 * 1024 * 1024);

            var uploadParams = new CloudinaryDotNet.Actions.ImageUploadParams
            {
                File = new CloudinaryDotNet.FileDescription(file.Name, stream),
                Folder = "imagenes_productos"
            };

            var result = await cloudinary.UploadAsync(uploadParams);

            if (result.StatusCode == System.Net.HttpStatusCode.OK)
            {
                nuevoProducto.Imagenes.Add(new ImagenArticuloDTO
                {
                    Url = result.SecureUrl.ToString(),
                    Orden = nuevoProducto.Imagenes.Count + 1,
                    EsPrincipal = !nuevoProducto.Imagenes.Any() ? 'S' : 'N'
                });

                file = null;
            }
            else
            {
                mensajeErrorModal = $"Error al subir la imagen: {result.Error?.Message}";
            }
        }
        catch (Exception ex)
        {
            mensajeErrorModal = $"Error al subir imagen: {ex.Message}";
        }
        finally
        {
            subiendoImagen = false;
            StateHasChanged();
        }
    }

    private void EliminarImagen(int index)
    {
        var imagen = nuevoProducto.Imagenes[index];
        nuevoProducto.Imagenes.RemoveAt(index);

        if (imagen.EsPrincipal == 'S' && nuevoProducto.Imagenes.Any())
        {
            nuevoProducto.Imagenes[0].EsPrincipal = 'S';
        }

        for (int i = 0; i < nuevoProducto.Imagenes.Count; i++)
        {
            nuevoProducto.Imagenes[i].Orden = i + 1;
        }
    }

    private void MarcarComoPrincipal(int index)
    {
        foreach (var img in nuevoProducto.Imagenes)
        {
            img.EsPrincipal = 'N';
        }

        nuevoProducto.Imagenes[index].EsPrincipal = 'S';

        var imagenSeleccionada = nuevoProducto.Imagenes[index];
        nuevoProducto.Imagenes.RemoveAt(index);
        nuevoProducto.Imagenes.Insert(0, imagenSeleccionada);

        for (int i = 0; i < nuevoProducto.Imagenes.Count; i++)
        {
            nuevoProducto.Imagenes[i].Orden = i + 1;
        }
    }

    private async Task GuardarProducto()
    {
        mensajeErrorModal = "";

        if (!nuevoProducto.Imagenes.Any())
        {
            mensajeErrorModal = "Debes agregar al menos una imagen";
            return;
        }

        try
        {
            guardandoProducto = true;

            var resultado = await ArticuloService.RegistrarArticuloCompleto(nuevoProducto);

            if (resultado.IsSuccess)
            {
                await CargarProductos();
                CerrarModalCrear();
            }
            else
            {
                mensajeErrorModal = resultado.Message;
            }
        }
        catch (Exception ex)
        {
            mensajeErrorModal = $"Error: {ex.Message}";
        }
        finally
        {
            guardandoProducto = false;
        }
    }

    // ========== 🆕 MÉTODOS PARA EDITAR INFORMACIÓN ==========
    private async Task EditarInformacion(int id)
    {
        try
        {
            cargando = true;
            var resultado = await ArticuloService.ObtenerArticuloPorId(id);

            if (resultado.IsSuccess && resultado.Object != null)
            {
                var detalle = resultado.Object;

                productoEditando = new ArticuloActualizacionDTO
                {
                    IdArticulo = id,
                    Nombre = detalle.Nombre,
                    Descripcion = detalle.Descripcion,
                    Marca = detalle.Marca,
                    Genero = detalle.Genero,
                    Material = detalle.Material,
                    PrecioBase = detalle.PrecioBase,
                    Estado = detalle.Estado[0]
                };

                mensajeErrorModal = "";
                mostrarModalEditarInfo = true;
            }
            else
            {
                Console.WriteLine($"Error al cargar producto: {resultado.Message}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
        finally
        {
            cargando = false;
        }
    }

    private void CerrarModalEditarInfo()
    {
        mostrarModalEditarInfo = false;
        productoEditando = new();
        mensajeErrorModal = "";
    }

    private async Task GuardarInformacion()
    {
        mensajeErrorModal = "";

        try
        {
            guardandoProducto = true;

            var resultado = await ArticuloService.ActualizarArticulo(productoEditando);

            if (resultado.IsSuccess)
            {
                await CargarProductos();
                CerrarModalEditarInfo();
            }
            else
            {
                mensajeErrorModal = resultado.Message;
            }
        }
        catch (Exception ex)
        {
            mensajeErrorModal = $"Error: {ex.Message}";
        }
        finally
        {
            guardandoProducto = false;
        }
    }

    // ========== 🆕 MÉTODOS PARA EDITAR VARIANTES ==========
    private async Task EditarVariantes(int id)
    {
        try
        {
            cargando = true;
            var resultado = await ArticuloService.ObtenerArticuloPorId(id);

            if (resultado.IsSuccess && resultado.Object != null)
            {
                var detalle = resultado.Object;
                idProductoEditandoVariantes = id;

                variantesEditando = detalle.Variantes.Select(v => new VarianteActualizacionDTO
                {
                    IdVariante = v.IdVariante,
                    Talla = v.Talla,
                    Color = v.Color,
                    Stock = v.Stock,
                    Estado = v.Estado[0]
                }).ToList();

                mensajeErrorModal = "";
                mostrarModalEditarVariantes = true;
            }
            else
            {
                Console.WriteLine($"Error al cargar producto: {resultado.Message}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
        finally
        {
            cargando = false;
        }
    }

    private void CerrarModalEditarVariantes()
    {
        mostrarModalEditarVariantes = false;
        variantesEditando = new();
        idProductoEditandoVariantes = 0;
        mensajeErrorModal = "";
    }

    private void AgregarVarianteEdicion()
    {
        variantesEditando.Add(new VarianteActualizacionDTO
        {
            IdVariante = null,
            Talla = "",
            Color = "",
            Stock = 0,
            Estado = 'A'
        });
    }

    private async void EliminarVarianteEdicion(int index)
    {
        var variante = variantesEditando[index];

        // Si la variante tiene ID, significa que existe en BD y debe eliminarse
        if (variante.IdVariante.HasValue && variante.IdVariante.Value > 0)
        {
            try
            {
                var resultado = await ArticuloService.EliminarVariante(variante.IdVariante.Value);

                if (resultado.IsSuccess)
                {
                    variantesEditando.RemoveAt(index);
                    StateHasChanged();
                }
                else
                {
                    mensajeErrorModal = resultado.Message;
                }
            }
            catch (Exception ex)
            {
                mensajeErrorModal = $"Error al eliminar variante: {ex.Message}";
            }
        }
        else
        {
            // Si no tiene ID, solo la removemos de la lista (aún no está en BD)
            variantesEditando.RemoveAt(index);
        }
    }

    private async Task GuardarVariantes()
    {
        mensajeErrorModal = "";

        if (!variantesEditando.Any())
        {
            mensajeErrorModal = "Debe haber al menos una variante";
            return;
        }

        var variantesSinDatos = variantesEditando
            .Where(v => string.IsNullOrWhiteSpace(v.Talla) || string.IsNullOrWhiteSpace(v.Color))
            .ToList();

        if (variantesSinDatos.Any())
        {
            mensajeErrorModal = "Todas las variantes deben tener talla y color";
            return;
        }

        try
        {
            guardandoProducto = true;

            // 🔥 AQUÍ ESTÁ LO QUE FALTABA - Procesar variantes
            foreach (var variante in variantesEditando)
            {
                Response<bool> resultado;

                if (variante.IdVariante.HasValue && variante.IdVariante.Value > 0)
                {
                    // Si tiene ID, es una variante existente - ACTUALIZAR
                    resultado = await ArticuloService.ActualizarVariante(variante);
                }
                else
                {
                    // Si no tiene ID, es una variante nueva - necesitarías un método RegistrarVariante
                    // Por ahora, mostraremos un mensaje
                    mensajeErrorModal = "No se puede agregar nuevas variantes desde esta pantalla. Use el formulario de creación.";
                    return;
                }

                if (!resultado.IsSuccess)
                {
                    mensajeErrorModal = resultado.Message;
                    return;
                }
            }

            // Si todo salió bien, recargar productos y cerrar modal
            await CargarProductos();
            CerrarModalEditarVariantes();
        }
        catch (Exception ex)
        {
            mensajeErrorModal = $"Error: {ex.Message}";
        }
        finally
        {
            guardandoProducto = false;
        }
    }

    // ========== 🆕 MÉTODOS PARA EDITAR IMÁGENES ==========
    private async Task EditarImagenes(int id)
    {
        try
        {
            cargando = true;
            var resultado = await ArticuloService.ObtenerArticuloPorId(id);

            if (resultado.IsSuccess && resultado.Object != null)
            {
                var detalle = resultado.Object;
                idProductoEditandoImagenes = id;

                imagenesEditando = detalle.Imagenes.Select(img => new ImagenActualizacionDTO
                {
                    IdImagen = img.Id,
                    Url = img.Url,
                    Orden = img.Orden,
                    EsPrincipal = img.EsPrincipal
                }).ToList();

                mensajeErrorModal = "";
                fileEdicion = null;
                mostrarModalEditarImagenes = true;
            }
            else
            {
                Console.WriteLine($"Error al cargar producto: {resultado.Message}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
        finally
        {
            cargando = false;
        }
    }

    private void CerrarModalEditarImagenes()
    {
        mostrarModalEditarImagenes = false;
        imagenesEditando = new();
        idProductoEditandoImagenes = 0;
        mensajeErrorModal = "";
        fileEdicion = null;
    }

    private void OnFileSelectedModalEdicion(InputFileChangeEventArgs e)
    {
        fileEdicion = e.File;
        StateHasChanged();
    }

    private async Task SubirImagenACloudinaryEdicion()
    {
        if (fileEdicion == null)
        {
            mensajeErrorModal = "No hay imagen seleccionada";
            return;
        }

        try
        {
            subiendoImagenEdicion = true;
            mensajeErrorModal = "";

            if (fileEdicion.Size > 10 * 1024 * 1024)
            {
                mensajeErrorModal = "La imagen no puede superar los 10MB";
                return;
            }

            using var stream = fileEdicion.OpenReadStream(10 * 1024 * 1024);

            var uploadParams = new CloudinaryDotNet.Actions.ImageUploadParams
            {
                File = new CloudinaryDotNet.FileDescription(fileEdicion.Name, stream),
                Folder = "imagenes_productos"
            };

            var result = await cloudinary.UploadAsync(uploadParams);

            if (result.StatusCode == System.Net.HttpStatusCode.OK)
            {
                imagenesEditando.Add(new ImagenActualizacionDTO
                {
                    IdImagen = null,
                    Url = result.SecureUrl.ToString(),
                    Orden = imagenesEditando.Count + 1,
                    EsPrincipal = !imagenesEditando.Any() ? 'S' : 'N'
                });

                fileEdicion = null;
            }
            else
            {
                mensajeErrorModal = $"Error al subir la imagen: {result.Error?.Message}";
            }
        }
        catch (Exception ex)
        {
            mensajeErrorModal = $"Error al subir imagen: {ex.Message}";
        }
        finally
        {
            subiendoImagenEdicion = false;
            StateHasChanged();
        }
    }

    private async void EliminarImagenEdicion(int index)
    {
        var imagen = imagenesEditando[index];

        // Si la imagen tiene ID, significa que existe en BD y debe eliminarse
        if (imagen.IdImagen.HasValue && imagen.IdImagen.Value > 0)
        {
            try
            {
                var resultado = await ArticuloService.EliminarImagen(imagen.IdImagen.Value);

                if (resultado.IsSuccess)
                {
                    imagenesEditando.RemoveAt(index);

                    // Si era la principal y quedan más imágenes, marcar la primera como principal
                    if (imagen.EsPrincipal == 'S' && imagenesEditando.Any())
                    {
                        imagenesEditando[0].EsPrincipal = 'S';
                    }

                    // Reordenar
                    for (int i = 0; i < imagenesEditando.Count; i++)
                    {
                        imagenesEditando[i].Orden = i + 1;
                    }

                    StateHasChanged();
                }
                else
                {
                    mensajeErrorModal = resultado.Message;
                }
            }
            catch (Exception ex)
            {
                mensajeErrorModal = $"Error al eliminar imagen: {ex.Message}";
            }
        }
        else
        {
            // Si no tiene ID, solo la removemos de la lista (aún no está en BD)
            imagenesEditando.RemoveAt(index);

            if (imagen.EsPrincipal == 'S' && imagenesEditando.Any())
            {
                imagenesEditando[0].EsPrincipal = 'S';
            }

            for (int i = 0; i < imagenesEditando.Count; i++)
            {
                imagenesEditando[i].Orden = i + 1;
            }
        }
    }

    private void MarcarComoPrincipalEdicion(int index)
    {
        foreach (var img in imagenesEditando)
        {
            img.EsPrincipal = 'N';
        }

        imagenesEditando[index].EsPrincipal = 'S';

        var imagenSeleccionada = imagenesEditando[index];
        imagenesEditando.RemoveAt(index);
        imagenesEditando.Insert(0, imagenSeleccionada);

        for (int i = 0; i < imagenesEditando.Count; i++)
        {
            imagenesEditando[i].Orden = i + 1;
        }
    }

    private async Task GuardarImagenes()
    {
        mensajeErrorModal = "";

        if (!imagenesEditando.Any())
        {
            mensajeErrorModal = "Debe haber al menos una imagen";
            return;
        }

        if (!imagenesEditando.Any(img => img.EsPrincipal == 'S'))
        {
            mensajeErrorModal = "Debe marcar al menos una imagen como principal";
            return;
        }

        try
        {
            guardandoProducto = true;

            // 🔥 AQUÍ ESTÁ LO QUE FALTABA - Procesar imágenes
            foreach (var imagen in imagenesEditando)
            {
                Response<bool> resultado;

                if (imagen.IdImagen.HasValue && imagen.IdImagen.Value > 0)
                {
                    // Si tiene ID, es una imagen existente - ACTUALIZAR
                    resultado = await ArticuloService.ActualizarImagen(imagen);
                }
                else
                {
                    // Si no tiene ID, es una imagen nueva - necesitarías un método RegistrarImagen
                    // Por ahora, mostraremos un mensaje
                    mensajeErrorModal = "No se puede agregar nuevas imágenes desde esta pantalla. Use el formulario de creación.";
                    return;
                }

                if (!resultado.IsSuccess)
                {
                    mensajeErrorModal = resultado.Message;
                    return;
                }
            }

            // Si hay una imagen marcada como principal, establecerla
            var imagenPrincipal = imagenesEditando.FirstOrDefault(img => img.EsPrincipal == 'S');
            if (imagenPrincipal != null && imagenPrincipal.IdImagen.HasValue)
            {
                var resultadoPrincipal = await ArticuloService.EstablecerImagenPrincipal(
                    idProductoEditandoImagenes,
                    imagenPrincipal.IdImagen.Value
                );

                if (!resultadoPrincipal.IsSuccess)
                {
                    mensajeErrorModal = resultadoPrincipal.Message;
                    return;
                }
            }

            // Si todo salió bien, recargar productos y cerrar modal
            await CargarProductos();
            CerrarModalEditarImagenes();
        }
        catch (Exception ex)
        {
            mensajeErrorModal = $"Error: {ex.Message}";
        }
        finally
        {
            guardandoProducto = false;
        }
    }

    // ========== MÉTODOS PARA ELIMINAR ==========
    private void ConfirmarEliminarProducto(int id, string nombre)
    {
        idProductoAEliminar = id;
        nombreProductoAEliminar = nombre;
        mostrarModalConfirmacion = true;
    }

    private void CerrarModalConfirmacion()
    {
        mostrarModalConfirmacion = false;
        idProductoAEliminar = null;
        nombreProductoAEliminar = "";
    }

    private async Task EliminarProductoConfirmado()
    {
        if (!idProductoAEliminar.HasValue) return;

        try
        {
            eliminandoProducto = true;
            var resultado = await ArticuloService.EliminarArticulo(idProductoAEliminar.Value);

            if (resultado.IsSuccess)
            {
                await CargarProductos();
                CerrarModalConfirmacion();
            }
            else
            {
                Console.WriteLine($"Error al eliminar: {resultado.Message}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
        finally
        {
            eliminandoProducto = false;
        }
    }

    // ========== MÉTODOS AUXILIARES ==========
    private string GetVariantesClass(int total)
    {
        return total > 0 ? "stock-normal" : "stock-low";
    }

    private string GetStatusBadgeClass(string estado)
    {
        return estado == "A" ? "badge-active" : "badge-out";
    }

    private string GetStatusText(string estado)
    {
        return estado == "A" ? "Activo" : "Inactivo";
    }
}
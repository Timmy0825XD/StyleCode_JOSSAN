@page "/AdminProductos"
@using ENTITY.Articulos
@using BLL.Interfaces
@inject IArticuloServices ArticuloService
@inject ICategoriaServices CategoriaService

<div class="container">
    <div class="page-header">
        <h2 style="font-size: 28px; font-weight: 700;"> Gestión de Productos </h2>
        <button class="btn-primary" @onclick="AbrirModalNuevoProducto">
            <span>➕</span>
            Nuevo Producto
        </button>
    </div>

    <div class="products-card">
        <div class="toolbar">
            <div class="search-container">
                <span style="position: absolute;">🔍</span>
                <input type="text"
                       placeholder="Buscar productos..."
                       class="search-input"
                       @bind="searchText"
                       @bind:event="oninput" />
            </div>
            <button class="btn-secondary">
                <span>🔽</span>
                Filtros
            </button>
            <button class="btn-secondary" @onclick="ExportarProductos">
                <span>📥</span>
                Exportar
            </button>
        </div>

        @if (cargando)
        {
            <div class="empty-state">
                <span class="empty-icon">⏳</span>
                <p>Cargando productos...</p>
            </div>
        }
        else
        {
            <div class="table-container">
                <table class="products-table">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Categoría</th>
                            <th>Precio</th>
                            <th>Variantes</th>
                            <th>Marca</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var product in ProductosFiltrados)
                        {
                            <tr>
                                <td class="product-name">
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        @if (!string.IsNullOrEmpty(product.ImagenPrincipal))
                                        {
                                            <img src="@product.ImagenPrincipal" alt="@product.Nombre" style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px;" />
                                        }
                                        <span>@product.Nombre</span>
                                    </div>
                                </td>
                                <td class="product-category">
                                    <div>
                                        <span style="display: block; font-weight: 600;">@product.CategoriaTipo</span>
                                        <span style="font-size: 12px; color: #6b7280;">@product.CategoriaOcasion</span>
                                    </div>
                                </td>
                                <td class="product-price">$@product.PrecioBase.ToString("F2")</td>
                                <td>
                                    <span class="@GetVariantesClass(product.TotalVariantes)">
                                        @product.TotalVariantes
                                    </span>
                                </td>
                                <td class="product-sales">@product.Marca</td>
                                <td>
                                    <span class="badge @GetStatusBadgeClass(product.Estado)">
                                        @GetStatusText(product.Estado)
                                    </span>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn-action btn-view" @onclick="() => VerProducto(product.IdArticulo)" title="Ver">
                                            <span>👁️</span>
                                        </button>
                                        <button class="btn-action btn-edit" @onclick="() => EditarProducto(product.IdArticulo)" title="Editar">
                                            <span>✏️</span>
                                        </button>
                                        <button class="btn-action btn-delete" @onclick="() => EliminarProducto(product.IdArticulo)" title="Eliminar">
                                            <span>🗑️</span>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>

                @if (!ProductosFiltrados.Any())
                {
                    <div class="empty-state">
                        <span class="empty-icon">📦</span>
                        <p>No se encontraron productos</p>
                    </div>
                }
            </div>
        }
    </div>
</div>

@if (mostrarModal)
{
    <div class="modal-overlay" @onclick="CerrarModal">
        <div class="modal-content modal-large" @onclick:stopPropagation>
            <div class="modal-header">
                <h3>@(productoEditando != null ? "Editar Producto" : "Nuevo Producto")</h3>
                <button class="btn-close" @onclick="CerrarModal">✕</button>
            </div>

            <div class="modal-body">

                <div class="modal-steps">
                    <div class="step @(pasoModal == 1 ? "active" : pasoModal > 1 ? "completed" : "")">
                        <div class="step-number">1</div>
                        <span>Información</span>
                    </div>
                    <div class="step-line @(pasoModal > 1 ? "completed" : "")"></div>
                    <div class="step @(pasoModal == 2 ? "active" : pasoModal > 2 ? "completed" : "")">
                        <div class="step-number">2</div>
                        <span>Variantes</span>
                    </div>
                    <div class="step-line @(pasoModal > 2 ? "completed" : "")"></div>
                    <div class="step @(pasoModal == 3 ? "active" : "")">
                        <div class="step-number">3</div>
                        <span>Imágenes</span>
                    </div>
                </div>

                <form @onsubmit="GuardarProducto" @onsubmit:preventDefault>

                    @if (pasoModal == 1)
                    {
                        <div class="form-section">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Nombre del Producto *</label>
                                    <input type="text" class="form-input" @bind="nuevoProducto.Nombre" required />
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Marca *</label>
                                    <input type="text" class="form-input" @bind="nuevoProducto.Marca" required />
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Descripción *</label>
                                <textarea class="form-textarea" rows="3" @bind="nuevoProducto.Descripcion" required></textarea>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Categoría Tipo *</label>
                                    <select class="form-select" @bind="nuevoProducto.CategoriaTipoId" required>
                                        <option value="0">Seleccionar...</option>
                                        @foreach (var cat in categoriasTipo)
                                        {
                                            <option value="@cat.Id">@cat.Nombre</option>
                                        }
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Categoría Ocasión *</label>
                                    <select class="form-select" @bind="nuevoProducto.CategoriaOcasionId" required>
                                        <option value="0">Seleccionar...</option>
                                        @foreach (var cat in categoriasOcasion)
                                        {
                                            <option value="@cat.Id">@cat.Nombre</option>
                                        }
                                    </select>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Género *</label>
                                    <select class="form-select" @bind="nuevoProducto.Genero" required>
                                        <option value="">Seleccionar...</option>
                                        <option value="Hombre">Hombre</option>
                                        <option value="Mujer">Mujer</option>
                                        <option value="Unisex">Unisex</option>
                                        <option value="Niño">Niño</option>
                                        <option value="Niña">Niña</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Material</label>
                                    <input type="text" class="form-input" @bind="nuevoProducto.Material" placeholder="Algodón, Poliéster..." />
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Precio Base *</label>
                                    <input type="number" class="form-input" @bind="nuevoProducto.PrecioBase" min="0" step="0.01" required />
                                </div>
                            </div>
                        </div>
                    }

                    @if (pasoModal == 2)
                    {
                        <div class="form-section">
                            <div class="variantes-header">
                                <h4>Configurar Variantes (Talla y Color)</h4>
                                <button type="button" class="btn-add-variant" @onclick="AgregarVariante">
                                    ➕ Agregar Variante
                                </button>
                            </div>

                            <div class="variantes-list">
                                @foreach (var (variante, index) in nuevoProducto.Variantes.Select((v, i) => (v, i)))
                                {
                                    <div class="variante-item">
                                        <div class="variante-number">@(index + 1)</div>
                                        <div class="variante-fields">
                                            <div class="form-group-inline">
                                                <label>Talla *</label>
                                                <select class="form-select-sm" @bind="variante.Talla" required>
                                                    <option value="">Seleccionar...</option>
                                                    <option value="XS">XS</option>
                                                    <option value="S">S</option>
                                                    <option value="M">M</option>
                                                    <option value="L">L</option>
                                                    <option value="XL">XL</option>
                                                    <option value="XXL">XXL</option>
                                                </select>
                                            </div>
                                            <div class="form-group-inline">
                                                <label>Color</label>
                                                <input type="text" class="form-input-sm" @bind="variante.Color" placeholder="Rojo, Azul..." />
                                            </div>
                                            <div class="form-group-inline">
                                                <label>Stock</label>
                                                <input type="number" class="form-input-sm" @bind="variante.Stock" min="0" />
                                            </div>
                                        </div>
                                        <button type="button" class="btn-remove-variant" @onclick="() => EliminarVariante(index)">
                                            🗑️
                                        </button>
                                    </div>
                                }
                            </div>

                            @if (!nuevoProducto.Variantes.Any())
                            {
                                <div class="empty-variants">
                                    <span>📦</span>
                                    <p>No hay variantes. Agrega al menos una.</p>
                                </div>
                            }
                        </div>
                    }

                    @if (pasoModal == 3)
                    {
                        <div class="form-section">
                            <h4>Imágenes del Producto</h4>

                            <div class="image-upload-area">
                                <div class="upload-box">
                                    <span class="upload-icon">📸</span>
                                    <p>Arrastra imágenes aquí o haz clic para seleccionar</p>
                                    <button type="button" class="btn-upload" @onclick="SeleccionarImagenes">
                                        Seleccionar Imágenes
                                    </button>
                                </div>
                            </div>

                            <div class="images-grid">
                                @foreach (var (imagen, index) in nuevoProducto.Imagenes.Select((img, i) => (img, i)))
                                {
                                    <div class="image-preview">
                                        <img src="@imagen.Url" alt="Imagen @(index + 1)" />
                                        <div class="image-controls">
                                            <label class="image-principal">
                                                <input type="radio" name="principal" checked="@(imagen.EsPrincipal == 'S')" @onchange="() => MarcarComoPrincipal(index)" />
                                                <span>Principal</span>
                                            </label>
                                            <button type="button" class="btn-remove-image" @onclick="() => EliminarImagen(index)">
                                                ✕
                                            </button>
                                        </div>
                                        <div class="image-order">
                                            <input type="number" class="form-input-xs" @bind="imagen.Orden" min="1" placeholder="Orden" />
                                        </div>
                                    </div>
                                }
                            </div>

                            @if (!nuevoProducto.Imagenes.Any())
                            {
                                <div class="empty-images">
                                    <span>🖼️</span>
                                    <p>No se han agregado imágenes</p>
                                </div>
                            }
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(mensajeErrorModal))
                    {
                        <div class="error-message-modal">
                            <span>⚠️</span>
                            <span>@mensajeErrorModal</span>
                        </div>
                    }

                    <div class="modal-actions">
                        @if (pasoModal > 1)
                        {
                            <button type="button" class="btn-modal-back" @onclick="PasoAnteriorModal">
                                ← Anterior
                            </button>
                        }
                        @if (pasoModal < 3)
                        {
                            <button type="button" class="btn-modal-next" @onclick="PasoSiguienteModal">
                                Siguiente →
                            </button>
                        }
                        else
                        {
                            <button type="submit" class="btn-modal-save" disabled="@guardandoProducto">
                                @if (guardandoProducto)
                                {
                                    <span>Guardando...</span>
                                }
                                else
                                {
                                    <span>💾 Guardar Producto</span>
                                }
                            </button>
                        }
                    </div>
                </form>
            </div>
        </div>
    </div>
}

@code {
    // State
    private string searchText = "";
    private List<ArticuloListaDTO> products = new();
    private bool mostrarModal = false;
    private int pasoModal = 1;
    private ArticuloCreacionDTO nuevoProducto = new();
    private ArticuloListaDTO? productoEditando = null;
    private bool guardandoProducto = false;
    private string mensajeErrorModal = "";
    private bool cargando = true;

    private List<CategoriaTipoDTO> categoriasTipo = new();
    private List<CategoriaOcasionDTO> categoriasOcasion = new();

    protected override async Task OnInitializedAsync()
    {
        await CargarDatosIniciales();
    }

    private async Task CargarDatosIniciales()
    {
        cargando = true;
        await Task.WhenAll(
            CargarProductos(),
            CargarCategorias()
        );
        cargando = false;
    }

    private async Task CargarProductos()
    {
        try
        {
            var resultado = await ArticuloService.ObtenerArticulosActivos();

            if (resultado.IsSuccess && resultado.ListObject != null)
            {
                products = resultado.ListObject.ToList();
            }
            else
            {
                Console.WriteLine($"Error al cargar productos: {resultado.Message}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar productos: {ex.Message}");
        }
    }

    private async Task CargarCategorias()
    {
        try
        {
            var resultadoTipo = await CategoriaService.ObtenerCategoriasTipo();
            var resultadoOcasion = await CategoriaService.ObtenerCategoriasOcasion();

            if (resultadoTipo.IsSuccess && resultadoTipo.ListObject != null)
            {
                categoriasTipo = resultadoTipo.ListObject.ToList();
            }

            if (resultadoOcasion.IsSuccess && resultadoOcasion.ListObject != null)
            {
                categoriasOcasion = resultadoOcasion.ListObject.ToList();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar categorías: {ex.Message}");
        }
    }

    private IEnumerable<ArticuloListaDTO> ProductosFiltrados
    {
        get
        {
            if (string.IsNullOrWhiteSpace(searchText))
                return products;

            return products.Where(p =>
                p.Nombre.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                p.CategoriaTipo.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                p.Marca.Contains(searchText, StringComparison.OrdinalIgnoreCase)
            );
        }
    }

    // Modal Methods
    private void AbrirModalNuevoProducto()
    {
        nuevoProducto = new ArticuloCreacionDTO();
        productoEditando = null;
        pasoModal = 1;
        mensajeErrorModal = "";
        mostrarModal = true;
    }

    private void CerrarModal()
    {
        mostrarModal = false;
        pasoModal = 1;
        nuevoProducto = new();
        mensajeErrorModal = "";
    }

    private void PasoSiguienteModal()
    {
        mensajeErrorModal = "";

        if (pasoModal == 1)
        {
            if (string.IsNullOrWhiteSpace(nuevoProducto.Nombre) ||
                string.IsNullOrWhiteSpace(nuevoProducto.Marca) ||
                string.IsNullOrWhiteSpace(nuevoProducto.Genero) ||
                nuevoProducto.CategoriaTipoId == 0 ||
                nuevoProducto.CategoriaOcasionId == 0 ||
                nuevoProducto.PrecioBase <= 0)
            {
                mensajeErrorModal = "Por favor completa todos los campos obligatorios (*)";
                return;
            }
        }
        else if (pasoModal == 2)
        {
            if (!nuevoProducto.Variantes.Any())
            {
                mensajeErrorModal = "Debes agregar al menos una variante";
                return;
            }

            var variantesSinTalla = nuevoProducto.Variantes
                .Where(v => string.IsNullOrWhiteSpace(v.Talla))
                .ToList();

            if (variantesSinTalla.Any())
            {
                mensajeErrorModal = "❌ Todas las variantes deben tener una talla seleccionada";
                return;
            }

            var variantesSinColor = nuevoProducto.Variantes
                .Where(v => string.IsNullOrWhiteSpace(v.Color))
                .ToList();

            if (variantesSinColor.Any())
            {
                mensajeErrorModal = "❌ Todas las variantes deben tener un color especificado";
                return;
            }

            var duplicados = nuevoProducto.Variantes
                .GroupBy(v => new { v.Talla, v.Color })
                .Where(g => g.Count() > 1)
                .ToList();

            if (duplicados.Any())
            {
                mensajeErrorModal = "❌ Hay variantes duplicadas. Cada combinación talla-color debe ser única";
                return;
            }
        }

        pasoModal++;
    }

    private void PasoAnteriorModal()
    {
        mensajeErrorModal = "";
        pasoModal--;
    }

    private void AgregarVariante()
    {
        nuevoProducto.Variantes.Add(new VarianteArticuloDTO
        {
            Talla = "", 
            Color = "",
            Stock = 0
        });
    }

    private void EliminarVariante(int index)
    {
        nuevoProducto.Variantes.RemoveAt(index);
    }

    private void SeleccionarImagenes()
    {
        var urlsSimuladas = new[] {
        "https://via.placeholder.com/300x400/a855f7/ffffff?text=Producto+1",
        "https://via.placeholder.com/300x400/ec4899/ffffff?text=Producto+2"
    };

        foreach (var url in urlsSimuladas)
        {
            nuevoProducto.Imagenes.Add(new ImagenArticuloDTO
            {
                Url = url,
                Orden = nuevoProducto.Imagenes.Count + 1, // ✅ 1, 2, 3, ...
                EsPrincipal = !nuevoProducto.Imagenes.Any() ? 'S' : 'N' // Primera es 'S'
            });
        }
    }

    private void EliminarImagen(int index)
    {
        var imagen = nuevoProducto.Imagenes[index];
        nuevoProducto.Imagenes.RemoveAt(index);

        if (imagen.EsPrincipal == 'S' && nuevoProducto.Imagenes.Any())
        {
            nuevoProducto.Imagenes[0].EsPrincipal = 'S';
        }
    }

    private void MarcarComoPrincipal(int index)
    {
        // ✅ La imagen seleccionada se convierte en orden 1
        var imagenSeleccionada = nuevoProducto.Imagenes[index];

        // Remover la imagen de su posición actual
        nuevoProducto.Imagenes.RemoveAt(index);

        // Insertarla al inicio
        nuevoProducto.Imagenes.Insert(0, imagenSeleccionada);

        // Reordenar todas las imágenes
        for (int i = 0; i < nuevoProducto.Imagenes.Count; i++)
        {
            nuevoProducto.Imagenes[i].Orden = i + 1;
            nuevoProducto.Imagenes[i].EsPrincipal = (i == 0) ? 'S' : 'N';
        }
    }

    private async Task GuardarProducto()
    {
        mensajeErrorModal = "";

        if (!nuevoProducto.Imagenes.Any())
        {
            mensajeErrorModal = "Debes agregar al menos una imagen";
            return;
        }

        try
        {
            guardandoProducto = true;
            
            var resultado = await ArticuloService.RegistrarArticuloCompleto(nuevoProducto);

            if (resultado.IsSuccess)
            {
                Console.WriteLine($"Producto guardado con ID: {resultado.Object}");
                await CargarProductos();
                CerrarModal();
            }
            else
            {
                mensajeErrorModal = resultado.Message;
            }
        }
        catch (Exception ex)
        {
            mensajeErrorModal = $"Error: {ex.Message}";
        }
        finally
        {
            guardandoProducto = false;
        }
    }

    // Product Actions
    private async Task VerProducto(int id)
    {
        Console.WriteLine($"Ver producto: {id}");
        // Aquí podrías abrir un modal de detalle
    }

    private void EditarProducto(int id)
    {
        Console.WriteLine($"Editar producto: {id}");
        // Cargar producto y abrir modal
    }

    private async Task EliminarProducto(int id)
    {
        try
        {
            var resultado = await ArticuloService.EliminarArticulo(id);

            if (resultado.IsSuccess)
            {
                await CargarProductos();
            }
            else
            {
                Console.WriteLine($"Error al eliminar: {resultado.Message}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
    }

    private void ExportarProductos()
    {
        Console.WriteLine("Exportar productos");
    }

    private string GetVariantesClass(int total)
    {
        return total > 0 ? "stock-normal" : "stock-low";
    }

    private string GetStatusBadgeClass(string estado)
    {
        return estado == "A" ? "badge-active" : "badge-out";
    }

    private string GetStatusText(string estado)
    {
        return estado == "A" ? "Activo" : "Inactivo";
    }
}